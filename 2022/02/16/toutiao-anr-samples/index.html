

<!DOCTYPE html>
<html lang="zh-CN" >



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/image/favicon.png">
  <link rel="icon" href="/image/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#141414">
  <meta name="author" content="Cyrus">
  <meta name="keywords" content="">
  
    <meta name="description" content="简述：在前文，我们用了较多的篇幅介绍了 ANR 设计原理及影响因素，并根据不同场景进行了分类，如：当前消息严重耗时，历史消息耗时严重，业务异常密集执行，进程内资源抢占，进程间资源抢占等场景。为了应对系统监控能力不足以及应用侧获取信息受限的情况，我们在应用侧实现了一套 消息调度监控工具，重点监控主线程的“过去，现在和将来”，同时结合相关日志对 ANR 问题的分析思路进行了总结。 为了便于大家更好的理">
<meta property="og:type" content="article">
<meta property="og:title" content="【转】今日头条 ANR 优化实践系列（3）- 实例剖析集锦">
<meta property="og:url" content="https://www.dalvik.work/2022/02/16/toutiao-anr-samples/index.html">
<meta property="og:site_name" content="Cyrus Blog">
<meta property="og:description" content="简述：在前文，我们用了较多的篇幅介绍了 ANR 设计原理及影响因素，并根据不同场景进行了分类，如：当前消息严重耗时，历史消息耗时严重，业务异常密集执行，进程内资源抢占，进程间资源抢占等场景。为了应对系统监控能力不足以及应用侧获取信息受限的情况，我们在应用侧实现了一套 消息调度监控工具，重点监控主线程的“过去，现在和将来”，同时结合相关日志对 ANR 问题的分析思路进行了总结。 为了便于大家更好的理">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/1.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/2.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/3.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/4.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/5.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/6.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/7.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/8.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/9.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/10.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/11.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/12.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/13.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/14.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/15.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/16.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/17.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/18.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/19.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/20.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/21.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/22.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/23.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/24.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/25.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/26.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/27.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/28.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/29.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/30.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/31.webp">
<meta property="og:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/32.webp">
<meta property="article:published_time" content="2022-02-16T06:00:00.000Z">
<meta property="article:modified_time" content="2023-03-27T08:59:59.386Z">
<meta property="article:author" content="Cyrus">
<meta property="article:tag" content="ANR">
<meta property="article:tag" content="bytedance">
<meta property="article:tag" content="toutiao">
<meta property="article:tag" content="字节">
<meta property="article:tag" content="头条">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://www.dalvik.work/image/2022-02-16-toutiao-anr-samples/1.webp">
  
  
  
  <title>【转】今日头条 ANR 优化实践系列（3）- 实例剖析集锦 - Cyrus Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  



  
<link rel="stylesheet" href="/css/custom.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"www.dalvik.work","root":"/","version":"1.9.4","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#91cb3e","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":99},"lazyload":{"enable":true,"loading_img":"/image/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":"7d0c9146781b5fb9ae68cfc826d0be54","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 30vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Cyrus Land</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/image/sunset_sea.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">【转】今日头条 ANR 优化实践系列（3）- 实例剖析集锦</span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-02-16 06:00" pubdate>
          2022年2月16日
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          10k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          87 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">【转】今日头条 ANR 优化实践系列（3）- 实例剖析集锦</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="简述："><a href="#简述：" class="headerlink" title="简述："></a>简述：</h1><p>在前文，我们用了较多的篇幅介绍了 <a href="../../../../2022/02/16/toutiao-anr-principle/">ANR 设计原理及影响因素</a>，并根据不同场景进行了分类，如：当前消息严重耗时，历史消息耗时严重，业务异常密集执行，进程内资源抢占，进程间资源抢占等场景。为了应对系统监控能力不足以及应用侧获取信息受限的情况，我们在应用侧实现了一套 <a href="../../../../2022/02/16/toutiao-anr-tools/">消息调度监控工具</a>，重点监控主线程的“过去，现在和将来”，同时结合相关日志对 ANR 问题的分析思路进行了总结。</p>
<p>为了便于大家更好的理解上述知识，接下来我们将结合工作中遇到的一些比较有代表性的问题，并按照前文归因分类，由浅入深进行实例解剖，下面就来看看这几类问题，我们是如何借助系统日志和监控工具进行分析及定位的。</p>
<h1 id="案例一：当前业务耗时严重"><a href="#案例一：当前业务耗时严重" class="headerlink" title="案例一：当前业务耗时严重"></a>案例一：当前业务耗时严重</h1><h2 id="主线程-Trace-堆栈："><a href="#主线程-Trace-堆栈：" class="headerlink" title="主线程 Trace 堆栈："></a>主线程 Trace 堆栈：</h2><p><img src="../../../../image/2022-02-16-toutiao-anr-samples/1.webp" srcset="/image/loading.gif" lazyload alt="1.webp"></p>
<h2 id="分析过程："><a href="#分析过程：" class="headerlink" title="分析过程："></a>分析过程：</h2><h3 id="分析堆栈："><a href="#分析堆栈：" class="headerlink" title="分析堆栈："></a>分析堆栈：</h3><p>根据前文讲到的问题分析思路，首先观察 Trace 主线程堆栈，从上面堆栈，可以看到正在业务逻辑，但是当前这个业务逻辑是否耗时呢？如果耗时较长，是不是受到系统调度影响呢？带着这些疑问，我们来看一下系统侧的表现。</p>
<h3 id="分析系统-amp-进程负载："><a href="#分析系统-amp-进程负载：" class="headerlink" title="分析系统&amp;进程负载："></a>分析系统&amp;进程负载：</h3><p><img src="../../../../image/2022-02-16-toutiao-anr-samples/2.webp" srcset="/image/loading.gif" lazyload alt="2.webp"></p>
<ul>
<li><p>观察不同时段系统负载： 在 ANR Info 中我们搜索 Load 关键字，发现 ANR 前 1，前 5，前 15 分钟(<code>Load:7.45 / 6.92 / 6.84</code>)，系统 CPU 整体负载并不高。</p>
</li>
<li><p>观察进程 CPU 使用率： 进一步观察 <code>CPU usage from 0 ms to 8745ms later</code>，看到 ANR 之后 (later：表示发生 ANR 后一段时间各进程 CPU 占比，ago 表示：ANR 之后一段时间，各进程 CPU 占比)的这段时间，<strong>应用主进程 CPU 占比达到 161%，而且在 user，kernel 占比分布上，kernel 比例高达 103%！</strong> 通过前文的介绍，我们知道对应用来说 kernel 空间 CPU 占比较高，说明应用侧应该发生了大量的系统调用，对普通应用来说，发生系统调用的多数场景都是文件 IO 操作。</p>
</li>
<li><p>观察线程： 继续观察上图，可以看到应用进程内部的线程 CPU 占用，可以看到 **主线程的 CPU 占比 93%，其中 kernel 占用 69%，明显高于用户空间 23%**，说明 ANR 之后的这 8S 多，主线程依然在进行大量系统调用。</p>
</li>
<li><p>系统侧结论： 通过观察系统负载和各个进程的 CPU 使用情况，我们发现系统整体负载比较正常，但是我们的主进程 CPU 占比明显偏高，并且集中在主线程。</p>
</li>
</ul>
<h3 id="业务耗时："><a href="#业务耗时：" class="headerlink" title="业务耗时："></a>业务耗时：</h3><p>根据上面的分析，我们将思路再次回到主线程，进一步观察 Trace 堆栈，发现上面有一个明显的系统调用(read)，难道是本次系统调用导致的 kernel 占比较高吗？那么当前逻辑在 ANR 发生前已经持续了多久呢？分析到这里，如果没有进一步的监控，或者业务不认可当前业务逻辑耗时，那么事情到这里可能就要告一段落，或者需要在业务层添加监控埋点进行复现了，但是如果每次遇到这类问题都要添加埋点，那么将是一个非常糟糕的事情。</p>
<p>别忘了，在前面介绍 ANR 问题分析思路时，我们还有一个杀手锏(参见：<a href="../../../../2022/02/16/toutiao-anr-tools/">监控工具 Raster</a>)，通过这个监控工具可以看到很清晰的看到：<strong>历史消息耗时，当前消息持续时间以及消息队列未调度消息 Block 耗时</strong>。结合上面这个问题，我们看到了本次主线程消息调度情况，参见下图：</p>
<p><img src="../../../../image/2022-02-16-toutiao-anr-samples/3.webp" srcset="/image/loading.gif" lazyload alt="3.webp"></p>
<p>通过还原的时序图，可以清晰看到 ANR 之前，主线程消息调度及耗时基本正常，没有发现明显耗时严重的消息，但是观察正在调度的消息，其 Wall duration 超过 9000ms，并且 Cpu duration 长达 4800ms+，说明该消息耗时非常严重。而且上图灰色部分显示第一个消息，被 Block 了 9S 以上，因此可以进一步的说明该消息被 Block 的时长，基本都是当前正在执行的消息导致。</p>
<h2 id="问题结论："><a href="#问题结论：" class="headerlink" title="问题结论："></a>问题结论：</h2><p>通过上面这些分析信息和实际数据，我们可以得出如下结论：<strong>发生 ANR 问题时，系统负载良好。发生问题前，应用主线程消息调度状态良好，但是当前正在调度的消息耗时严重，导致了后续消息未能及时响应，引起了 ANR</strong>。</p>
<p>带着这些结论，在和业务对接时便会清晰高效很多。这种场景，属于比较常规和常见的问题，也是大部分同学排查问题的分析思路，过程相对轻松。接下来，我们再看另一种场景的 ANR 问题。</p>
<h1 id="案例二：历史消息耗时严重"><a href="#案例二：历史消息耗时严重" class="headerlink" title="案例二：历史消息耗时严重"></a>案例二：历史消息耗时严重</h1><p>下面分析的这个案例，是大家经常遇到的，也是引起很多人困惑的一种场景：<code>发生 ANR 时，Trace 堆栈落在了 NativePollOnce</code>。根据我们的理解，这个场景一般表示当前线程处于空闲或 JNI 执行完之后，进行上下文切换的过程，相关逻辑比较清晰。</p>
<p>可是日常遇到的问题，有很多 Case 都属于这类场景，如果仅仅依靠系统日志让我们很难进一步分析。下面就看看我们是如何应对这类问题的：</p>
<h2 id="主线程-Trace-堆栈：-1"><a href="#主线程-Trace-堆栈：-1" class="headerlink" title="主线程 Trace 堆栈："></a>主线程 Trace 堆栈：</h2><p><img src="../../../../image/2022-02-16-toutiao-anr-samples/4.webp" srcset="/image/loading.gif" lazyload alt="4.webp"></p>
<h2 id="分析思路："><a href="#分析思路：" class="headerlink" title="分析思路："></a>分析思路：</h2><h3 id="分析堆栈：-1"><a href="#分析堆栈：-1" class="headerlink" title="分析堆栈："></a>分析堆栈：</h3><p>看到上面的 Trace 堆栈，基本无从下手，线程状态以及线程 utm,stm 时长都没有明显异常，但是线上确实有大量的 ANR 问题落在这个场景，难度在某种极端情况下虚拟机这部分逻辑耗时严重？但是从理论上来说这些假设确实不存在的。既然堆栈没有太多信息，我们就移步到系统层面，看看是否有线索可寻。</p>
<h3 id="分析系统-amp-进程负载：-1"><a href="#分析系统-amp-进程负载：-1" class="headerlink" title="分析系统&amp;进程负载："></a>分析系统&amp;进程负载：</h3><p><img src="../../../../image/2022-02-16-toutiao-anr-samples/5.webp" srcset="/image/loading.gif" lazyload alt="5.webp"></p>
<ul>
<li><p>观察系统负载： 在 ANR Info 中查看Load关键字，发现系统在前 1 分钟，前 5 分钟，前 15 分钟各个时段负载并不算高，但是最近 1 分钟 CPU 负载为 11.81，比前 5，15 分钟都高，说明负载有加重趋势。</p>
</li>
<li><p>观察进程 CPU 分布： 进一步观察 CPU usage from 0 ms to 5599 later 关键字，看到 ANR 之后这 5S 多的时间，我们应用主进程 CPU 占比达到 155%，而且在 user，kernel 层面 CPU 占比分布上，user 占比 124%，明显很高，这时直觉告诉我们，当前进程应该有问题。</p>
</li>
<li><p>观察系统 CPU 分布：</p>
</li>
</ul>
<p><img src="../../../../image/2022-02-16-toutiao-anr-samples/6.webp" srcset="/image/loading.gif" lazyload alt="6.webp"></p>
<p>进一步分析系统负载，发现整体 CPU 使用率并不高。user 占比 17%，kernel 占比 7.5%，iowait 占比 0.7%，说明这段时间系统 IO 并不繁忙，整体也符合预期。</p>
<ul>
<li>系统侧结论： 通过观察系统负载和各个进程的 CPU 使用情况，发现系统环境比较正常，但是我们的主进程 CPU 占比明显偏高，但因本次 Anr Info 中未获取到进程内部各线程 CPU 使用率，需要回到应用侧进一步分析。</li>
</ul>
<h3 id="应用侧分析："><a href="#应用侧分析：" class="headerlink" title="应用侧分析："></a>应用侧分析：</h3><p>根据上面的分析，我们将方向转回到当前进程，通过对比 Trace 中各线程耗时(utm+stm)，发现除了主线程之外，其它部分子线程耗时(utm+stm)没有明显异常，因此基本排除了进程内部子线程 CPU 竞争导致的问题，因此问题进一步聚焦到主线程。</p>
<p>接下来再将目光聚焦在主线程消息调度情况，通过监控工具观察主线程的历史消息，当前消息以及待调度消息，如下图：</p>
<p><img src="../../../../image/2022-02-16-toutiao-anr-samples/7.webp" srcset="/image/loading.gif" lazyload alt="7.webp"></p>
<p>通过上图可以看到当前消息调度 Wall Duration 为 46ms。**在 ANR 之前存在一个索引为 46 的历史消息耗时严重(wall duration:10747ms)**，同时还有一个索引为 32 的历史消息耗时也比较严重(wall duration:10747ms)。</p>
<p>进一步观察消息队列第一个待调度消息，发现其实际 block 时长为 9487ms，因此我们排除了索引为 32 的历史消息，<strong>认为索引为 46 的消息耗时是导致后续消息未能及时调度的主要原因</strong>。</p>
<p>在锁定索引为 46 的历史消息之后，接下来利用监控工具中的<a href="../../../../2022/02/16/toutiao-anr-tools/">消息堆栈采样监控</a>，发现该消息执行过程，多次堆栈采样均命中创建 Webview 逻辑，原来业务在 UI 绘制过程直接实例化 Webview！(涉及到业务代码，采用堆栈详情不在此展示)</p>
<h2 id="问题结论：-1"><a href="#问题结论：-1" class="headerlink" title="问题结论："></a>问题结论：</h2><p>通过上面的分析并利用监控工具，我们可以很清晰看到发生 ANR 问题时，<strong>NativePollOnce 场景耗时并不长，导致本次 ANR 的主要原因是历史消息在 UI 绘制过程中同步创建 Webview，导致耗时严重。但是期间系统超时监控并没有触发，待主线程继续调度后续消息时，系统监控客户端响应超时，捕获了主线程正在执行的逻辑</strong>。</p>
<p>这类场景在线上线下都大量存在，但是从 ANR 设计原理和 Trace 采集流程来看，很多并不耗时的消息在调度过程中都成为了“替罪羊”。</p>
<h1 id="案例三：业务异常密集执行"><a href="#案例三：业务异常密集执行" class="headerlink" title="案例三：业务异常密集执行"></a>案例三：业务异常密集执行</h1><p>接下来分析的这个 Case，在多个产品都有遇到，仅从堆栈上面看，也是经常遇到并困惑我们的，现象和上面分析的案例有些类似，即业务逻辑很简单，实际耗时很少，但是经常出现在各种 ANR Trace 上面，只是依照堆栈信息，就把这个问题草率的分配给相应业务方去解决，业务同学大概率也是一头雾水，不知道从何下手。</p>
<p>但是如果按照上面两类问题的分析思路，可能也会陷入困惑，这时如果换个思路，可能会是另一番景象，下面就来看看我们是如何分析的。</p>
<h2 id="ANR-现场堆栈："><a href="#ANR-现场堆栈：" class="headerlink" title="ANR 现场堆栈："></a>ANR 现场堆栈：</h2><p><img src="../../../../image/2022-02-16-toutiao-anr-samples/8.webp" srcset="/image/loading.gif" lazyload alt="8.webp"></p>
<h2 id="问题分析："><a href="#问题分析：" class="headerlink" title="问题分析："></a>问题分析：</h2><h3 id="分析堆栈：-2"><a href="#分析堆栈：-2" class="headerlink" title="分析堆栈："></a>分析堆栈：</h3><p>根据前文分析思路，先观察 Trace 主线程堆栈，从上面堆栈，可以看到业务逻辑，第一反应就是业务耗时？按照经验，我们还是习惯性的再去看看系统日志，进一步缩小或锁定方向。</p>
<h3 id="分析-CPU-负载："><a href="#分析-CPU-负载：" class="headerlink" title="分析 CPU 负载："></a>分析 CPU 负载：</h3><p><img src="../../../../image/2022-02-16-toutiao-anr-samples/9.webp" srcset="/image/loading.gif" lazyload alt="9.webp"></p>
<ul>
<li><p>观察系统负载： 在 ANR Info 中搜索 Load 关键字，看到系统在各个时段(前 1，5，15 分钟)负载并不高，但是有加重趋势。</p>
</li>
<li><p>观察进程 CPU 分布： 进一步观察”CPU usage from 0 ms to 9460ms later”期间各个进程 CPU 占比情况，看到这段时间目标应用的主进程 CPU 占比达到 153%，而且在 user，kernel 占比分布上，<strong>user 占比高达 127%，存在明显异常。Kernel 占比 25%，也有些偏高</strong>。与此同时，我们进一步观察 kswapd，mmc 进程 CPU 使用率，发现占用率不是太高，说明当前系统的整体内存和 IO 并没有太严重问题。</p>
</li>
<li><p>观察系统 CPU 分布： 为了进一步验证系统 IO 及内存负载是否正常，接下来再观察一下系统整体 CPU 使用和分布，发现 iowait 占比 7.5%，相对来说有些偏高。</p>
</li>
</ul>
<p><img src="../../../../image/2022-02-16-toutiao-anr-samples/10.webp" srcset="/image/loading.gif" lazyload alt="10.webp"></p>
<ul>
<li>进程 CPU 再观察： 与此同时，我们在 ANR Info 里面还发现了一个关键信息，看到了另一个时段问题进程内部主要线程的 CPU 占用情况，通过下图我们可以看到主线程 CPU 占用 95%，属于明显偏高。</li>
</ul>
<p><img src="../../../../image/2022-02-16-toutiao-anr-samples/11.webp" srcset="/image/loading.gif" lazyload alt="11.webp"></p>
<ul>
<li>系统侧分析结论：通过上面的分析，基本可以得出如下结论：<strong>发生问题时，系统 CPU，Mem 负载比较正常，IO 负载有些偏高，发生 ANR 问题的应用进程 CPU 使用率存在异常，而且集中在主线程</strong>。</li>
</ul>
<h2 id="业务耗时：-1"><a href="#业务耗时：-1" class="headerlink" title="业务耗时："></a>业务耗时：</h2><p>根据上面的分析，已经将排查方向锁定在主线程 CPU 使用率较高，接下来观察该线程的 utm+stm，发现累计耗时(1752+128)*10ms=18.8S。对比本次进程启动时长才 22S，说明进程启动后，主线程基本是在满负荷执行！而且主线程的 CPU 响应能力非常不错！</p>
<p>至此我们再次确认主线程存在严重耗时，难道又是当前消息或某个历史消息耗时严重？于是快速切换到消息调度监控，一探究竟。</p>
<p><img src="../../../../image/2022-02-16-toutiao-anr-samples/12.webp" srcset="/image/loading.gif" lazyload alt="12.webp"></p>
<p>但是看到上面的消息调度监控时序图，发现 <strong>当前消息执行时长才 300ms，并不是我们期待的耗时很严重哪种场景，进一步观察 ANR 之前历史消息调度，也没有看到有单次耗时严重的消息。继续观察上图待调度消息，发现确实被严重 Block。既然主线程没有看到严重耗时，系统负载也比较正常，那么主线程 CPU 使用率为何会这么高呢，这个情况与预期不符，不符合常理啊！</strong></p>
<p>观察 Block 消息： 之前我们介绍 <a href="../../../../2022/02/16/toutiao-anr-tools/">Raster 工具</a> 时，介绍该工具不仅可以记录历史消息，标记严重耗时，关键消息之外。还有一个作用就是获取消息队列待调度的消息，于是我们继续观察这些被 Block 的消息，发现了一个非常奇怪的现象（由于时序图只能在鼠标停留时展示单个消息详情，因此直接截取原始数据)，如下图：</p>
<p><img src="../../../../image/2022-02-16-toutiao-anr-samples/13.webp" srcset="/image/loading.gif" lazyload alt="13.webp"></p>
<p>通过对比，<strong>发现消息队列待调度的消息中，除了第一个消息之外，其余的 200 多个消息(为了便于展示，目前只获取最多前 300 个)，竟然是同一个 Handler 对象(hash:1173da0)的消息</strong>，再进一步对比发现当前正在调度的也是该 Handler 对象的消息。</p>
<p><img src="../../../../image/2022-02-16-toutiao-anr-samples/14.webp" srcset="/image/loading.gif" lazyload alt="14.webp"></p>
<p>这个情况引起了我们的注意，顺着这个思路，继续翻看历史调度信息，发现每条历史记录 (尽管存在多条消息耗时较少被聚合的场景，但是我们会保留最后一个消息的 msg string 信息) 的last msg 也是相同的 handler 对象，如下图。</p>
<p><img src="../../../../image/2022-02-16-toutiao-anr-samples/15.webp" srcset="/image/loading.gif" lazyload alt="15.webp"></p>
<p>这么多消息都来自同一个 Handler，这么密集的在主线程执行，每条记录 cpu 耗时都在 290ms 左右，每条记录监控统计期间调度了 5 条消息。分析到这里，我们基本就有答案了，<strong>很有可能是当前业务发生异常，导致不停的向主线程发送消息，频繁密集的消息依次执行，严重阻塞了后续消息调度</strong>。</p>
<h2 id="问题结论：-2"><a href="#问题结论：-2" class="headerlink" title="问题结论："></a>问题结论：</h2><p>带着上面这些分析信息和监控数据，我们得出如下结论：<strong>应用在启动之后，业务逻辑发生异常，瞬间产生大量消息，尽管单次消息执行耗时并不严重，但是这些消息在主线程密集执行，严重影响了后续消息调度，进而导致后续消息响应超时</strong>。</p>
<p>对于这个问题，当我们把相关数据和结论反馈给业务同学时，业务同学进一步分析业务逻辑，发现当前逻辑确实存在隐患，改进之后，该 ANR 问题就此得到解决。</p>
<p><strong>这种场景属于典型的业务逻辑异常造成的问题，如果没有监控工具由点到面的聚合和展示，单独分析某一次消息耗时，无论如何是找不到问题原因的</strong>。</p>
<h1 id="案例四：进程内-IO-负载异常"><a href="#案例四：进程内-IO-负载异常" class="headerlink" title="案例四：进程内 IO 负载异常"></a>案例四：进程内 IO 负载异常</h1><p>上面重点介绍了主线程内部环境导致问题的相关案例，介绍当前消息耗时严重，历史消息耗时严重，以及消息密集这几种类型的分析思路，接下来再分析一个进程内 IO 抢占的案例，下面就来看看如何层层拨云揭雾，寻找真相的。</p>
<h2 id="主线程-Trace-堆栈：-2"><a href="#主线程-Trace-堆栈：-2" class="headerlink" title="主线程 Trace 堆栈："></a>主线程 Trace 堆栈：</h2><p><img src="../../../../image/2022-02-16-toutiao-anr-samples/16.webp" srcset="/image/loading.gif" lazyload alt="16.webp"></p>
<h2 id="问题分析：-1"><a href="#问题分析：-1" class="headerlink" title="问题分析："></a>问题分析：</h2><h3 id="堆栈分析："><a href="#堆栈分析：" class="headerlink" title="堆栈分析："></a>堆栈分析：</h3><p>上面这个 Trace 信息，也是无从下手，堆栈本身是一个很清晰的系统逻辑，但是现实中确实也有大量 ANR Trace 落在这个场景，难道是系统进入 epoll_wait 之后，没有被及时唤醒？但是从理论上来说这些假设不存在。既然堆栈信息没有太明显，我们就把方向转移到系统侧，看看是否有线索。</p>
<h3 id="系统-amp-进程负载分析："><a href="#系统-amp-进程负载分析：" class="headerlink" title="系统&amp;进程负载分析："></a>系统&amp;进程负载分析：</h3><p><img src="../../../../image/2022-02-16-toutiao-anr-samples/17.webp" srcset="/image/loading.gif" lazyload alt="17.webp"></p>
<ul>
<li><p>观察系统负载： 在 ANR Info 中我们搜索 Load 关键字，发现 <strong>系统各个时段(前 1，5，15 分钟)负载明显很高，并且最近 1 分钟负载为 71，又明显高于前 5，15 分钟，说明有系统负载进一步加重</strong>！</p>
</li>
<li><p>观察进程 CPU 分布： 进一步观察 CPU usage from 0 ms to 21506 later 关键字，看到 <strong>ANR 之后这段时间，内核线程 kworker 的 CPU 占比明显偏高，累计占比超过 45%！其它系统或应用进程 CPU 使用率普遍偏低</strong>。 通过前文介绍我们知道 kworker 属于内核线程，当 IO 负载过重时会在该线程有所体现。进一步观察 kswapd0 线程 cpu 使用率，发现只有 2%，而 kswapd0 主要应用在内存紧张的场景，说明这段时间系统内存负载基本正常。通过上面这些信息解读，可以大致推测最近一段时间系统负载过高，应该是 IO 请求导致，至于系统内存压力尚可接受，接下来我们继续求证。</p>
</li>
</ul>
<p><img src="../../../../image/2022-02-16-toutiao-anr-samples/18.webp" srcset="/image/loading.gif" lazyload alt="18.webp"></p>
<p>观察进一步分析系统整体负载，发现 user 占比只有 5.4%，kernel 占比 11%，<strong>但是 iowait 占比高达 57%！明显高于 user，kernel 使用率，说明这段时间系统 IO 负载非常严重</strong>。</p>
<p>而这个 IO 占比较高，也进一步实锤了我们上面的“观察进程 CPU 分布”的结论。那么是哪个应用导致的呢？遗憾的，受限于系统日志获取能力，依靠现有的信息并没有明显看到异常进程，那么 IO 发生在哪里，是否和当前进程有关呢？于是我们将思路再次回到应用内部。</p>
<h3 id="应用侧分析：-1"><a href="#应用侧分析：-1" class="headerlink" title="应用侧分析："></a>应用侧分析：</h3><p>通过上面的分析，我们基本锁定了是 IO 负载过重导致的问题，接下来便要进一步排查是否是当前进程内部存在异常，于是我们对比了各个线程的耗时(utm+stm)情况：</p>
<p><img src="../../../../image/2022-02-16-toutiao-anr-samples/19.webp" srcset="/image/loading.gif" lazyload alt="19.webp"></p>
<p>通过上图线程耗时对比可以清晰的发现，<strong>DBHelper-AsyncOp-New 线程无论是 utm 时长，还是 stm 时长，都明显超过其它线程，而 stm 高达 2915！</strong> 这个耗时超出了我们的预期，实际场景中我们认为主线程才 CPU 消耗大户，其它线程都是配角。下面我们再看一下线程详情：</p>
<p><img src="../../../../image/2022-02-16-toutiao-anr-samples/20.webp" srcset="/image/loading.gif" lazyload alt="20.webp"></p>
<p>进一步查看该线程堆栈，发现 <strong>存在明显的 IO 操作，而且子线程优先级(nice=0)相对较高，stm(2915)+utm(1259)高达 4000+，换算成时长相当于 CPU 真实执行超过了 40S！</strong></p>
<p><strong>对比主线程耗时(utm:1035，stm:216)，以及进程启动时长(4 分 18 秒)，可以更好证明了 DBHelper 线程存在异常</strong>，stm 明显过长，说明存在大量系统调用，结合该线程业务，可以很快就猜到是 IO 读写引起的问题了。因为该线程本身就是负责应用内部数据库清理功能的。</p>
<p>经过上面的分析之后，下面来看一下主线程调度时序图，看看 IO 负载过重对主线程有多大影响。</p>
<h2 id="消息调度时序图分析"><a href="#消息调度时序图分析" class="headerlink" title="消息调度时序图分析"></a>消息调度时序图分析</h2><p><img src="../../../../image/2022-02-16-toutiao-anr-samples/21.webp" srcset="/image/loading.gif" lazyload alt="21.webp"></p>
<p>通过上图，可以清晰看到 ANR 消息之前，有多个历史消息耗时存在明显异常，而且 Wall duration 与 Cpu duration 耗时比例差距较大，部分消息 cpu 时长更是小于 1ms(单位 ms，0 则表示小于 1ms)，说明在此期间主线程整体调度受到很大影响，而且这些消息内部涉及 IO 访问的逻辑将会受到更大影响。</p>
<p>同时结合我们现场 checkTime 机制，发现 checkTime 调度明显存在严重 delay 情况。</p>
<h2 id="问题结论：-3"><a href="#问题结论：-3" class="headerlink" title="问题结论："></a>问题结论：</h2><p>带着上面这些分析信息和数据，我们可以得出如下结论：**通过层层分析我们可以发现，发生ANR时的当前消息耗时近2S，但并不是root case，主线程出现多个历史消息耗时，但也不是root case，真正导致本次ANR的原因是DBHelper-AsyncOp线程在过去一段时间进行了长时间的IO操作，严重影响了主线程乃至进程本身的CPU调度，导致后续消息响应不及时，触发系统超时(ANR)**。</p>
<p>对于该类问题，除了应用本身优化之外，也与一些机型设备差异有关，例如不同机型 IO 性能本身就存在很大差异，因此理论上无法彻底解决。同时无论是进程内部还是其他进程进行 IO 密集操作，都可能引起系统 IO 负载过重，进而导致系统乃至所有进程调度受到影响，对于该类问题只能进一步的优化相关逻辑，降低 IO 访问频率，减少主线程 IO 访问等等。</p>
<p>这类问题，在线上比较常见，但是在开发同学的线下测试过程，性能普遍符合预期，针对线上用户，应用场景错综复杂，绝非线下能模拟，并且针对不同手机设备，不同芯片平台，甚至磁盘可用空间的差异，其 IO 性能也表现的千差万别而这些小概率的问题，在数亿万用户环境中，会频频出现。</p>
<h1 id="案例五：其它进程及系统负载异常"><a href="#案例五：其它进程及系统负载异常" class="headerlink" title="案例五：其它进程及系统负载异常"></a>案例五：其它进程及系统负载异常</h1><p>前面我们分析的几类问题，基本都是应用进程内部因素导致的问题，如主线消息耗时，消息密集执行，子线程 IO 资源抢占等等。线上环境中，除了进程或主线线程自身因素导致的问题外，还有一些是外部因素导致的问题，如其它进程或系统负载过重，进而影响当前进程正常调度。下面我们就来看一看这类问题是如何分析的。</p>
<h2 id="主线程-Trace-堆栈：-3"><a href="#主线程-Trace-堆栈：-3" class="headerlink" title="主线程 Trace 堆栈："></a>主线程 Trace 堆栈：</h2><p><img src="../../../../image/2022-02-16-toutiao-anr-samples/22.webp" srcset="/image/loading.gif" lazyload alt="22.webp"></p>
<h2 id="问题分析：-2"><a href="#问题分析：-2" class="headerlink" title="问题分析："></a>问题分析：</h2><h3 id="堆栈分析：-1"><a href="#堆栈分析：-1" class="headerlink" title="堆栈分析："></a>堆栈分析：</h3><p>看到上面这个 Trace 信息，同样是熟悉的味道，发生 ANR 时，系统正处于 epoll wait 状态，线程 utm 及 stm 耗时并不算长，累计(376+340)*10=7160ms。观察到这里基本没有看到太多有效信息。接下来继续把方向转移到系统侧，看看是否有线索可循。</p>
<h3 id="系统-amp-进程负载分析：-1"><a href="#系统-amp-进程负载分析：-1" class="headerlink" title="系统&amp;进程负载分析："></a>系统&amp;进程负载分析：</h3><p><img src="../../../../image/2022-02-16-toutiao-anr-samples/23.webp" srcset="/image/loading.gif" lazyload alt="23.webp"></p>
<ul>
<li><p>观察系统负载： 在 ANR Info 中搜索 Load 关键字，看到系统在各个时段(前 1，5，15 分钟)负载比较高，分别为 37.09，39.37，49.44，呈现加重趋势。</p>
</li>
<li><p>观察进程 CPU 分布： 进一步观察”CPU usage from 2401 ms to -22043ms ago”期间，各个进程 CPU 占比情况，看到这段时间目标进程 cpu 使用率很低，只有 17%。看到其它关键进程或线程，如 Kswapd0 线程，cpu 占比 20%，对于该线程来说，其出现则表示系统内存比较紧张了，而且看到了与其相关的 kworker，mmcqd 线程 cpu 占比也比较高。这些线程同时出现，足以说明当前系统环境发生了比较大的问题。而系统资源紧张，一般是因为某个或多个进程出现内存泄漏或大量 IO 读写导致，结合上面 Top 进程的 CPU 占比，com.youku.phone 以及 com.android.contacts 进程可疑性最大。而发生 ANR 问题的 com.ss.android.article.news 进程其 CPU 占比只有 17%。</p>
</li>
<li><p>观察系统 CPU 分布：</p>
</li>
</ul>
<p><img src="../../../../image/2022-02-16-toutiao-anr-samples/24.webp" srcset="/image/loading.gif" lazyload alt="24.webp"></p>
<p>通过上图信息可以看到，系统 CPU 整体使用率达到 54%，kernel 占比 15%，iowait 占比高达 24%，有些偏高。说明系统负载确实存在异常，其结论与我们上面分析的基本一致。</p>
<p>当然在这里比较遗憾的是，因为是线上问题，我们无法通过拿到系统以及其它进程更多信息，否则可以更加清晰的看到发生异常的是哪个进程， 但是接下来要进一步排除是当前进程导致的系统负载问题，我们将视野再次回到应用侧。</p>
<h3 id="应用侧分析：-2"><a href="#应用侧分析：-2" class="headerlink" title="应用侧分析："></a>应用侧分析：</h3><p>通过上面的分析，我们基本锁定了是内存负载过重导致的问题，接下来便要进一步排查是否是当前进程内部存在异常，于是我们对比了各线程的耗时(utm+stm)情况：</p>
<p><img src="../../../../image/2022-02-16-toutiao-anr-samples/25.webp" srcset="/image/loading.gif" lazyload alt="25.webp"></p>
<p>通过上图可以看到，排名第一的是主线程，其 utm+stm=700，换算成系统时长，700*10=7000ms，但是 <strong>对比观察进程启动时长，发现进程已经启动 108S，我们知道对应进程来说，启动的前 1~2 分钟，主线程是最为繁忙的，大量的业务和系统消息需要在主线程进行执行。同时我们进一步对比系统负载正常的情况，进程启动 2 分钟时主线程 CPU 执行时长明显大于当前时长</strong>。</p>
<p>下面我们再来看一下系统负载过重，对主线程消息调度的影响，如下图：</p>
<p><img src="../../../../image/2022-02-16-toutiao-anr-samples/26.webp" srcset="/image/loading.gif" lazyload alt="26.webp"></p>
<p>通过上图，可以清晰看到 ANR 消息之前，有多个历史消息耗时存在明显异常，而且 Wall duration 与 Cpu duration 耗时比例差距较大，从侧面也反映了在此期间主线程整体调度受到较大影响。</p>
<p>超时 Service 消息： 从上图可以清晰看到第一个待调度消息，其 Block 时长超过 18S 之多，接近于前面诸多耗时消息之和。同时从下图可以清晰看到发生 ANR 的这个 service 消息在消息队列排在第 8，消息 block 时长为 18482ms。</p>
<p><img src="../../../../image/2022-02-16-toutiao-anr-samples/27.webp" srcset="/image/loading.gif" lazyload alt="27.webp"></p>
<p><strong>在前文应用四大组件超时归类中提到 Service 超时时长分别为 20S 或 200S，现在该消息在应用侧 block 时长为 18482ms，那就说明剩下 1S 多的时间，耗费在系统 AMS 服务发送到客户端 Binder 线程接收过程，否则没有达到 20S 超时，是不会触发系统超时的。因此也进一步说明了系统调度性能存在问题。</strong></p>
<h2 id="问题小结"><a href="#问题小结" class="headerlink" title="问题小结"></a>问题小结</h2><p>带着上面这些分析信息和相关数据，我们可以得出如下结论：<strong>在进程启动前，系统负载已经很重，整个系统调度性能受到较大的影响，尽管发生 ANR 时当前堆栈耗时较长，但并不是 root case，多个历史耗时严重的消息也不是 root case，而导致本次 ANR 的应该是 com.youku.phone 或 com.android.contacts 进程，在过去一段时间进行大量系统资源访问，造成系统负载加重，严重影响了其他进程 CPU 调度，导致主线程消息处理不及时，触发系统超时(ANR)</strong></p>
<p>对于该类问题，因为是其它进程导致系统资源紧张，进而影响了当前进程，因此我们无法从根本上解决，当然能够很好的分析并找出原因，也是对待问题的一种态度吧。</p>
<h1 id="案例六：跨进程死锁"><a href="#案例六：跨进程死锁" class="headerlink" title="案例六：跨进程死锁"></a>案例六：跨进程死锁</h1><p>在前面更多从应用侧介绍了 ANR 案例的分析思路，接下来看看如何借助更多系统日志分析这类问题。当然，这类问题如果发生在线上，会因为应用侧无法获取跨进程 Trace 的原因，可能会被误归类为 IPC 耗时场景。</p>
<h2 id="主线程-Trace-堆栈：-4"><a href="#主线程-Trace-堆栈：-4" class="headerlink" title="主线程 Trace 堆栈："></a>主线程 Trace 堆栈：</h2><p><img src="../../../../image/2022-02-16-toutiao-anr-samples/28.webp" srcset="/image/loading.gif" lazyload alt="28.webp"></p>
<h2 id="问题分析：-3"><a href="#问题分析：-3" class="headerlink" title="问题分析："></a>问题分析：</h2><h3 id="堆栈分析：-2"><a href="#堆栈分析：-2" class="headerlink" title="堆栈分析："></a>堆栈分析：</h3><p>根据前面讲到的问题分析思路，先观察 Trace 主线程堆栈，从上面堆栈，可以看到业务逻辑发生 Binder 调用被 Block 的情况，但是这次拿到的是完整的 Trace 日志，那么接下来就沿着 Binder 请求逻辑，看一下响应进程的状态。</p>
<h3 id="服务进程分析："><a href="#服务进程分析：" class="headerlink" title="服务进程分析："></a>服务进程分析：</h3><p>首先查找客户端主线程在和哪个 Binder 线程进行通信，搜索代理接口setAppCallback(Android 命名习惯，代理端和服务端函数命名基本保持一致），发现是 Nfc 的 Binder_3 线程响应了客户端请求：</p>
<p><img src="../../../../image/2022-02-16-toutiao-anr-samples/29.webp" srcset="/image/loading.gif" lazyload alt="29.webp"></p>
<p>但是进一步观察堆栈信息，发现 Binder_3 线程被当前进程的主线程 Block，那么沿着这个线索看看主线程状态：</p>
<p><img src="../../../../image/2022-02-16-toutiao-anr-samples/30.webp" srcset="/image/loading.gif" lazyload alt="30.webp"></p>
<p>观察主线程状态，发现此刻主线程也在执行 Binder 通信，请求 <code>createBeamShareData</code>，同样根据命名习惯，继续搜索关键字 <code>createBeamShareData</code>，看看这次请求是哪个进程在响应，结果发现是 ANR 所在进程的 Binder_6 线程响应此请求。</p>
<p><img src="../../../../image/2022-02-16-toutiao-anr-samples/31.webp" srcset="/image/loading.gif" lazyload alt="31.webp"></p>
<p>通过观察 Binder_6 线程的堆栈和状态，发现该线程处于 await 状态，明显是在等待其它线程通知唤醒！分析到这里，就需要大家结合 Read the Fuck Code 的精神进一步分析业务逻辑了，在研究一番业务逻辑之后，发现唤醒此线程的业务逻辑，已经通过 Handler 发送到主线程，正等待主线程执行呢，但是如果时序处理的不恰当，就会出现主线程还没来得及执行这个消息，就去监听 NFC 状态，进而引起了连锁反应。至此找到了依赖链路：</p>
<p><img src="../../../../image/2022-02-16-toutiao-anr-samples/32.webp" srcset="/image/loading.gif" lazyload alt="32.webp"></p>
<p>通过上图可以清晰的看到本次 ANR 原因：<strong>跨进程死锁</strong>。</p>
<h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><p>我们按照前文 ANR 影响因素及归类分别选取了一个线上案例，并进行分析总结。回过头来看，第一类问题按照多数人的”解题思路”可能会很快的找到答案。在面对第二类问题时，如果没有监控工具就可能掉入“Trace 陷阱”了。第三类问题并不常见，但是在公司多个产品都有遇到过，因为这类问题更加隐蔽，如果依靠现有系统日志只能锁定方向，之后需要耗费大量的时间去添加埋点分析定位，但是通过我们的监控工具直观展示并暴露了更多细节，为成功定位问题扮演了关键角色。后面两类因为资源抢占的导致线程调度不及时的问题，通过监控工具很好的还原了 ANR 之前消息调度情况，更加清晰的证实了资源竞争对主线程的影响；但「barrier导致主线程假死」，「Service执行时序颠倒」等问题还有待解决。掌握了上述几类问题的分析思路，相信可以帮助大家应对工作中遇到大部分问题，但是所谓“林子大了，什么鸟都有”，下一篇将会介绍主线程假死，Service 执行时序颠倒等更加棘手的案例分析，敬请期待。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzI1MzYzMjE0MQ==&mid=2247488243&idx=1&sn=1f948e0ef616c6dfe54513a2a94357be&scene=21#wechat_redirect">今日头条 ANR 优化实践系列分享 - 实例剖析集锦</a></li>
</ol>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/ANR/">#ANR</a>
      
        <a href="/tags/bytedance/">#bytedance</a>
      
        <a href="/tags/toutiao/">#toutiao</a>
      
        <a href="/tags/%E5%AD%97%E8%8A%82/">#字节</a>
      
        <a href="/tags/%E5%A4%B4%E6%9D%A1/">#头条</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/02/16/toutiao-anr-barrier/" title="【转】今日头条 ANR 优化实践系列（4）- Barrier 导致主线程假死">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">【转】今日头条 ANR 优化实践系列（4）- Barrier 导致主线程假死</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/02/16/toutiao-anr-tools/" title="【转】今日头条 ANR 优化实践系列（2）- 监控工具与分析思路">
                        <span class="hidden-mobile">【转】今日头条 ANR 优化实践系列（2）- 监控工具与分析思路</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
