

<!DOCTYPE html>
<html lang="zh-CN" >



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/image/favicon.png">
  <link rel="icon" href="/image/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#141414">
  <meta name="author" content="Cyrus">
  <meta name="keywords" content="">
  
    <meta name="description" content="简介Logan 是 美团点评技术团队 开源的包含前端 SDK 和后端 Server 的一整套日志系统，也是公司日志库 VLog 的基础 Logan Android SDK 提供了这么几个 API：    API Description    Logan#w(log, type) 写日志（严谨地说应该是发送日志请求，因为日志是放在消息队列里等待被处理的）   Logan#init 初始化   Log">
<meta property="og:type" content="article">
<meta property="og:title" content="日志库 Logan">
<meta property="og:url" content="https://www.dalvik.work/2021/06/28/logan/index.html">
<meta property="og:site_name" content="Cyrus Blog">
<meta property="og:description" content="简介Logan 是 美团点评技术团队 开源的包含前端 SDK 和后端 Server 的一整套日志系统，也是公司日志库 VLog 的基础 Logan Android SDK 提供了这么几个 API：    API Description    Logan#w(log, type) 写日志（严谨地说应该是发送日志请求，因为日志是放在消息队列里等待被处理的）   Logan#init 初始化   Log">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.dalvik.work/image/2021-06-28-logan/files.png">
<meta property="article:published_time" content="2021-06-28T04:00:00.000Z">
<meta property="article:modified_time" content="2022-06-24T10:35:05.285Z">
<meta property="article:author" content="Cyrus">
<meta property="article:tag" content="log">
<meta property="article:tag" content="logcat">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://www.dalvik.work/image/2021-06-28-logan/files.png">
  
  
  
  <title>日志库 Logan - Cyrus Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  



  
<link rel="stylesheet" href="/css/custom.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"www.dalvik.work","root":"/","version":"1.9.2","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#91cb3e","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":99},"lazyload":{"enable":true,"loading_img":"/image/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":"7d0c9146781b5fb9ae68cfc826d0be54","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 30vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Cyrus Land</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/image/sunset_sea.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">日志库 Logan</span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2021-06-28 04:00" pubdate>
          2021年6月28日
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          20k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          167 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">日志库 Logan</h1>
            
            
              <div class="markdown-body">
                
                <h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><a target="_blank" rel="noopener" href="https://github.com/Meituan-Dianping/Logan">Logan</a> 是 <a target="_blank" rel="noopener" href="https://github.com/meituan">美团点评技术团队</a> 开源的包含前端 SDK 和后端 Server 的一整套日志系统，也是公司日志库 <code>VLog</code> 的基础</p>
<p>Logan Android SDK 提供了这么几个 API：</p>
<table>
<thead>
<tr>
<th>API</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>Logan#w(log, type)</td>
<td>写日志（严谨地说应该是发送日志请求，因为日志是放在消息队列里等待被处理的）</td>
</tr>
<tr>
<td>Logan#init</td>
<td>初始化</td>
</tr>
<tr>
<td>Logan#f</td>
<td>Logan 内部有个内存缓存（memory/mmap），日志首先被写入到缓存里，只有到达一定大小时（1/3）才写入文件，这里请求立刻写入到文件里去</td>
</tr>
<tr>
<td>Logan#s</td>
<td>根据日期 获取/发送 日志文件</td>
</tr>
<tr>
<td>Logan#getAllFilesInfo</td>
<td>获取所有的日志文件，key 是日期，value 是日志文件大小</td>
</tr>
<tr>
<td>Logan#setDebug</td>
<td>设置为 debug 模式后，会有更加详细的 native 日志，但是默认实现只是输出到 stdout 没有写入 android log</td>
</tr>
<tr>
<td>Logan#setOnLoganProtocolStatus</td>
<td>可以拿到一些 Java 的关键日志</td>
</tr>
</tbody></table>
<p>LoganConfig 是初始化配置参数：</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>path</td>
<td>存放日志文件的目录，日志是按日期（天）存放的，文件名是当天零时零分零秒的时间戳</td>
</tr>
<tr>
<td>cachePath</td>
<td>内存缓存对应的 mmap 文件所在的目录</td>
</tr>
<tr>
<td>maxFile</td>
<td>当日志文件超过此大小时，就不能再继续往 buffer 里写入日志</td>
</tr>
<tr>
<td>day</td>
<td>只保留 n 天内的日志文件，旧的都删掉</td>
</tr>
<tr>
<td>minSDCard</td>
<td>当可用的存储容量超过此阈值时才写入日志</td>
</tr>
<tr>
<td>encryptKey16</td>
<td>AES 加密参数 KEY</td>
</tr>
<tr>
<td>encryptIv16</td>
<td>AES 加密参数 IV</td>
</tr>
</tbody></table>
<h3 id="日志队列与-生产者-消费者-模型"><a href="#日志队列与-生产者-消费者-模型" class="headerlink" title="日志队列与 生产者-消费者 模型"></a>日志队列与 生产者-消费者 模型</h3><p>调用 <code>Logan.w</code> 的线程是日志的生产者，日志写入请求被放入日志队列（<code>Queue</code>）里等待处理，<code>LoganThread</code> 线程作为消费者不断地执行日志队列里的任务</p>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Logan</span> &#123;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> log  表示日志内容</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@param</span> type 表示日志类型</span>
<span class="hljs-comment">     * <span class="hljs-doctag">@brief</span> Logan写入日志</span>
<span class="hljs-comment">     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">w</span><span class="hljs-params">(String log, <span class="hljs-type">int</span> type)</span> &#123;
        <span class="hljs-keyword">if</span> (sLoganControlCenter == <span class="hljs-literal">null</span>) &#123;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Please initialize Logan first&quot;</span>);
        &#125;
        sLoganControlCenter.write(log, type);
    &#125;
&#125;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">LoganControlCenter</span> &#123;

    <span class="hljs-keyword">private</span> ConcurrentLinkedQueue&lt;LoganModel&gt; mCacheLogQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentLinkedQueue</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> LoganThread mLoganThread;

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">write</span><span class="hljs-params">(String log, <span class="hljs-type">int</span> flag)</span> &#123;
        <span class="hljs-keyword">if</span> (TextUtils.isEmpty(log)) &#123;
            <span class="hljs-keyword">return</span>;
        &#125;
        <span class="hljs-type">LoganModel</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoganModel</span>();
        model.action = LoganModel.Action.WRITE;
        <span class="hljs-type">WriteAction</span> <span class="hljs-variable">action</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WriteAction</span>();
        <span class="hljs-type">String</span> <span class="hljs-variable">threadName</span> <span class="hljs-operator">=</span> Thread.currentThread().getName();
        <span class="hljs-type">long</span> <span class="hljs-variable">threadLog</span> <span class="hljs-operator">=</span> Thread.currentThread().getId();
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isMain</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">if</span> (Looper.getMainLooper() == Looper.myLooper()) &#123;
            isMain = <span class="hljs-literal">true</span>;
        &#125;
        action.log = log;
        action.localTime = System.currentTimeMillis();
        action.flag = flag;
        action.isMainThread = isMain;
        action.threadId = threadLog;
        action.threadName = threadName;
        model.writeAction = action;
        <span class="hljs-keyword">if</span> (mCacheLogQueue.size() &lt; mMaxQueue) &#123;
            mCacheLogQueue.add(model);
            <span class="hljs-keyword">if</span> (mLoganThread != <span class="hljs-literal">null</span>) &#123;
                mLoganThread.notifyRun();
            &#125;
        &#125;
    &#125;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;
        <span class="hljs-keyword">if</span> (mLoganThread == <span class="hljs-literal">null</span>) &#123;
            mLoganThread = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoganThread</span>(mCacheLogQueue, mCachePath, mPath, mSaveTime,
                    mMaxLogFile, mMinSDCard, mEncryptKey16, mEncryptIv16);
            mLoganThread.setName(<span class="hljs-string">&quot;logan-thread&quot;</span>);
            mLoganThread.start();
        &#125;
    &#125;    
&#125;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">LoganThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;
        <span class="hljs-built_in">super</span>.run();
        <span class="hljs-keyword">while</span> (mIsRun) &#123;
            <span class="hljs-keyword">synchronized</span> (sync) &#123;
                mIsWorking = <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">try</span> &#123;
                    <span class="hljs-type">LoganModel</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> mCacheLogQueue.poll();
                    <span class="hljs-keyword">if</span> (model == <span class="hljs-literal">null</span>) &#123;
                        mIsWorking = <span class="hljs-literal">false</span>;
                        sync.wait();
                        mIsWorking = <span class="hljs-literal">true</span>;
                    &#125; <span class="hljs-keyword">else</span> &#123;
                        action(model);
                    &#125;
                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;
                    e.printStackTrace();
                    mIsWorking = <span class="hljs-literal">false</span>;
                &#125;
            &#125;
        &#125;
    &#125;
&#125;</code></pre></div>

<h3 id="内存缓存-Buffer"><a href="#内存缓存-Buffer" class="headerlink" title="内存缓存 Buffer"></a>内存缓存 Buffer</h3><p>并不是每次日志请求都立刻写入到日志文件里，而是在内存中开辟一段缓存（默认为 150K）作为 buffer，当 buffer 里的数据积累得足够多时（1/3 buffer 大小）才写入文件</p>
<div class="code-wrapper"><pre><code class="hljs cpp">LoganThread.doWriteLog2File
LoganProtocol.logan_write
CLoganProtocol.logan_write
CLoganProtocol.<span class="hljs-function">clogan_write</span>
<span class="hljs-function">Java_com_dianping_logan_CLoganProtocol_clogan_1write</span>
<span class="hljs-function">clogan_write</span>
<span class="hljs-function">clogan_write_section</span>
<span class="hljs-function"></span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">clogan_write2</span><span class="hljs-params">(<span class="hljs-type">char</span> *data, <span class="hljs-type">int</span> length)</span> </span>&#123;
    <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> != logan_model &amp;&amp; logan_model-&gt;is_ok) &#123;
        <span class="hljs-built_in">clogan_zlib_compress</span>(logan_model, data, length);    <span class="hljs-comment">// 压缩和加密后的数据放在内存 buffer 里</span>
        <span class="hljs-built_in">update_length_clogan</span>(logan_model);
        <span class="hljs-type">int</span> is_gzip_end = <span class="hljs-number">0</span>;

        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (buffer_type == LOGAN_MMAP_MMAP &amp;&amp;
                   logan_model-&gt;total_len &gt;=
                   buffer_length / LOGAN_WRITEPROTOCOL_DEVIDE_VALUE) &#123;  <span class="hljs-comment">// 只有当数据大小到达阈值（1/3 buffer 容量）时才写入文件</span>
            isWrite = <span class="hljs-number">1</span>;
            <span class="hljs-built_in">printf_clogan</span>(<span class="hljs-string">&quot;clogan_write2 &gt; write type MMAP \n&quot;</span>);
        &#125;

        <span class="hljs-keyword">if</span> (isWrite) &#123;  <span class="hljs-comment">// 写入文件</span>
            <span class="hljs-built_in">write_flush_clogan</span>();
        
    &#125;
&#125;</code></pre></div>

<h4 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a>mmap</h4><p>当 APP 因为崩溃而被 kill 或者被其他进程 kill 时，保存在内存中的日志缓存就会失去回写文件的机会，从而导致日志的丢失</p>
<p>使用 <code>mmap</code> 可以在虚拟内存中开辟一片内存空间作为 buffer，它对应了一个 file backed，系统会选择合适的机会将 buffer 回写至文件，而且在进程被 kill 时系统可以确保 buffer 被正确地回写，确保进程异常时不会丢失日志</p>
<p>mmap file 位于 <code>&#123;cacheDir&#125;/logan_cache/logan.mmap2</code>，buffer 和 mmap file 的大小默认为 150K</p>
<div class="code-wrapper"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> LOGAN_MMAP_LENGTH</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> LOGAN_MMAP_LENGTH 150 * 1024 <span class="hljs-comment">//150k</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

<span class="hljs-comment">// 创建MMAP缓存buffer或者内存buffer</span>
<span class="hljs-comment">// _filepath: mmap file 地址</span>
<span class="hljs-comment">// buffer: mmap buffer</span>
<span class="hljs-comment">// cache: 如果 mmap 失败则使用内存缓存</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">open_mmap_file_clogan</span><span class="hljs-params">(<span class="hljs-type">char</span> *_filepath, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> **buffer, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> **cache)</span> </span>&#123;
    <span class="hljs-type">int</span> back = LOGAN_MMAP_FAIL;
    <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> == _filepath || <span class="hljs-number">0</span> == <span class="hljs-built_in">strnlen</span>(_filepath, <span class="hljs-number">128</span>)) &#123;
        back = LOGAN_MMAP_MEMORY;
    &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *p_map = <span class="hljs-literal">NULL</span>;
        <span class="hljs-type">int</span> size = LOGAN_MMAP_LENGTH;
        <span class="hljs-type">int</span> fd = <span class="hljs-built_in">open</span>(_filepath, O_RDWR | O_CREAT, S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP); <span class="hljs-comment">//后两个添加权限</span>
        <span class="hljs-type">int</span> isNeedCheck = <span class="hljs-number">0</span>; <span class="hljs-comment">//是否需要检查mmap缓存文件重新检查</span>
        <span class="hljs-keyword">if</span> (fd != <span class="hljs-number">-1</span>) &#123; <span class="hljs-comment">//保护</span>
            <span class="hljs-type">int</span> isFileOk = <span class="hljs-number">0</span>;
            FILE *file = <span class="hljs-built_in">fopen</span>(_filepath, <span class="hljs-string">&quot;rb+&quot;</span>); <span class="hljs-comment">//先判断文件是否有值，再mmap内存映射</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> != file) &#123;
                <span class="hljs-built_in">fseek</span>(file, <span class="hljs-number">0</span>, SEEK_END);
                <span class="hljs-type">long</span> longBytes = <span class="hljs-built_in">ftell</span>(file);
                <span class="hljs-keyword">if</span> (longBytes &lt; LOGAN_MMAP_LENGTH) &#123;
                    <span class="hljs-built_in">fseek</span>(file, <span class="hljs-number">0</span>, SEEK_SET);
                    <span class="hljs-type">char</span> zero_data[size];
                    <span class="hljs-built_in">memset</span>(zero_data, <span class="hljs-number">0</span>, size);
                    <span class="hljs-type">size_t</span> _size = <span class="hljs-number">0</span>;
                    _size = <span class="hljs-built_in">fwrite</span>(zero_data, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">char</span>), size, file);
                    <span class="hljs-built_in">fflush</span>(file);
                    <span class="hljs-keyword">if</span> (_size == size) &#123;
                        <span class="hljs-built_in">printf_clogan</span>(<span class="hljs-string">&quot;copy data 2 mmap file success\n&quot;</span>);
                        isFileOk = <span class="hljs-number">1</span>;
                        isNeedCheck = <span class="hljs-number">1</span>;
                    &#125; <span class="hljs-keyword">else</span> &#123;
                        isFileOk = <span class="hljs-number">0</span>;
                    &#125;
                &#125; <span class="hljs-keyword">else</span> &#123;
                    isFileOk = <span class="hljs-number">1</span>;
                &#125;
                <span class="hljs-built_in">fclose</span>(file);
            &#125; <span class="hljs-keyword">else</span> &#123;
                isFileOk = <span class="hljs-number">0</span>;
            &#125;

            <span class="hljs-keyword">if</span> (isNeedCheck) &#123; <span class="hljs-comment">//加强保护，对映射的文件要有一个适合长度的文件</span>
                FILE *file = <span class="hljs-built_in">fopen</span>(_filepath, <span class="hljs-string">&quot;rb&quot;</span>);
                <span class="hljs-keyword">if</span> (file != <span class="hljs-literal">NULL</span>) &#123;
                    <span class="hljs-built_in">fseek</span>(file, <span class="hljs-number">0</span>, SEEK_END);
                    <span class="hljs-type">long</span> longBytes = <span class="hljs-built_in">ftell</span>(file);
                    <span class="hljs-keyword">if</span> (longBytes &gt;= LOGAN_MMAP_LENGTH) &#123;
                        isFileOk = <span class="hljs-number">1</span>;
                    &#125; <span class="hljs-keyword">else</span> &#123;
                        isFileOk = <span class="hljs-number">0</span>;
                    &#125;
                    <span class="hljs-built_in">fclose</span>(file);
                &#125; <span class="hljs-keyword">else</span> &#123;
                    isFileOk = <span class="hljs-number">0</span>;
                &#125;
            &#125;

            <span class="hljs-keyword">if</span> (isFileOk) &#123;
                p_map = (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *) <span class="hljs-built_in">mmap</span>(<span class="hljs-number">0</span>, size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span class="hljs-number">0</span>);
            &#125;
            <span class="hljs-keyword">if</span> (p_map != MAP_FAILED &amp;&amp; <span class="hljs-literal">NULL</span> != p_map &amp;&amp; isFileOk) &#123;
                back = LOGAN_MMAP_MMAP;
            &#125; <span class="hljs-keyword">else</span> &#123;
                back = LOGAN_MMAP_MEMORY;
                <span class="hljs-built_in">printf_clogan</span>(<span class="hljs-string">&quot;open mmap fail , reason : %s \n&quot;</span>, <span class="hljs-built_in">strerror</span>(errno));

            &#125;
            <span class="hljs-built_in">close</span>(fd);

            <span class="hljs-keyword">if</span> (back == LOGAN_MMAP_MMAP &amp;&amp;
                <span class="hljs-built_in">access</span>(_filepath, F_OK) != <span class="hljs-number">-1</span>) &#123; <span class="hljs-comment">//在返回mmap前,做最后一道判断，如果有mmap文件才用mmap</span>
                back = LOGAN_MMAP_MMAP;
                *buffer = p_map;
            &#125; <span class="hljs-keyword">else</span> &#123;
                back = LOGAN_MMAP_MEMORY;
                <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> != p_map)
                    <span class="hljs-built_in">munmap</span>(p_map, size);
            &#125;
        &#125; <span class="hljs-keyword">else</span> &#123;
            <span class="hljs-built_in">printf_clogan</span>(<span class="hljs-string">&quot;open(%s) fail: %s\n&quot;</span>, _filepath, <span class="hljs-built_in">strerror</span>(errno));
        &#125;
    &#125;

    <span class="hljs-type">int</span> size = LOGAN_MEMORY_LENGTH;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *tempData = <span class="hljs-built_in">malloc</span>(size);
    <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> != tempData) &#123;
        <span class="hljs-built_in">memset</span>(tempData, <span class="hljs-number">0</span>, size);
        *cache = tempData;
        <span class="hljs-keyword">if</span> (back != LOGAN_MMAP_MMAP) &#123;
            *buffer = tempData;
            back = LOGAN_MMAP_MEMORY; <span class="hljs-comment">//如果文件打开失败、如果mmap映射失败，走内存缓存</span>
        &#125;
    &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-keyword">if</span> (back != LOGAN_MMAP_MMAP)
            back = LOGAN_MMAP_FAIL;
    &#125;
    <span class="hljs-keyword">return</span> back;
&#125;</code></pre></div>

<h3 id="flush-回写日志文件"><a href="#flush-回写日志文件" class="headerlink" title="flush 回写日志文件"></a>flush 回写日志文件</h3><p>因为有 buffer 的存在，<code>Logan.w(log, type)</code> 先将日志写入内存缓存，只有当缓存超过阈值（50K）时才回写文件系统，<code>Logan.f()</code> 使 buffer 立刻回写至文件系统</p>
<p>使用 <code>fopen</code>、<code>fseek</code>、<code>ftell</code>、<code>fwrite</code>、<code>fflush</code>、<code>fclose</code> 等高级 IO API，它们是具有缓存的</p>
<div class="code-wrapper"><pre><code class="hljs cpp">Logan.<span class="hljs-built_in">f</span>()
LoganControlCenter.<span class="hljs-built_in">flush</span>()
LoganThread.<span class="hljs-built_in">doFlushLog2File</span>()
LoganProtocol.<span class="hljs-built_in">logan_flush</span>()
CLoganProtocol.<span class="hljs-built_in">logan_flush</span>()
CLoganProtocol.<span class="hljs-built_in">clogan_flush</span>()
<span class="hljs-function">Java_com_dianping_logan_CLoganProtocol_clogan_1flush</span>
<span class="hljs-function">clogan_flush</span>
<span class="hljs-function"></span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">write_flush_clogan</span><span class="hljs-params">()</span> </span>&#123;
    <span class="hljs-keyword">if</span> (logan_model-&gt;zlib_type == LOGAN_ZLIB_ING) &#123;
        <span class="hljs-built_in">clogan_zlib_end_compress</span>(logan_model);
        <span class="hljs-built_in">update_length_clogan</span>(logan_model);
    &#125;
    <span class="hljs-keyword">if</span> (logan_model-&gt;total_len &gt; LOGAN_WRITEPROTOCOL_HEAER_LENGTH) &#123;
        <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *point = logan_model-&gt;total_point;
        point += LOGAN_MMAP_TOTALLEN;
        <span class="hljs-built_in">write_dest_clogan</span>(point, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">char</span>), logan_model-&gt;total_len, logan_model);
        <span class="hljs-built_in">printf_clogan</span>(<span class="hljs-string">&quot;write_flush_clogan &gt; logan total len : %d \n&quot;</span>, logan_model-&gt;total_len);
        <span class="hljs-built_in">clear_clogan</span>(logan_model);
    &#125;
&#125;

<span class="hljs-comment">//文件写入磁盘、更新文件大小</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">write_dest_clogan</span><span class="hljs-params">(<span class="hljs-type">void</span> *point, <span class="hljs-type">size_t</span> size, <span class="hljs-type">size_t</span> length, cLogan_model *loganModel)</span> </span>&#123;
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">is_file_exist_clogan</span>(loganModel-&gt;file_path)) &#123; <span class="hljs-comment">//如果文件被删除,再创建一个文件</span>
        <span class="hljs-keyword">if</span> (logan_model-&gt;file_stream_type == LOGAN_FILE_OPEN) &#123;
            <span class="hljs-built_in">fclose</span>(logan_model-&gt;file);
            logan_model-&gt;file_stream_type = LOGAN_FILE_CLOSE;
        &#125;
        <span class="hljs-keyword">if</span> (<span class="hljs-literal">NULL</span> != _dir_path) &#123;
            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">is_file_exist_clogan</span>(_dir_path)) &#123;
                <span class="hljs-built_in">makedir_clogan</span>(_dir_path);
            &#125;
            <span class="hljs-built_in">init_file_clogan</span>(logan_model);
            <span class="hljs-built_in">printf_clogan</span>(<span class="hljs-string">&quot;clogan_write &gt; create log file , restore open file stream \n&quot;</span>);
        &#125;
    &#125;
    <span class="hljs-keyword">if</span> (CLOGAN_EMPTY_FILE == loganModel-&gt;file_len) &#123; <span class="hljs-comment">//如果是空文件插入一行CLogan的头文件</span>
        <span class="hljs-built_in">insert_header_file_clogan</span>(loganModel);
    &#125;
    <span class="hljs-built_in">fwrite</span>(point, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">char</span>), logan_model-&gt;total_len, logan_model-&gt;file);<span class="hljs-comment">//写入到文件中</span>
    <span class="hljs-built_in">fflush</span>(logan_model-&gt;file);
    loganModel-&gt;file_len += loganModel-&gt;total_len; <span class="hljs-comment">//修改文件大小</span>
&#125;</code></pre></div>

<h3 id="日志文件"><a href="#日志文件" class="headerlink" title="日志文件"></a>日志文件</h3><p>日志文件保存在目录 <code>LoganConfig.Builder.setPath(path)</code>，日志按日期存储，文件名是日期当天零时零分零秒的 <code>时间戳</code></p>
<p><img src="../../../../image/2021-06-28-logan/files.png" srcset="/image/loading.gif" lazyload alt="files.png"></p>
<p>日志经过 gzip 压缩和 AES 加密，其格式是 JSON，每个日志文件的第一条总是 <code>clogan header</code></p>
<div class="code-wrapper"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span>
    <span class="hljs-attr">&quot;c&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;clogan header&quot;</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment">// 日志内容</span>
    <span class="hljs-attr">&quot;f&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span>                  <span class="hljs-comment">// flag，Logan.w(log, type) 中的 type 传入</span>
    <span class="hljs-attr">&quot;l&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;init&quot;</span><span class="hljs-punctuation">,</span>             <span class="hljs-comment">// local time，本地时间</span>
    <span class="hljs-attr">&quot;n&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;clogan&quot;</span><span class="hljs-punctuation">,</span>           <span class="hljs-comment">// thread name，线程名称</span>
    <span class="hljs-attr">&quot;i&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span>                  <span class="hljs-comment">// thread id，线程 ID</span>
    <span class="hljs-attr">&quot;m&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-keyword">true</span>                <span class="hljs-comment">// main thread，是否主线程</span>
<span class="hljs-punctuation">&#125;</span>
<span class="hljs-punctuation">&#123;</span>
    <span class="hljs-attr">&quot;c&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;I/Fridge-okhttp.OkHttpClient：[ (AndroidLog.kt:84)#androidLog$okhttp ] [ (AndroidLog.kt:39)#publish ] domain: video&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;f&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">4</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;l&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;2021-09-07 00:00:00.000&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;n&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;RxCachedThreadScheduler-15&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;i&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">174</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;m&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-keyword">false</span>
<span class="hljs-punctuation">&#125;</span>
<span class="hljs-punctuation">&#123;</span>
    <span class="hljs-attr">&quot;c&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;I/Fridge-okhttp.OkHttpClient：[ (AndroidLog.kt:84)#androidLog$okhttp ] [ (AndroidLog.kt:39)#publish ] Authorization_v1: U5xQjeKDh4Dkgx4Z&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;f&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">4</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;l&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;2021-09-07 00:00:00.001&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;n&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;RxCachedThreadScheduler-15&quot;</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;i&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">174</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">&quot;m&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-keyword">false</span>
<span class="hljs-punctuation">&#125;</span></code></pre></div>

<p>每次写日志时，都会判断下当前日期是否与日志文件的日期一致；如果不一致说明跨天了，创建当天的日志文件，并删除 <code>LoganConfig.Builder.setDay(long)</code> 前的日志文件</p>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LoganThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doWriteLog2File</span><span class="hljs-params">(WriteAction action)</span> &#123;
        <span class="hljs-keyword">if</span> (Logan.sDebug) &#123;
            Log.d(TAG, <span class="hljs-string">&quot;Logan write start&quot;</span>);
        &#125;
        <span class="hljs-keyword">if</span> (mFileDirectory == <span class="hljs-literal">null</span>) &#123;
            mFileDirectory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(mPath);
        &#125;

        <span class="hljs-keyword">if</span> (!isDay()) &#123;
            <span class="hljs-type">long</span> <span class="hljs-variable">tempCurrentDay</span> <span class="hljs-operator">=</span> Util.getCurrentTime();
            <span class="hljs-comment">//save时间</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">deleteTime</span> <span class="hljs-operator">=</span> tempCurrentDay - mSaveTime;
            deleteExpiredFile(deleteTime);
            mCurrentDay = tempCurrentDay;
            mLoganProtocol.logan_open(String.valueOf(mCurrentDay));
        &#125;

        <span class="hljs-type">long</span> <span class="hljs-variable">currentTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis(); <span class="hljs-comment">//每隔1分钟判断一次</span>
        <span class="hljs-keyword">if</span> (currentTime - mLastTime &gt; MINUTE) &#123;
            mIsSDCard = isCanWriteSDCard();
        &#125;
        mLastTime = System.currentTimeMillis();

        <span class="hljs-keyword">if</span> (!mIsSDCard) &#123; <span class="hljs-comment">//如果大于50M 不让再次写入</span>
            <span class="hljs-keyword">return</span>;
        &#125;
        mLoganProtocol.logan_write(action.flag, action.log, action.localTime, action.threadName,
                action.threadId, action.isMainThread);
    &#125;
&#125;</code></pre></div>

<h3 id="写入失败"><a href="#写入失败" class="headerlink" title="写入失败"></a>写入失败</h3><p>有以下原因会导致日志写入失败：</p>
<ol>
<li>日志内容为空</li>
</ol>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LoganControlCenter</span> &#123;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">write</span><span class="hljs-params">(String log, <span class="hljs-type">int</span> flag)</span> &#123;
        <span class="hljs-keyword">if</span> (TextUtils.isEmpty(log)) &#123;
            <span class="hljs-keyword">return</span>;
        &#125;
        <span class="hljs-comment">// ...</span>
    &#125;
&#125;</code></pre></div>

<ol start="2">
<li>任务队列满了</li>
</ol>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LoganControlCenter</span> &#123;

    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> mMaxQueue;     <span class="hljs-comment">// 最大队列数</span>

    <span class="hljs-keyword">private</span> <span class="hljs-title function_">LoganControlCenter</span><span class="hljs-params">(LoganConfig config)</span> &#123;
        <span class="hljs-keyword">if</span> (!config.isValid()) &#123;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>(<span class="hljs-string">&quot;config&#x27;s param is invalid&quot;</span>);
        &#125;
        mPath = config.mPathPath;
        mCachePath = config.mCachePath;
        mSaveTime = config.mDay;
        mMinSDCard = config.mMinSDCard;
        mMaxLogFile = config.mMaxFile;
        mMaxQueue = config.mMaxQueue;
        mEncryptKey16 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(config.mEncryptKey16);
        mEncryptIv16 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(config.mEncryptIv16);
        init();
    &#125;

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">write</span><span class="hljs-params">(String log, <span class="hljs-type">int</span> flag)</span> &#123;
        <span class="hljs-comment">// ...</span>
        <span class="hljs-keyword">if</span> (mCacheLogQueue.size() &lt; mMaxQueue) &#123;
            mCacheLogQueue.add(model);
            <span class="hljs-keyword">if</span> (mLoganThread != <span class="hljs-literal">null</span>) &#123;
                mLoganThread.notifyRun();
            &#125;
        &#125;
    &#125;
&#125;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoganConfig</span> &#123;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">DEFAULT_QUEUE</span> <span class="hljs-operator">=</span> <span class="hljs-number">500</span>;

    <span class="hljs-type">long</span> <span class="hljs-variable">mMaxQueue</span> <span class="hljs-operator">=</span> DEFAULT_QUEUE;     <span class="hljs-comment">// 没有公开 getter/setter</span>
&#125;</code></pre></div>

<ol start="3">
<li>存储设备容量不足（默认至少 50M）</li>
</ol>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LoganThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;

    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> mMinSDCard;

    LoganThread(
            ConcurrentLinkedQueue&lt;LoganModel&gt; cacheLogQueue, String cachePath,
            String path, <span class="hljs-type">long</span> saveTime, <span class="hljs-type">long</span> maxLogFile, <span class="hljs-type">long</span> minSDCard, String encryptKey16,
            String encryptIv16) &#123;
        mCacheLogQueue = cacheLogQueue;
        mCachePath = cachePath;
        mPath = path;
        mSaveTime = saveTime;
        mMaxLogFile = maxLogFile;
        mMinSDCard = minSDCard;
        mEncryptKey16 = encryptKey16;
        mEncryptIv16 = encryptIv16;
    &#125;    

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doWriteLog2File</span><span class="hljs-params">(WriteAction action)</span> &#123;
        <span class="hljs-comment">// ...</span>

        <span class="hljs-type">long</span> <span class="hljs-variable">currentTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis(); <span class="hljs-comment">//每隔1分钟判断一次</span>
        <span class="hljs-keyword">if</span> (currentTime - mLastTime &gt; MINUTE) &#123;
            mIsSDCard = isCanWriteSDCard();
        &#125;
        mLastTime = System.currentTimeMillis();

        <span class="hljs-keyword">if</span> (!mIsSDCard) &#123; <span class="hljs-comment">//如果大于50M 不让再次写入</span>
            <span class="hljs-keyword">return</span>;
        &#125;
        mLoganProtocol.logan_write(action.flag, action.log, action.localTime, action.threadName,
                action.threadId, action.isMainThread);
    &#125;

    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCanWriteSDCard</span><span class="hljs-params">()</span> &#123;
        <span class="hljs-type">boolean</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-type">StatFs</span> <span class="hljs-variable">stat</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StatFs</span>(mPath);
            <span class="hljs-type">long</span> <span class="hljs-variable">blockSize</span> <span class="hljs-operator">=</span> stat.getBlockSize();
            <span class="hljs-type">long</span> <span class="hljs-variable">availableBlocks</span> <span class="hljs-operator">=</span> stat.getAvailableBlocks();
            <span class="hljs-type">long</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> availableBlocks * blockSize;
            <span class="hljs-keyword">if</span> (total &gt; mMinSDCard) &#123; <span class="hljs-comment">//判断SDK卡</span>
                item = <span class="hljs-literal">true</span>;
            &#125;
        &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;
            e.printStackTrace();
        &#125;
        <span class="hljs-keyword">return</span> item;
    &#125;    
&#125;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoganConfig</span> &#123;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">M</span> <span class="hljs-operator">=</span> <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;                  <span class="hljs-comment">// M</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">DEFAULT_MIN_SDCARD_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">50</span> * M; <span class="hljs-comment">// 最小的 SD 卡小于这个大小不写入</span>

    <span class="hljs-type">long</span> <span class="hljs-variable">mMinSDCard</span> <span class="hljs-operator">=</span> DEFAULT_MIN_SDCARD_SIZE;                  <span class="hljs-comment">// 最小 sd 卡大小，通过 LoganConfig.Builder#setMinSDCard 配置</span>
&#125;</code></pre></div>

<ol start="4">
<li>日志文件大小超过限制</li>
</ol>
<p>默认 10M，<code>LoganConfig</code> 未公开 setter</p>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoganConfig</span> &#123;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">M</span> <span class="hljs-operator">=</span> <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>; <span class="hljs-comment">//M</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">DEFAULT_FILE_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span> * M;

    <span class="hljs-type">long</span> <span class="hljs-variable">mMaxFile</span> <span class="hljs-operator">=</span> DEFAULT_FILE_SIZE; <span class="hljs-comment">// 删除文件最大值（实际并不会删除，只是不再写入）</span>
&#125;</code></pre></div>

<div class="code-wrapper"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOGAN_LOGFILE_MAXLENGTH 10 * 1024 * 1024</span>

<span class="hljs-type">static</span> <span class="hljs-type">long</span> max_file_len = LOGAN_LOGFILE_MAXLENGTH;

<span class="hljs-function"><span class="hljs-type">int</span></span>
<span class="hljs-function"><span class="hljs-title">clogan_write</span><span class="hljs-params">(<span class="hljs-type">int</span> flag, <span class="hljs-type">char</span> *log, <span class="hljs-type">long</span> <span class="hljs-type">long</span> local_time, <span class="hljs-type">char</span> *thread_name, <span class="hljs-type">long</span> <span class="hljs-type">long</span> thread_id,</span></span>
<span class="hljs-params"><span class="hljs-function">             <span class="hljs-type">int</span> is_main)</span> </span>&#123;
    <span class="hljs-comment">// ...</span>

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">is_file_exist_clogan</span>(logan_model-&gt;file_path)) &#123;
        <span class="hljs-keyword">if</span> (logan_model-&gt;file_len &gt; max_file_len) &#123;
            <span class="hljs-built_in">printf_clogan</span>(<span class="hljs-string">&quot;clogan_write &gt; beyond max file , cant write log\n&quot;</span>);
            back = CLOAGN_WRITE_FAIL_MAXFILE;
            <span class="hljs-keyword">return</span> back;
        &#125;
    &#125;

    <span class="hljs-comment">// ...</span>
&#125;</code></pre></div>

<h3 id="公司内部日志库-VLog"><a href="#公司内部日志库-VLog" class="headerlink" title="公司内部日志库 VLog"></a>公司内部日志库 VLog</h3><p>VLog 使用 Logan 来持久化 <code>Android.util.Log</code> 的日志输出，以便下发指令远程抓取用户日志，通过 gradle plugin Transform 和 ASM 将 <code>Log.XXX</code> 替换为 <code>VLog.XXX</code>，从而达到透明重定向日志输出的目的</p>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LogHandleTransform</span>(project: Project, ext: LogExtension?) : Transform() &#123;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> classProcessor: ClassProcessor = ClassProcessor()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> logExtension: LogExtension? = ext

    override fun <span class="hljs-title function_">getName</span><span class="hljs-params">()</span>: String &#123;
        <span class="hljs-keyword">return</span> NAME
    &#125;

    override fun <span class="hljs-title function_">getInputTypes</span><span class="hljs-params">()</span>: MutableSet&lt;QualifiedContent.ContentType&gt; &#123;
        <span class="hljs-keyword">return</span> TransformManager.CONTENT_CLASS
    &#125;

    override fun <span class="hljs-title function_">getScopes</span><span class="hljs-params">()</span>: MutableSet&lt;in QualifiedContent.Scope&gt; &#123;
        <span class="hljs-keyword">return</span> TransformManager.SCOPE_FULL_PROJECT
    &#125;

    override fun <span class="hljs-title function_">isIncremental</span><span class="hljs-params">()</span>: Boolean &#123;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    &#125;

    <span class="hljs-comment">/**</span>
<span class="hljs-comment">     * NOTCHANGED: 当前文件不需处理，甚至复制操作都不用</span>
<span class="hljs-comment">     * ADDED、CHANGED: 正常处理，输出给下一个任务</span>
<span class="hljs-comment">     * REMOVED: 移除outputProvider获取路径对应的文件</span>
<span class="hljs-comment">     */</span>
    override fun <span class="hljs-title function_">transform</span><span class="hljs-params">(transformInvocation: TransformInvocation)</span> &#123;
        <span class="hljs-built_in">super</span>.transform(transformInvocation)
        <span class="hljs-type">val</span> <span class="hljs-variable">inputs</span> <span class="hljs-operator">=</span> transformInvocation.inputs
        <span class="hljs-type">val</span> <span class="hljs-variable">outputProvider</span> <span class="hljs-operator">=</span> transformInvocation.outputProvider
        <span class="hljs-type">val</span> <span class="hljs-variable">isIncremental</span> <span class="hljs-operator">=</span> transformInvocation.isIncremental
        <span class="hljs-comment">//如果非增量，则清空旧的输出内容</span>
        <span class="hljs-keyword">if</span> (!isIncremental) &#123;
            outputProvider.deleteAll()
        &#125;
        Logger.w(<span class="hljs-string">&quot;isIncremental: $isIncremental&quot;</span>)
        inputs.stream().forEach &#123; transformInput: TransformInput -&gt;
            <span class="hljs-comment">//jar</span>
            transformInput.jarInputs.stream().forEach &#123; jarInput: JarInput -&gt;
                <span class="hljs-type">val</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> jarInput.status
                val src: File = jarInput.file
                <span class="hljs-type">var</span> <span class="hljs-variable">destName</span> <span class="hljs-operator">=</span> src.name
                <span class="hljs-title function_">if</span> <span class="hljs-params">(destName.endsWith(<span class="hljs-string">&quot;.jar&quot;</span>)</span>) &#123;
                    destName = destName.substring(<span class="hljs-number">0</span>, destName.length - <span class="hljs-number">4</span>);
                &#125;
                <span class="hljs-type">val</span> <span class="hljs-variable">hexName</span> <span class="hljs-operator">=</span> DigestUtils.md5Hex(src.absolutePath)
                val dest: File =
                    transformInvocation.outputProvider.getContentLocation(
                        <span class="hljs-comment">//destName + &quot;_&quot; + hexName,</span>
                        jarInput.name,
                        jarInput.contentTypes,
                        jarInput.scopes,
                        Format.JAR
                    )
                Logger.w(<span class="hljs-string">&quot;jar origin path: $&#123;src.absolutePath&#125;, jar output path: $&#123;dest.absolutePath&#125;, jar status $&#123;status.name&#125;&quot;</span>)
                <span class="hljs-keyword">if</span> (status == <span class="hljs-literal">null</span> || !isIncremental) &#123;
                    processJar(src, dest)
                &#125; <span class="hljs-keyword">else</span> &#123;
                    when (status) &#123;
                        Status.NOTCHANGED -&gt; &#123;
                            <span class="hljs-comment">//nothing</span>
                        &#125;
                        Status.ADDED, Status.CHANGED -&gt; &#123;
                            processJar(jarInput.file, dest)
                        &#125;
                        Status.REMOVED -&gt; <span class="hljs-keyword">if</span> (dest.exists()) &#123;
                            <span class="hljs-comment">//delete dest</span>
                            FileUtils.forceDelete(dest)
                        &#125;
                    &#125;
                &#125;
            &#125;
            <span class="hljs-comment">//dir</span>
            transformInput.directoryInputs.stream().forEach &#123; directoryInput: DirectoryInput -&gt;
                val src: File = directoryInput.file
                val dest: File =
                    transformInvocation.outputProvider.getContentLocation(
                        directoryInput.name,
                        directoryInput.contentTypes,
                        directoryInput.scopes,
                        Format.DIRECTORY
                    )
                Logger.w(<span class="hljs-string">&quot;dir origin path: $&#123;src.absolutePath&#125;, dir output path: $&#123;dest.absolutePath&#125;&quot;</span>)
                <span class="hljs-keyword">if</span> (isIncremental) &#123;
                    <span class="hljs-type">val</span> <span class="hljs-variable">srcDirPath</span> <span class="hljs-operator">=</span> src.absolutePath
                    <span class="hljs-type">val</span> <span class="hljs-variable">destDirPath</span> <span class="hljs-operator">=</span> dest.absolutePath
                    <span class="hljs-type">val</span> <span class="hljs-variable">fileStatusMap</span> <span class="hljs-operator">=</span> directoryInput.changedFiles
                    <span class="hljs-comment">//Logger.w(&quot;dir change file: $fileStatusMap&quot;)</span>
                    <span class="hljs-keyword">for</span> ((inputFile: File, status: Status) in fileStatusMap) &#123;
                        val destFilePath: String =
                            inputFile.absolutePath.replace(srcDirPath, destDirPath)
                        <span class="hljs-comment">//Logger.w(&quot;incremental dir handle origin file: $&#123;inputFile.absolutePath&#125;, dir output path: $destFilePath&quot;)</span>
                        <span class="hljs-type">val</span> <span class="hljs-variable">destFile</span> <span class="hljs-operator">=</span> File(destFilePath)
                        when (status) &#123;
                            Status.NOTCHANGED -&gt; &#123;
                                <span class="hljs-comment">//nothing</span>
                            &#125;
                            Status.REMOVED -&gt; <span class="hljs-keyword">if</span> (destFile.exists()) &#123;
                                <span class="hljs-comment">//delete dest</span>
                                FileUtils.forceDelete(destFile)
                            &#125;
                            Status.ADDED, Status.CHANGED -&gt; &#123;
                                FileUtils.touch(destFile)
                                <span class="hljs-comment">//例如/intermediates/transforms/ASMPLUGIN/debug/235/META-INF</span>
                                <span class="hljs-keyword">if</span> (inputFile.isDirectory) &#123;
                                    handleDirectoryInput(
                                        inputFile,
                                        dest,
                                        src.absolutePath
                                    )
                                &#125; <span class="hljs-keyword">else</span> &#123;
                                    <span class="hljs-keyword">if</span> (inputFile.name.endsWith(<span class="hljs-string">&quot;.class&quot;</span>)) &#123;
                                        processClassFile(inputFile, destFile)
                                    &#125; <span class="hljs-keyword">else</span> &#123;
                                        FileUtils.copyFile(inputFile, destFile)
                                    &#125;
                                &#125;
                            &#125;
                        &#125;
                    &#125;
                &#125; <span class="hljs-keyword">else</span> &#123;
                    handleDirectoryInput(src, dest, src.absolutePath)
                &#125;
                <span class="hljs-comment">//直接复制</span>
                <span class="hljs-comment">//FileUtils.copyDirectory(directoryInput.file, dest)</span>
            &#125;
        &#125;
    &#125;

    <span class="hljs-keyword">private</span> fun <span class="hljs-title function_">handleDirectoryInput</span><span class="hljs-params">(file: File, targetDirFile: File, relativePath: String)</span> &#123;
        <span class="hljs-keyword">if</span> (file.isDirectory) &#123;
            <span class="hljs-keyword">for</span> (f in file.listFiles()) &#123;
                handleDirectoryInput(f, targetDirFile, relativePath)
            &#125;
        &#125; <span class="hljs-keyword">else</span> &#123;
            val targetPath: String =
                file.absolutePath.replace(relativePath, targetDirFile.absolutePath)
            <span class="hljs-type">val</span> <span class="hljs-variable">targetFile</span> <span class="hljs-operator">=</span> File(targetPath)
            <span class="hljs-comment">//Logger.w(&quot;handleDirectoryInput targetDir: $&#123;targetDirFile.absolutePath&#125;, origin file: $&#123;file.absolutePath&#125;, output file: $targetPath&quot;)</span>
            <span class="hljs-keyword">if</span> (file.name.endsWith(<span class="hljs-string">&quot;.class&quot;</span>)) &#123;
                processClassFile(file, targetFile)
            &#125; <span class="hljs-keyword">else</span> &#123;
                <span class="hljs-type">val</span> <span class="hljs-variable">destFile</span> <span class="hljs-operator">=</span> File(targetPath)
                FileUtils.copyFile(file, destFile)
            &#125;
        &#125;
    &#125;

    <span class="hljs-keyword">private</span> fun <span class="hljs-title function_">processClassFile</span><span class="hljs-params">(src: File, targetFile: File)</span> &#123;
        <span class="hljs-keyword">var</span> bytes: ByteArray? = <span class="hljs-literal">null</span>
        <span class="hljs-keyword">try</span> &#123;
            bytes = classProcessor.process(FileUtils.readFileToByteArray(src))
        &#125; <span class="hljs-keyword">catch</span> (e: IOException) &#123;
            e.printStackTrace()
        &#125;
        <span class="hljs-keyword">if</span> (!targetFile.parentFile.exists()) &#123;
            targetFile.parentFile.mkdirs()
        &#125;
        <span class="hljs-keyword">try</span> &#123;
            FileUtils.writeByteArrayToFile(targetFile, bytes)
        &#125; <span class="hljs-keyword">catch</span> (e: IOException) &#123;
            e.printStackTrace()
        &#125;
    &#125;

    <span class="hljs-keyword">private</span> fun <span class="hljs-title function_">processJar</span><span class="hljs-params">(zipFile: File, destFile: File)</span> &#123;
        <span class="hljs-type">val</span> <span class="hljs-variable">zos</span> <span class="hljs-operator">=</span> ZipOutputStream(FileOutputStream(destFile))
        <span class="hljs-type">val</span> <span class="hljs-variable">zis</span> <span class="hljs-operator">=</span> JarFile(zipFile)
        val enumeration: Enumeration&lt;JarEntry&gt; = zis.entries()
        <span class="hljs-keyword">while</span> (enumeration.hasMoreElements()) &#123;
            val jarEntry: JarEntry = enumeration.nextElement() as JarEntry
            val entryName: String = jarEntry.name
            <span class="hljs-comment">//Logger.w(&quot;jar content name: $entryName&quot;)</span>
            <span class="hljs-keyword">if</span> (jarEntry.isDirectory) <span class="hljs-keyword">continue</span>
            <span class="hljs-comment">//为新的jar创建zipEntry</span>
            <span class="hljs-type">val</span> <span class="hljs-variable">zipEntry</span> <span class="hljs-operator">=</span> ZipEntry(entryName)
            zos.putNextEntry(zipEntry)
            val inputStream: InputStream = zis.getInputStream(jarEntry)
            <span class="hljs-comment">//inputStream to byte，我看bytex也是用的这个</span>
            val src: ByteArray = ByteStreams.toByteArray(inputStream)
            <span class="hljs-comment">//com/viomi/vlog此包下面的类不处理，Logan库里面的Log也不处理</span>
            <span class="hljs-keyword">if</span> (needHandle(entryName)) &#123;
                val bytes: ByteArray = classProcessor.process(src)
                zos.write(bytes)
            &#125; <span class="hljs-keyword">else</span> &#123;
                zos.write(src)
            &#125;
            zos.closeEntry()
            inputStream.close()
        &#125;
        zis.close()
        zos.close()
    &#125;

    <span class="hljs-keyword">private</span> fun <span class="hljs-title function_">needHandle</span><span class="hljs-params">(entryName: String)</span>: Boolean &#123;
        <span class="hljs-keyword">if</span> (!entryName.endsWith(<span class="hljs-string">&quot;.class&quot;</span>)) &#123;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        &#125;
        <span class="hljs-keyword">if</span> (entryName.contains(LOG_LIB_PKG) || entryName.contains(LOGAN_LIB_PKG)) &#123;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        &#125;
        <span class="hljs-type">var</span> <span class="hljs-variable">handle</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
        logExtension?.let &#123;
            <span class="hljs-keyword">for</span> (name in logExtension!!.whiteList) &#123;
                <span class="hljs-keyword">if</span> (entryName.contains(LogExtension.transform(name))) &#123;
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
                &#125;
            &#125;
        &#125;
        <span class="hljs-keyword">return</span> handle
    &#125;
&#125;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassProcessor</span> &#123;
    fun <span class="hljs-title function_">process</span><span class="hljs-params">(src: ByteArray)</span>: ByteArray &#123;
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-type">val</span> <span class="hljs-variable">classReader</span> <span class="hljs-operator">=</span> ClassReader(src)
            <span class="hljs-type">val</span> <span class="hljs-variable">cw</span> <span class="hljs-operator">=</span> ClassWriter(classReader, ClassWriter.COMPUTE_MAXS)
            <span class="hljs-type">val</span> <span class="hljs-variable">monitorClassVisitor</span> <span class="hljs-operator">=</span> LogClassVisitor(ASM_API, cw)
            classReader.accept(monitorClassVisitor, ClassReader.EXPAND_FRAMES)
            <span class="hljs-keyword">return</span> cw.toByteArray()
        &#125; <span class="hljs-keyword">catch</span> (e: MethodCallOptException) &#123;
            <span class="hljs-keyword">return</span> src
        &#125;
    &#125;
&#125;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">LogClassVisitor</span>(api: Int, cv: ClassVisitor) : ClassVisitor(api, cv) &#123;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> className: String? = <span class="hljs-literal">null</span>

    override fun <span class="hljs-title function_">visit</span><span class="hljs-params">(</span>
<span class="hljs-params">        version: Int,</span>
<span class="hljs-params">        access: Int,</span>
<span class="hljs-params">        name: String?,</span>
<span class="hljs-params">        signature: String?,</span>
<span class="hljs-params">        superName: String?,</span>
<span class="hljs-params">        interfaces: Array&lt;out String&gt;?</span>
<span class="hljs-params">    )</span> &#123;
        <span class="hljs-built_in">super</span>.visit(version, access, name, signature, superName, interfaces)
        className = name
    &#125;

    override fun <span class="hljs-title function_">visitMethod</span><span class="hljs-params">(</span>
<span class="hljs-params">        access: Int,</span>
<span class="hljs-params">        name: String?,</span>
<span class="hljs-params">        desc: String?,</span>
<span class="hljs-params">        signature: String?,</span>
<span class="hljs-params">        exceptions: Array&lt;out String&gt;?</span>
<span class="hljs-params">    )</span>: MethodVisitor &#123;
        val methodVisitor: MethodVisitor =
            <span class="hljs-built_in">super</span>.visitMethod(access, name, desc, signature, exceptions)
        <span class="hljs-keyword">return</span> MethodVisit(methodVisitor, className, ASM_API, access, name, desc)
    &#125;

    <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodVisit</span>(
        methodVisitor: MethodVisitor,
        className: String?,
        api: Int,
        access: Int,
        name: String?,
        desc: String?
    ) : AdviceAdapter(api, methodVisitor, access, name, desc) &#123;

        override fun <span class="hljs-title function_">visitMethodInsn</span><span class="hljs-params">(</span>
<span class="hljs-params">            opcode: Int,</span>
<span class="hljs-params">            owner: String,</span>
<span class="hljs-params">            name: String,</span>
<span class="hljs-params">            descriptor: String,</span>
<span class="hljs-params">            isInterface: Boolean</span>
<span class="hljs-params">        )</span> &#123;
            val ext: LogExt? = LogExt.needRep(owner, name, descriptor)
            <span class="hljs-keyword">if</span> (ext != <span class="hljs-literal">null</span>) &#123;
                <span class="hljs-built_in">super</span>.visitMethodInsn(opcode, LOG_LIB_CLASS, name, descriptor, isInterface)
            &#125; <span class="hljs-keyword">else</span> &#123;
                <span class="hljs-built_in">super</span>.visitMethodInsn(opcode, owner, name, descriptor, isInterface)
            &#125;
        &#125;
    &#125;
&#125;</code></pre></div>

<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li>如果需要在没有 server 的情况下解压/解密，可以使用 <a target="_blank" rel="noopener" href="https://github.com/Meituan-Dianping/Logan/issues/351#issue-909155178">这个 Python 脚本</a></li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/log/">#log</a>
      
        <a href="/tags/logcat/">#logcat</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/07/05/mp4-structure/" title="MP4 文件结构浅析">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">MP4 文件结构浅析</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/06/22/xcrash/" title="崩溃日志收集库 xCrash 浅析">
                        <span class="hidden-mobile">崩溃日志收集库 xCrash 浅析</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
