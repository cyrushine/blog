

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;dark&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/image/favicon.png">
  <link rel="icon" href="/image/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Cyrus">
  <meta name="keywords" content="">
  
  <title>崩溃日志收集库 xCrash 浅析 - Cyrus Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/docco.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->

  
<link rel="stylesheet" href="/css/custom.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"www.dalvik.work","root":"/","version":"1.8.11","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":99},"lazyload":{"enable":true,"loading_img":"/image/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":"7d0c9146781b5fb9ae68cfc826d0be54","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 60vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Cyrus Blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/image/sunset_sea.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="崩溃日志收集库 xCrash 浅析">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-06-22 04:00" pubdate>
        2021年6月22日
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      11.2k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      204
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">崩溃日志收集库 xCrash 浅析</h1>
            
            <div class="markdown-body">
              <p><a target="_blank" rel="noopener" href="https://github.com/iqiyi/xCrash">xCrash</a> 是爱奇艺团队开源的一款崩溃日志收集库，可以收集 <strong>java crash</strong>、<strong>native crash</strong> 和 <strong>ANR</strong> 日志</p>
<p>日志格式为专用格式，内容还算丰富：<strong>机器信息</strong>、<strong>崩溃线程和其他线程的方法栈</strong>、<strong>logcat</strong>、<strong>打开的 fd</strong> 等等 …</p>
<h2 id="Java-Crash"><a href="#Java-Crash" class="headerlink" title="Java Crash"></a>Java Crash</h2><p>捕获 Java Crash 用的是 <code>DefaultUncaughtExceptionHandler</code>，相关的基础知识参考 <a href="../../../../2021/06/18/uncaught-exception-handler/">Uncaught Exception Handling</a></p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JavaCrashHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UncaughtExceptionHandler</span> </span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">uncaughtException</span><span class="hljs-params">(Thread thread, Throwable throwable)</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (defaultHandler != <span class="hljs-keyword">null</span>) &#123;<br>            Thread.setDefaultUncaughtExceptionHandler(defaultHandler);<br>        &#125;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            handleException(thread, throwable);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            XCrash.getLogger().e(Util.TAG, <span class="hljs-string">&quot;JavaCrashHandler handleException failed&quot;</span>, e);<br>        &#125;<br><br>        <span class="hljs-comment">// 可以选择重新抛出给上一个 handler，或者杀死 app</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.rethrow) &#123;<br>            <span class="hljs-keyword">if</span> (defaultHandler != <span class="hljs-keyword">null</span>) &#123;<br>                defaultHandler.uncaughtException(thread, throwable);<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            ActivityMonitor.getInstance().finishAllActivities();<br>            Process.killProcess(<span class="hljs-keyword">this</span>.pid);<br>            System.exit(<span class="hljs-number">10</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 收集各种各样的信息，写入到日志文件</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleException</span><span class="hljs-params">(Thread thread, Throwable throwable)</span> </span>&#123;<br>        Date crashTime = <span class="hljs-keyword">new</span> Date();<br><br>        <span class="hljs-comment">//notify the java crash</span><br>        NativeHandler.getInstance().notifyJavaCrashed();<br>        AnrHandler.getInstance().notifyJavaCrashed();<br><br>        <span class="hljs-comment">//create log file</span><br>        File logFile = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            String logPath = String.format(Locale.US, <span class="hljs-string">&quot;%s/%s_%020d_%s__%s%s&quot;</span>, logDir, Util.logPrefix, startTime.getTime() * <span class="hljs-number">1000</span>, appVersion, processName, Util.javaLogSuffix);<br>            logFile = FileManager.getInstance().createLogFile(logPath);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            XCrash.getLogger().e(Util.TAG, <span class="hljs-string">&quot;JavaCrashHandler createLogFile failed&quot;</span>, e);<br>        &#125;<br><br>        <span class="hljs-comment">//get emergency</span><br>        String emergency = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            emergency = getEmergency(crashTime, thread, throwable);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            XCrash.getLogger().e(Util.TAG, <span class="hljs-string">&quot;JavaCrashHandler getEmergency failed&quot;</span>, e);<br>        &#125;<br><br>        <span class="hljs-comment">//write info to log file</span><br>        <span class="hljs-keyword">if</span> (logFile != <span class="hljs-keyword">null</span>) &#123;<br>            RandomAccessFile raf = <span class="hljs-keyword">null</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                raf = <span class="hljs-keyword">new</span> RandomAccessFile(logFile, <span class="hljs-string">&quot;rws&quot;</span>);<br><br>                <span class="hljs-comment">//write emergency info</span><br>                <span class="hljs-keyword">if</span> (emergency != <span class="hljs-keyword">null</span>) &#123;<br>                    raf.write(emergency.getBytes(<span class="hljs-string">&quot;UTF-8&quot;</span>));<br>                &#125;<br><br>                <span class="hljs-comment">//If we wrote the emergency info successfully, we don&#x27;t need to return it from callback again.</span><br>                emergency = <span class="hljs-keyword">null</span>;<br><br>                <span class="hljs-comment">//write logcat</span><br>                <span class="hljs-keyword">if</span> (logcatMainLines &gt; <span class="hljs-number">0</span> || logcatSystemLines &gt; <span class="hljs-number">0</span> || logcatEventsLines &gt; <span class="hljs-number">0</span>) &#123;<br>                    raf.write(Util.getLogcat(logcatMainLines, logcatSystemLines, logcatEventsLines).getBytes(<span class="hljs-string">&quot;UTF-8&quot;</span>));<br>                &#125;<br><br>                <span class="hljs-comment">//write fds</span><br>                <span class="hljs-keyword">if</span> (dumpFds) &#123;<br>                    raf.write(Util.getFds().getBytes(<span class="hljs-string">&quot;UTF-8&quot;</span>));<br>                &#125;<br><br>                <span class="hljs-comment">//write network info</span><br>                <span class="hljs-keyword">if</span> (dumpNetworkInfo) &#123;<br>                    raf.write(Util.getNetworkInfo().getBytes(<span class="hljs-string">&quot;UTF-8&quot;</span>));<br>                &#125;<br><br>                <span class="hljs-comment">//write memory info</span><br>                raf.write(Util.getMemoryInfo().getBytes(<span class="hljs-string">&quot;UTF-8&quot;</span>));<br><br>                <span class="hljs-comment">//write background / foreground</span><br>                raf.write((<span class="hljs-string">&quot;foreground:\n&quot;</span> + (ActivityMonitor.getInstance().isApplicationForeground() ? <span class="hljs-string">&quot;yes&quot;</span> : <span class="hljs-string">&quot;no&quot;</span>) + <span class="hljs-string">&quot;\n\n&quot;</span>).getBytes(<span class="hljs-string">&quot;UTF-8&quot;</span>));<br><br>                <span class="hljs-comment">//write other threads info</span><br>                <span class="hljs-keyword">if</span> (dumpAllThreads) &#123;<br>                    raf.write(getOtherThreadsInfo(thread).getBytes(<span class="hljs-string">&quot;UTF-8&quot;</span>));<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                XCrash.getLogger().e(Util.TAG, <span class="hljs-string">&quot;JavaCrashHandler write log file failed&quot;</span>, e);<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-keyword">if</span> (raf != <span class="hljs-keyword">null</span>) &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        raf.close();<br>                    &#125; <span class="hljs-keyword">catch</span> (Exception ignored) &#123;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//callback</span><br>        <span class="hljs-keyword">if</span> (callback != <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                callback.onCrash(logFile == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">null</span> : logFile.getAbsolutePath(), emergency);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception ignored) &#123;<br>            &#125;<br>        &#125;<br>    &#125;        <br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h3><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getEmergency</span><span class="hljs-params">(Date crashTime, Thread thread, Throwable throwable)</span> </span>&#123;<br>    <span class="hljs-comment">//stack stace</span><br>    StringWriter sw = <span class="hljs-keyword">new</span> StringWriter();<br>    PrintWriter pw = <span class="hljs-keyword">new</span> PrintWriter(sw);<br>    throwable.printStackTrace(pw);<br>    String stacktrace = sw.toString();<br>    <span class="hljs-keyword">return</span> Util.getLogHeader(startTime, crashTime, Util.javaCrashType, appId, appVersion)<br>            + <span class="hljs-string">&quot;pid: &quot;</span> + pid + <span class="hljs-string">&quot;, tid: &quot;</span> + Process.myTid() + <span class="hljs-string">&quot;, name: &quot;</span> + thread.getName() + <span class="hljs-string">&quot;  &gt;&gt;&gt; &quot;</span> + processName + <span class="hljs-string">&quot; &lt;&lt;&lt;\n&quot;</span><br>            + <span class="hljs-string">&quot;\n&quot;</span><br>            + <span class="hljs-string">&quot;java stacktrace:\n&quot;</span><br>            + stacktrace<br>            + <span class="hljs-string">&quot;\n&quot;</span><br>            + getBuildId(stacktrace);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> String <span class="hljs-title">getLogHeader</span><span class="hljs-params">(Date startTime, Date crashTime, String crashType, String appId, String appVersion)</span> </span>&#123;<br>    DateFormat timeFormatter = <span class="hljs-keyword">new</span> SimpleDateFormat(Util.timeFormatterStr, Locale.US);<br>    <span class="hljs-keyword">return</span> Util.sepHead + <span class="hljs-string">&quot;\n&quot;</span><br>        + <span class="hljs-string">&quot;Tombstone maker: &#x27;&quot;</span> + Version.fullVersion + <span class="hljs-string">&quot;&#x27;\n&quot;</span><br>        + <span class="hljs-string">&quot;Crash type: &#x27;&quot;</span> + crashType + <span class="hljs-string">&quot;&#x27;\n&quot;</span><br>        + <span class="hljs-string">&quot;Start time: &#x27;&quot;</span> + timeFormatter.format(startTime) + <span class="hljs-string">&quot;&#x27;\n&quot;</span><br>        + <span class="hljs-string">&quot;Crash time: &#x27;&quot;</span> + timeFormatter.format(crashTime) + <span class="hljs-string">&quot;&#x27;\n&quot;</span><br>        + <span class="hljs-string">&quot;App ID: &#x27;&quot;</span> + appId + <span class="hljs-string">&quot;&#x27;\n&quot;</span><br>        + <span class="hljs-string">&quot;App version: &#x27;&quot;</span> + appVersion + <span class="hljs-string">&quot;&#x27;\n&quot;</span><br>        + <span class="hljs-string">&quot;Rooted: &#x27;&quot;</span> + (Util.isRoot() ? <span class="hljs-string">&quot;Yes&quot;</span> : <span class="hljs-string">&quot;No&quot;</span>) + <span class="hljs-string">&quot;&#x27;\n&quot;</span><br>        + <span class="hljs-string">&quot;API level: &#x27;&quot;</span> + Build.VERSION.SDK_INT + <span class="hljs-string">&quot;&#x27;\n&quot;</span><br>        + <span class="hljs-string">&quot;OS version: &#x27;&quot;</span> + Build.VERSION.RELEASE + <span class="hljs-string">&quot;&#x27;\n&quot;</span><br>        + <span class="hljs-string">&quot;ABI list: &#x27;&quot;</span> + Util.getAbiList() + <span class="hljs-string">&quot;&#x27;\n&quot;</span><br>        + <span class="hljs-string">&quot;Manufacturer: &#x27;&quot;</span> + Build.MANUFACTURER + <span class="hljs-string">&quot;&#x27;\n&quot;</span><br>        + <span class="hljs-string">&quot;Brand: &#x27;&quot;</span> + Build.BRAND + <span class="hljs-string">&quot;&#x27;\n&quot;</span><br>        + <span class="hljs-string">&quot;Model: &#x27;&quot;</span> + Util.getMobileModel() + <span class="hljs-string">&quot;&#x27;\n&quot;</span><br>        + <span class="hljs-string">&quot;Build fingerprint: &#x27;&quot;</span> + Build.FINGERPRINT + <span class="hljs-string">&quot;&#x27;\n&quot;</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getBuildId</span><span class="hljs-params">(String stktrace)</span> </span>&#123;<br>    String buildId = <span class="hljs-string">&quot;&quot;</span>;<br>    List&lt;String&gt; libPathList = <span class="hljs-keyword">new</span> ArrayList&lt;String&gt;();<br>    <span class="hljs-keyword">if</span> (stktrace.contains(<span class="hljs-string">&quot;UnsatisfiedLinkError&quot;</span>)) &#123;<br>        String libInfo = <span class="hljs-keyword">null</span>;<br>        String[] tempLibPathStr;<br>        tempLibPathStr = stktrace.split(<span class="hljs-string">&quot;\&quot;&quot;</span>); <span class="hljs-comment">// &quot; is the delimiter</span><br>        <span class="hljs-keyword">for</span> (String libPathStr :  tempLibPathStr) &#123;<br>            <span class="hljs-keyword">if</span> (libPathStr.isEmpty() || !libPathStr.endsWith(<span class="hljs-string">&quot;.so&quot;</span>)) <span class="hljs-keyword">continue</span>;<br>            libPathList.add(libPathStr);<br>            String libName = libPathStr.substring(libPathStr.lastIndexOf(<span class="hljs-string">&#x27;/&#x27;</span>) + <span class="hljs-number">1</span>);<br>            libPathList.add(XCrash.nativeLibDir + <span class="hljs-string">&quot;/&quot;</span> + libName);<br>            libPathList.add(<span class="hljs-string">&quot;/vendor/lib/&quot;</span> + libName);<br>            libPathList.add(<span class="hljs-string">&quot;/vendor/lib64/&quot;</span> + libName);<br>            libPathList.add(<span class="hljs-string">&quot;/system/lib/&quot;</span> + libName);<br>            libPathList.add(<span class="hljs-string">&quot;/system/lib64/&quot;</span> + libName);<br>            libInfo = getLibInfo(libPathList);<br>        &#125;<br>        buildId = <span class="hljs-string">&quot;build id:&quot;</span><br>                + <span class="hljs-string">&quot;\n&quot;</span><br>                + libInfo<br>                + <span class="hljs-string">&quot;\n&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> buildId;<br>&#125;        <br></code></pre></div></td></tr></table></figure>

<p>输出的日志内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">*** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***<br>Tombstone maker: &#x27;xCrash 2.4.6&#x27;                                                                    // xCrash 把日志叫做 tombstone，这里指的是生成 tombstone 的 xCrash 的版本<br>Crash type: &#x27;java&#x27;                                                                                 // 指明 crash 类型，此日志包含的是 java crash（此外还有 native crash 和 ANR）<br>Start time: &#x27;2019-10-12T03:23:19.580+0800&#x27;                                                         // 初始化 xCrash 的时间，也就是调用 XCrash.init 的时间<br>Crash time: &#x27;2019-10-12T03:23:25.533+0800&#x27;                                                         // 发生崩溃的时间<br>App ID: &#x27;xcrash.sample&#x27;                                                                            // 发生崩溃的 APP 的包名<br>App version: &#x27;1.2.3-beta456-patch789&#x27;                                                              // APP version name<br>Rooted: &#x27;No&#x27;                                                                                       <br>API level: &#x27;29&#x27;<br>OS version: &#x27;10&#x27;<br>ABI list: &#x27;arm64-v8a,armeabi-v7a,armeabi&#x27;<br>Manufacturer: &#x27;Google&#x27;<br>Brand: &#x27;google&#x27;<br>Model: &#x27;Pixel&#x27;<br>Build fingerprint: &#x27;google/sailfish/sailfish:10/QP1A.190711.020/5800535:user/release-keys&#x27;<br>pid: 21356, tid: 21356, name: main  &gt;&gt;&gt; xcrash.sample &lt;&lt;&lt;<br><br>java stacktrace:                                                                                    // 崩溃线程的调用栈<br>java.lang.IllegalStateException: Could not execute method for android:onClick<br>	at androidx.appcompat.app.AppCompatViewInflater$DeclaredOnClickListener.onClick(AppCompatViewInflater.java:402)<br>	at android.view.View.performClick(View.java:7140)<br>	at android.view.View.performClickInternal(View.java:7117)<br>	at android.view.View.access$3500(View.java:801)<br>	at android.view.View$PerformClick.run(View.java:27351)<br>	at android.os.Handler.handleCallback(Handler.java:883)<br>	at android.os.Handler.dispatchMessage(Handler.java:100)<br>	at android.os.Looper.loop(Looper.java:214)<br>	at android.app.ActivityThread.main(ActivityThread.java:7356)<br>	at java.lang.reflect.Method.invoke(Native Method)<br>	at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:492)<br>	at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:930)<br>Caused by: java.lang.reflect.InvocationTargetException<br>	at java.lang.reflect.Method.invoke(Native Method)<br>	at androidx.appcompat.app.AppCompatViewInflater$DeclaredOnClickListener.onClick(AppCompatViewInflater.java:397)<br>	... 11 more<br>Caused by: java.lang.RuntimeException: test java exception<br>	at xcrash.XCrash.testJavaCrash(XCrash.java:847)<br>	at xcrash.sample.MainActivity.testJavaCrashInMainThread_onClick(MainActivity.java:67)<br>	... 13 more<br></code></pre></div></td></tr></table></figure>

<h3 id="logcat"><a href="#logcat" class="headerlink" title="logcat"></a>logcat</h3><p>其实就是调用 <code>logcat</code> 命令获取崩溃时的 <code>main</code>、<code>system</code> 和 <code>events</code> 三个 buffer 的日志，如：<code>/system/bin/logcat -b main -d -v threadtime -t 200 --pid 21356 *:D</code></p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">static</span> String <span class="hljs-title">getLogcat</span><span class="hljs-params">(<span class="hljs-keyword">int</span> logcatMainLines, <span class="hljs-keyword">int</span> logcatSystemLines, <span class="hljs-keyword">int</span> logcatEventsLines)</span> </span>&#123;<br>    <span class="hljs-keyword">int</span> pid = android.os.Process.myPid();<br>    StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder();<br>    sb.append(<span class="hljs-string">&quot;logcat:\n&quot;</span>);<br>    <span class="hljs-keyword">if</span> (logcatMainLines &gt; <span class="hljs-number">0</span>) &#123;<br>        getLogcatByBufferName(pid, sb, <span class="hljs-string">&quot;main&quot;</span>, logcatMainLines, <span class="hljs-string">&#x27;D&#x27;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (logcatSystemLines &gt; <span class="hljs-number">0</span>) &#123;<br>        getLogcatByBufferName(pid, sb, <span class="hljs-string">&quot;system&quot;</span>, logcatSystemLines, <span class="hljs-string">&#x27;W&#x27;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (logcatEventsLines &gt; <span class="hljs-number">0</span>) &#123;<br>        getLogcatByBufferName(pid, sb, <span class="hljs-string">&quot;events&quot;</span>, logcatSystemLines, <span class="hljs-string">&#x27;I&#x27;</span>);<br>    &#125;<br>    sb.append(<span class="hljs-string">&quot;\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> sb.toString();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getLogcatByBufferName</span><span class="hljs-params">(<span class="hljs-keyword">int</span> pid, StringBuilder sb, String bufferName, <span class="hljs-keyword">int</span> lines, <span class="hljs-keyword">char</span> priority)</span> </span>&#123;<br>    <span class="hljs-keyword">boolean</span> withPid = (android.os.Build.VERSION.SDK_INT &gt;= <span class="hljs-number">24</span>);<br>    String pidString = Integer.toString(pid);<br>    String pidLabel = <span class="hljs-string">&quot; &quot;</span> + pidString + <span class="hljs-string">&quot; &quot;</span>;<br>    <span class="hljs-comment">//command for ProcessBuilder</span><br>    List&lt;String&gt; command = <span class="hljs-keyword">new</span> ArrayList&lt;String&gt;();<br>    command.add(<span class="hljs-string">&quot;/system/bin/logcat&quot;</span>);<br>    command.add(<span class="hljs-string">&quot;-b&quot;</span>);<br>    command.add(bufferName);<br>    command.add(<span class="hljs-string">&quot;-d&quot;</span>);<br>    command.add(<span class="hljs-string">&quot;-v&quot;</span>);<br>    command.add(<span class="hljs-string">&quot;threadtime&quot;</span>);<br>    command.add(<span class="hljs-string">&quot;-t&quot;</span>);<br>    command.add(Integer.toString(withPid ? lines : (<span class="hljs-keyword">int</span>) (lines * <span class="hljs-number">1.2</span>)));<br>    <span class="hljs-keyword">if</span> (withPid) &#123;<br>        command.add(<span class="hljs-string">&quot;--pid&quot;</span>);<br>        command.add(pidString);<br>    &#125;<br>    command.add(<span class="hljs-string">&quot;*:&quot;</span> + priority);<br>    <span class="hljs-comment">//append the command line</span><br>    Object[] commandArray = command.toArray();<br>    sb.append(<span class="hljs-string">&quot;--------- tail end of log &quot;</span>).append(bufferName);<br>    sb.append(<span class="hljs-string">&quot; (&quot;</span>).append(android.text.TextUtils.join(<span class="hljs-string">&quot; &quot;</span>, commandArray)).append(<span class="hljs-string">&quot;)\n&quot;</span>);<br>    <span class="hljs-comment">//append logs</span><br>    BufferedReader br = <span class="hljs-keyword">null</span>;<br>    String line;<br>    <span class="hljs-keyword">try</span> &#123;<br>        Process process = <span class="hljs-keyword">new</span> ProcessBuilder().command(command).start();<br>        br = <span class="hljs-keyword">new</span> BufferedReader(<span class="hljs-keyword">new</span> InputStreamReader(process.getInputStream()));<br>        <span class="hljs-keyword">while</span> ((line = br.readLine()) != <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (withPid || line.contains(pidLabel)) &#123;<br>                sb.append(line).append(<span class="hljs-string">&quot;\n&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        XCrash.getLogger().w(Util.TAG, <span class="hljs-string">&quot;Util run logcat command failed&quot;</span>, e);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-keyword">if</span> (br != <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                br.close();<br>            &#125; <span class="hljs-keyword">catch</span> (IOException ignored) &#123;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;    <br></code></pre></div></td></tr></table></figure>

<p>输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">logcat:<br>--------- tail end of log main (/system/bin/logcat -b main -d -v threadtime -t 200 --pid 21356 *:D)<br>10-12 03:23:19.356 21356 21356 I xcrash.sample: Late-enabling -Xcheck:jni<br>10-12 03:23:19.398 21356 21356 E xcrash.sample: Unknown bits set in runtime_flags: 0x8000<br>10-12 03:23:19.571 21356 21356 D xcrash_sample: xCrash SDK init: start<br>10-12 03:23:19.586 21356 21356 D xcrash_sample: xCrash SDK init: end<br>10-12 03:23:19.757 21356 21356 W xcrash.sample: Accessing hidden method Landroid/view/View;-&gt;computeFitSystemWindows(Landroid/graphics/Rect;Landroid/graphics/Rect;)Z (greylist, reflection, allowed)<br>10-12 03:23:19.758 21356 21356 W xcrash.sample: Accessing hidden method Landroid/view/ViewGroup;-&gt;makeOptionalFitsSystemWindows()V (greylist, reflection, allowed)<br>10-12 03:23:19.829 21356 21356 I WebViewFactory: Loading com.google.android.webview version 77.0.3865.92 (code 386509238)<br>10-12 03:23:19.874 21356 21356 I cr_LibraryLoader: Time to load native libraries: 4 ms (timestamps 1922-1926)<br>10-12 03:23:19.920 21356 21356 I chromium: [INFO:library_loader_hooks.cc(51)] Chromium logging enabled: level = 0, default verbosity = 0<br>10-12 03:23:19.921 21356 21356 I cr_LibraryLoader: Expected native library version number &quot;77.0.3865.92&quot;, actual native library version number &quot;77.0.3865.92&quot;<br>10-12 03:23:19.926 21356 21402 W cr_ChildProcLH: Create a new ChildConnectionAllocator with package name = com.google.android.webview, sandboxed = true<br>10-12 03:23:19.930 21356 21402 W xcrash.sample: Accessing hidden method Landroid/content/Context;-&gt;bindServiceAsUser(Landroid/content/Intent;Landroid/content/ServiceConnection;ILandroid/os/Handler;Landroid/os/UserHandle;)Z (greylist, reflection, allowed)<br>10-12 03:23:19.934 21356 21356 I cr_BrowserStartup: Initializing chromium process, singleProcess=false<br>10-12 03:23:19.979 21356 21430 W chromium: [WARNING:dns_config_service_posix.cc(339)] Failed to read DnsConfig.<br>10-12 03:23:20.031 21356 21356 W xcrash.sample: Accessing hidden method Landroid/view/textclassifier/logging/SmartSelectionEventTracker;-&gt;&lt;init&gt;(Landroid/content/Context;I)V (greylist, reflection, allowed)<br>10-12 03:23:20.031 21356 21356 W xcrash.sample: Accessing hidden method Landroid/view/textclassifier/logging/SmartSelectionEventTracker;-&gt;logEvent(Landroid/view/textclassifier/logging/SmartSelectionEventTracker$SelectionEvent;)V (greylist, reflection, allowed)<br>10-12 03:23:20.032 21356 21356 W xcrash.sample: Accessing hidden method Landroid/view/textclassifier/logging/SmartSelectionEventTracker$SelectionEvent;-&gt;selectionStarted(I)Landroid/view/textclassifier/logging/SmartSelectionEventTracker$SelectionEvent; (greylist, reflection, allowed)<br>10-12 03:23:20.032 21356 21356 W xcrash.sample: Accessing hidden method Landroid/view/textclassifier/logging/SmartSelectionEventTracker$SelectionEvent;-&gt;selectionModified(II)Landroid/view/textclassifier/logging/SmartSelectionEventTracker$SelectionEvent; (greylist, reflection, allowed)<br>10-12 03:23:20.032 21356 21356 W xcrash.sample: Accessing hidden method Landroid/view/textclassifier/logging/SmartSelectionEventTracker$SelectionEvent;-&gt;selectionModified(IILandroid/view/textclassifier/TextClassification;)Landroid/view/textclassifier/logging/SmartSelectionEventTracker$SelectionEvent; (greylist, reflection, allowed)<br>10-12 03:23:20.032 21356 21356 W xcrash.sample: Accessing hidden method Landroid/view/textclassifier/logging/SmartSelectionEventTracker$SelectionEvent;-&gt;selectionModified(IILandroid/view/textclassifier/TextSelection;)Landroid/view/textclassifier/logging/SmartSelectionEventTracker$SelectionEvent; (greylist, reflection, allowed)<br>10-12 03:23:20.032 21356 21356 W xcrash.sample: Accessing hidden method Landroid/view/textclassifier/logging/SmartSelectionEventTracker$SelectionEvent;-&gt;selectionAction(III)Landroid/view/textclassifier/logging/SmartSelectionEventTracker$SelectionEvent; (greylist, reflection, allowed)<br>10-12 03:23:20.032 21356 21356 W xcrash.sample: Accessing hidden method Landroid/view/textclassifier/logging/SmartSelectionEventTracker$SelectionEvent;-&gt;selectionAction(IIILandroid/view/textclassifier/TextClassification;)Landroid/view/textclassifier/logging/SmartSelectionEventTracker$SelectionEvent; (greylist, reflection, allowed)<br>10-12 03:23:20.143 21356 21395 I Adreno  : QUALCOMM build                   : 4a00b69, I4e7e888065<br>10-12 03:23:20.143 21356 21395 I Adreno  : Build Date                       : 04/09/19<br>10-12 03:23:20.143 21356 21395 I Adreno  : OpenGL ES Shader Compiler Version: EV031.26.06.00<br>10-12 03:23:20.143 21356 21395 I Adreno  : Local Branch                     : mybranche95ae4c8-d77f-f18d-a9ef-1458d0b52ae8<br>10-12 03:23:20.143 21356 21395 I Adreno  : Remote Branch                    : quic/gfx-adreno.lnx.1.0<br>10-12 03:23:20.143 21356 21395 I Adreno  : Remote Branch                    : NONE<br>10-12 03:23:20.143 21356 21395 I Adreno  : Reconstruct Branch               : NOTHING<br>10-12 03:23:20.143 21356 21395 I Adreno  : Build Config                     : S L 8.0.5 AArch64<br>10-12 03:23:20.146 21356 21395 I Adreno  : PFP: 0x005ff110, ME: 0x005ff066<br>10-12 03:23:20.198 21356 21395 W Gralloc3: mapper 3.x is not supported<br>10-12 03:23:25.531 21356 21356 D AndroidRuntime: Shutting down VM<br>--------- tail end of log system (/system/bin/logcat -b system -d -v threadtime -t 50 --pid 21356 *:W)<br>--------- tail end of log events (/system/bin/logcat -b events -d -v threadtime -t 50 --pid 21356 *:I)<br>10-12 03:23:20.046 21356 21356 I am_on_create_called: [0,xcrash.sample.MainActivity,performCreate]<br>10-12 03:23:20.053 21356 21356 I am_on_start_called: [0,xcrash.sample.MainActivity,handleStartActivity]<br>10-12 03:23:20.056 21356 21356 I am_on_resume_called: [0,xcrash.sample.MainActivity,RESUME_ACTIVITY]<br>10-12 03:23:20.083 21356 21356 I am_on_top_resumed_gained_called: [0,xcrash.sample.MainActivity,topStateChangedWhenResumed]<br></code></pre></div></td></tr></table></figure>

<h3 id="Opened-FD"><a href="#Opened-FD" class="headerlink" title="Opened FD"></a>Opened FD</h3><p>打印已打开的 FD 及其路径，已打开的 FD 在目录 <code>/proc/self/fd</code> 下</p>
<figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">static</span> String <span class="hljs-title">getFds</span><span class="hljs-params">()</span> </span>&#123;<br>    StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">&quot;open files:\n&quot;</span>);<br>    <span class="hljs-keyword">try</span> &#123;<br>        File dir = <span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;/proc/self/fd&quot;</span>);<br>        File[] fds = dir.listFiles(<span class="hljs-keyword">new</span> FilenameFilter() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">accept</span><span class="hljs-params">(File dir, String name)</span> </span>&#123;<br>                <span class="hljs-keyword">return</span> TextUtils.isDigitsOnly(name);<br>            &#125;<br>        &#125;);<br>        <span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (fds != <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">for</span> (File fd : fds) &#123;<br>                String path = <span class="hljs-keyword">null</span>;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="hljs-number">21</span>) &#123;<br>                        path = Os.readlink(fd.getAbsolutePath());<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        path = fd.getCanonicalPath();<br>                    &#125;<br>                &#125; <span class="hljs-keyword">catch</span> (Exception ignored) &#123;<br>                &#125;<br>                sb.append(<span class="hljs-string">&quot;    fd &quot;</span>).append(fd.getName()).append(<span class="hljs-string">&quot;: &quot;</span>)<br>                    .append(TextUtils.isEmpty(path) ? <span class="hljs-string">&quot;???&quot;</span> : path.trim()).append(<span class="hljs-string">&#x27;\n&#x27;</span>);<br>                count++;<br>                <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">1024</span>) &#123;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (fds.length &gt; <span class="hljs-number">1024</span>) &#123;<br>                sb.append(<span class="hljs-string">&quot;    ......\n&quot;</span>);<br>            &#125;<br>            sb.append(<span class="hljs-string">&quot;    (number of FDs: &quot;</span>).append(fds.length).append(<span class="hljs-string">&quot;)\n&quot;</span>);<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception ignored) &#123;<br>    &#125;<br>    sb.append(<span class="hljs-string">&#x27;\n&#x27;</span>);<br>    <span class="hljs-keyword">return</span> sb.toString();<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">open files:<br>    fd 0: /dev/null<br>    fd 1: /dev/null<br>    fd 2: /dev/null<br>    fd 3: /proc/21356/fd/3<br>    fd 4: /proc/21356/fd/4<br>    fd 5: /proc/21356/fd/5<br>    fd 6: /dev/null<br>    fd 7: /dev/null<br>    fd 8: /dev/null<br>    fd 9: /apex/com.android.runtime/javalib/core-oj.jar<br>    fd 10: /apex/com.android.runtime/javalib/core-libart.jar<br>    fd 11: /apex/com.android.runtime/javalib/okhttp.jar<br>    fd 12: /apex/com.android.runtime/javalib/bouncycastle.jar<br>    fd 13: /apex/com.android.runtime/javalib/apache-xml.jar<br>    fd 14: /system/framework/framework.jar<br>    fd 15: /system/framework/ext.jar<br>    fd 16: /system/framework/telephony-common.jar<br>    fd 17: /system/framework/voip-common.jar<br>    fd 18: /system/framework/ims-common.jar<br>    fd 19: /dev/null<br>    fd 20: /dev/null<br>    fd 21: /system/framework/android.test.base.jar<br>    fd 22: /apex/com.android.conscrypt/javalib/conscrypt.jar<br>    fd 23: /apex/com.android.media/javalib/updatable-media.jar<br>    fd 24: /system/framework/framework-res.apk<br>    fd 25: /system/product/overlay/GoogleConfigOverlay.apk<br>    fd 26: /system/product/overlay/GoogleWebViewOverlay.apk<br>    fd 27: /vendor/overlay/framework-res__auto_generated_rro_vendor.apk<br>    fd 28: /system/product/overlay/PixelConfigOverlayCommon.apk<br>    fd 29: /system/product/overlay/framework-res__auto_generated_rro_product.apk<br>    fd 30: /dev/null<br>    fd 31: /dev/binder<br>    fd 32: /proc/21356/fd/32<br>    fd 33: /proc/21356/fd/33<br>    fd 34: /proc/21356/fd/34<br>    fd 35: /proc/21356/fd/35<br>    fd 36: /proc/21356/fd/36<br>    fd 37: /data/app/xcrash.sample-WeCpVYjROKKgYtuzbHflHg==/base.apk<br>    fd 38: /proc/21356/fd/38<br>    fd 39: /proc/21356/fd/39<br>    fd 40: /system/product/overlay/NavigationBarModeGestural/NavigationBarModeGesturalOverlay.apk<br>    fd 41: /dev/null<br>    fd 42: /dev/null<br>    fd 43: /dev/null<br>    fd 44: /dev/null<br>    fd 45: /proc/21356/fd/45<br>    fd 46: /proc/21356/fd/46<br>    fd 47: /proc/21356/fd/47<br>    fd 48: /proc/21356/fd/48<br>    fd 49: /dev/ashmem<br>    fd 50: /proc/21356/fd/50<br>    fd 51: /proc/21356/fd/51<br>    fd 52: /data/app/com.google.android.trichromelibrary_386509238-C5vGqz1rgNqceBgeyyw2Aw==/base.apk<br>    fd 53: /proc/21356/fd/53<br>    fd 54: /data/data/xcrash.sample/files/tombstones/tombstone_00001570821799580000_1.2.3-beta456-patch789__xcrash.sample.java.xcrash<br>    fd 55: /data/app/com.google.android.webview-wtyVrSKc9Gzy-ujvyvTNjw==/base.apk<br>    fd 56: /data/app/com.google.android.trichromelibrary_386509238-C5vGqz1rgNqceBgeyyw2Aw==/base.apk<br>    fd 57: /data/data/xcrash.sample/app_webview/webview_data.lock<br>    fd 58: /data/app/com.google.android.webview-wtyVrSKc9Gzy-ujvyvTNjw==/base.apk<br>    fd 59: /system/product/overlay/NavigationBarModeGestural/NavigationBarModeGesturalOverlay.apk<br>    fd 60: /proc/21356/fd/60<br>    fd 61: /proc/21356/fd/61<br>    fd 62: /data/app/com.google.android.trichromelibrary_386509238-C5vGqz1rgNqceBgeyyw2Aw==/base.apk<br>    fd 63: /data/app/com.google.android.trichromelibrary_386509238-C5vGqz1rgNqceBgeyyw2Aw==/base.apk<br>    fd 64: /data/app/com.google.android.webview-wtyVrSKc9Gzy-ujvyvTNjw==/base.apk<br>    fd 65: /data/app/com.google.android.trichromelibrary_386509238-C5vGqz1rgNqceBgeyyw2Aw==/base.apk<br>    fd 66: /dev/urandom<br>    fd 67: /proc/21356/fd/67<br>    fd 68: /proc/21356/fd/68<br>    fd 69: /data/app/com.google.android.webview-wtyVrSKc9Gzy-ujvyvTNjw==/base.apk<br>    fd 70: /proc/21356/fd/70<br>    fd 71: /proc/21356/fd/71<br>    fd 72: /data/app/com.google.android.webview-wtyVrSKc9Gzy-ujvyvTNjw==/base.apk<br>    fd 73: /data/app/com.google.android.webview-wtyVrSKc9Gzy-ujvyvTNjw==/base.apk<br>    fd 74: /proc/21356/fd/74<br>    fd 75: /proc/21356/fd/75<br>    fd 76: /proc/21356/fd/76<br>    fd 77: /proc/21356/fd/77<br>    fd 78: /proc/21356/fd/78<br>    fd 79: /proc/21356/fd/79<br>    fd 80: /proc/21356/fd/80<br>    fd 81: /proc/21356/fd/81<br>    fd 82: /proc/21356/fd/82<br>    fd 83: /proc/21356/fd/83<br>    fd 84: /proc/21356/fd/84<br>    fd 85: /proc/21356/fd/85<br>    fd 86: /proc/21356/fd/86<br>    fd 87: /proc/21356/fd/87<br>    fd 88: /proc/21356/fd/88<br>    fd 89: /proc/21356/fd/89<br>    fd 90: /proc/21356/fd/90<br>    fd 91: /dev/ashmem<br>    fd 92: /dev/ashmem<br>    fd 93: /dev/ashmem<br>    fd 94: /data/data/xcrash.sample/app_webview/Web Data<br>    fd 95: /proc/21356/fd/95<br>    fd 96: /proc/21356/fd/96<br>    fd 97: /dev/ashmem<br>    fd 98: /dev/ion<br>    fd 99: /proc/21356/fd/99<br>    fd 100: /proc/21356/fd/100<br>    fd 101: /proc/21356/fd/101<br>    fd 102: /dev/ashmem<br>    fd 103: /dev/kgsl-3d0<br>    fd 104: /dev/ion<br>    fd 105: /dev/hwbinder<br>    fd 106: /proc/21356/fd/106<br>    fd 107: /proc/21356/fd/107<br>    fd 110: /proc/21356/fd/110<br>    fd 111: /proc/21356/fd/111<br>    fd 113: /proc/21356/fd/113<br>    fd 114: /proc/21356/fd/114<br>    fd 115: /proc/21356/fd/115<br>    fd 116: /proc/21356/fd/116<br>    fd 117: /proc/21356/fd/117<br>    (number of FDs: 115)<br></code></pre></div></td></tr></table></figure>

<h3 id="System-Memory-Summary"><a href="#System-Memory-Summary" class="headerlink" title="System Memory Summary"></a>System Memory Summary</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">System Summary (From: /proc/meminfo)<br> MemTotal:        3855796 kB<br> MemFree:           90124 kB<br> MemAvailable:    1452636 kB<br> Buffers:           77420 kB<br> Cached:          1461900 kB<br> SwapCached:        10232 kB<br> Active:          1771504 kB<br> Inactive:        1014432 kB<br> Active(anon):    1046604 kB<br> Inactive(anon):   368348 kB<br> Active(file):     724900 kB<br> Inactive(file):   646084 kB<br> Unevictable:      151672 kB<br> Mlocked:          151672 kB<br> SwapTotal:        524284 kB<br> SwapFree:         271320 kB<br> Dirty:               136 kB<br> Writeback:             0 kB<br> AnonPages:       1391280 kB<br> Mapped:           620988 kB<br> Shmem:             16660 kB<br> Slab:             231556 kB<br> SReclaimable:      92700 kB<br> SUnreclaim:       138856 kB<br> KernelStack:       44448 kB<br> PageTables:        57544 kB<br> NFS_Unstable:          0 kB<br> Bounce:                0 kB<br> WritebackTmp:          0 kB<br> CommitLimit:     2452180 kB<br> Committed_AS:   67847232 kB<br> VmallocTotal:   258998208 kB<br> VmallocUsed:      223632 kB<br> VmallocChunk:   258675172 kB<br></code></pre></div></td></tr></table></figure>

<h3 id="APP-Process-Summary"><a href="#APP-Process-Summary" class="headerlink" title="APP Process Summary"></a>APP Process Summary</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">Process Status (From: /proc/PID/status)<br> Name:	xcrash.sample<br> State:	R (running)<br> Tgid:	21356<br> Pid:	21356<br> PPid:	626<br> TracerPid:	0<br> Uid:	10180	10180	10180	10180<br> Gid:	10180	10180	10180	10180<br> Ngid:	0<br> FDSize:	128<br> Groups:	9997 20180 50180<br> VmPeak:	 5659228 kB<br> VmSize:	 5542192 kB<br> VmLck:	       0 kB<br> VmPin:	       0 kB<br> VmHWM:	   94624 kB<br> VmRSS:	   94396 kB<br> VmData:	 5051840 kB<br> VmStk:	    8192 kB<br> VmExe:	      28 kB<br> VmLib:	  166580 kB<br> VmPTE:	    1068 kB<br> VmSwap:	    6476 kB<br> Threads:	37<br> SigQ:	0/13891<br> SigPnd:	0000000000000000<br> ShdPnd:	0000000000000000<br> SigBlk:	0000000080001200<br> SigIgn:	0000000000000001<br> SigCgt:	0000000e400084fc<br> CapInh:	0000000000000000<br> CapPrm:	0000000000000000<br> CapEff:	0000000000000000<br> CapBnd:	0000000000000000<br> CapAmb:	0000000000000000<br> Seccomp:	2<br> Cpus_allowed:	f<br> Cpus_allowed_list:	0-3<br> Mems_allowed:	1<br> Mems_allowed_list:	0<br> voluntary_ctxt_switches:	343<br> nonvoluntary_ctxt_switches:	301<br></code></pre></div></td></tr></table></figure>

<h3 id="APP-Process-Limits"><a href="#APP-Process-Limits" class="headerlink" title="APP Process Limits"></a>APP Process Limits</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">Process Limits (From: /proc/PID/limits)<br> Limit                     Soft Limit           Hard Limit           Units<br> Max cpu time              unlimited            unlimited            seconds<br> Max file size             unlimited            unlimited            bytes<br> Max data size             unlimited            unlimited            bytes<br> Max stack size            8388608              unlimited            bytes<br> Max core file size        0                    unlimited            bytes<br> Max resident set          unlimited            unlimited            bytes<br> Max processes             13891                13891                processes<br> Max open files            32768                32768                files<br> Max locked memory         65536                65536                bytes<br> Max address space         unlimited            unlimited            bytes<br> Max file locks            unlimited            unlimited            locks<br> Max pending signals       13891                13891                signals<br> Max msgqueue size         819200               819200               bytes<br> Max nice priority         40                   40<br> Max realtime priority     0                    0<br> Max realtime timeout      unlimited            unlimited            us<br></code></pre></div></td></tr></table></figure>

<h3 id="APP-Memory-Summary"><a href="#APP-Memory-Summary" class="headerlink" title="APP Memory Summary"></a>APP Memory Summary</h3><figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">Process Summary (From: android.os.Debug.MemoryInfo)<br>                       Pss(KB)<br>                        ------<br>           Java Heap:     7632<br>         Native Heap:    10932<br>                Code:    19064<br>               Stack:       56<br>            Graphics:     1104<br>       Private Other:     3448<br>              System:     4414<br>               TOTAL:    46650           TOTAL SWAP:     6460<br><br></code></pre></div></td></tr></table></figure>

<h3 id="Other-StackTraces"><a href="#Other-StackTraces" class="headerlink" title="Other StackTraces"></a>Other StackTraces</h3><figure class="highlight java"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getOtherThreadsInfo</span><span class="hljs-params">(Thread crashedThread)</span> </span>&#123;<br><br>    <span class="hljs-comment">// 其他线程可能有很多，所以有“白名单”机制</span><br>    <span class="hljs-keyword">int</span> thdMatchedRegex = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">int</span> thdIgnoredByLimit = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">int</span> thdDumped = <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">//build whitelist regex list</span><br>    ArrayList&lt;Pattern&gt; whiteList = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-keyword">if</span> (dumpAllThreadsWhiteList != <span class="hljs-keyword">null</span>) &#123;<br>        whiteList = <span class="hljs-keyword">new</span> ArrayList&lt;Pattern&gt;();<br>        <span class="hljs-keyword">for</span> (String s : dumpAllThreadsWhiteList) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                whiteList.add(Pattern.compile(s));<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                XCrash.getLogger().w(Util.TAG, <span class="hljs-string">&quot;JavaCrashHandler pattern compile failed&quot;</span>, e);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// dump trace</span><br>    StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder();<br>    Map&lt;Thread, StackTraceElement[]&gt; map = Thread.getAllStackTraces();<br>    <span class="hljs-keyword">for</span> (Map.Entry&lt;Thread, StackTraceElement[]&gt; entry : map.entrySet()) &#123;<br>        Thread thd = entry.getKey();<br>        StackTraceElement[] stacktrace = entry.getValue();<br>        <span class="hljs-comment">//skip the crashed thread</span><br>        <span class="hljs-keyword">if</span> (thd.getName().equals(crashedThread.getName())) <span class="hljs-keyword">continue</span>;<br>        <span class="hljs-comment">//check regex for thread name</span><br>        <span class="hljs-keyword">if</span> (whiteList != <span class="hljs-keyword">null</span> &amp;&amp; !matchThreadName(whiteList, thd.getName())) <span class="hljs-keyword">continue</span>;<br>        thdMatchedRegex++;<br>        <span class="hljs-comment">//check dump count limit</span><br>        <span class="hljs-keyword">if</span> (dumpAllThreadsCountMax &gt; <span class="hljs-number">0</span> &amp;&amp; thdDumped &gt;= dumpAllThreadsCountMax) &#123;<br>            thdIgnoredByLimit++;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        sb.append(Util.sepOtherThreads + <span class="hljs-string">&quot;\n&quot;</span>);<br>        sb.append(<span class="hljs-string">&quot;pid: &quot;</span>).append(pid).append(<span class="hljs-string">&quot;, tid: &quot;</span>).append(thd.getId()).append(<span class="hljs-string">&quot;, name: &quot;</span>).append(thd.getName()).append(<span class="hljs-string">&quot;  &gt;&gt;&gt; &quot;</span>).append(processName).append(<span class="hljs-string">&quot; &lt;&lt;&lt;\n&quot;</span>);<br>        sb.append(<span class="hljs-string">&quot;\n&quot;</span>);<br>        sb.append(<span class="hljs-string">&quot;java stacktrace:\n&quot;</span>);<br>        <span class="hljs-keyword">for</span> (StackTraceElement element : stacktrace) &#123;<br>            sb.append(<span class="hljs-string">&quot;    at &quot;</span>).append(element.toString()).append(<span class="hljs-string">&quot;\n&quot;</span>);<br>        &#125;<br>        sb.append(<span class="hljs-string">&quot;\n&quot;</span>);<br>        thdDumped++;<br>    &#125;<br><br>    <span class="hljs-comment">// 统计</span><br>    <span class="hljs-keyword">if</span> (map.size() &gt; <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">if</span> (thdDumped == <span class="hljs-number">0</span>) &#123;<br>            sb.append(Util.sepOtherThreads + <span class="hljs-string">&quot;\n&quot;</span>);<br>        &#125;<br>        sb.append(<span class="hljs-string">&quot;total JVM threads (exclude the crashed thread): &quot;</span>).append(map.size() - <span class="hljs-number">1</span>).append(<span class="hljs-string">&quot;\n&quot;</span>);<br>        <span class="hljs-keyword">if</span> (whiteList != <span class="hljs-keyword">null</span>) &#123;<br>            sb.append(<span class="hljs-string">&quot;JVM threads matched whitelist: &quot;</span>).append(thdMatchedRegex).append(<span class="hljs-string">&quot;\n&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (dumpAllThreadsCountMax &gt; <span class="hljs-number">0</span>) &#123;<br>            sb.append(<span class="hljs-string">&quot;JVM threads ignored by max count limit: &quot;</span>).append(thdIgnoredByLimit).append(<span class="hljs-string">&quot;\n&quot;</span>);<br>        &#125;<br>        sb.append(<span class="hljs-string">&quot;dumped JVM threads:&quot;</span>).append(thdDumped).append(<span class="hljs-string">&quot;\n&quot;</span>);<br>        sb.append(Util.sepOtherThreadsEnding + <span class="hljs-string">&quot;\n&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> sb.toString();<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---<br>pid: 21356, tid: 4364, name: RenderThread  &gt;&gt;&gt; xcrash.sample &lt;&lt;&lt;<br><br>java stacktrace:<br><br>--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---<br>pid: 21356, tid: 4349, name: Jit thread pool worker thread 0  &gt;&gt;&gt; xcrash.sample &lt;&lt;&lt;<br><br>java stacktrace:<br><br>--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---<br>pid: 21356, tid: 4357, name: Binder:21356_2  &gt;&gt;&gt; xcrash.sample &lt;&lt;&lt;<br><br>java stacktrace:<br><br>--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---<br>pid: 21356, tid: 4374, name: NetworkService  &gt;&gt;&gt; xcrash.sample &lt;&lt;&lt;<br><br>java stacktrace:<br><br>--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---<br>pid: 21356, tid: 4353, name: ReferenceQueueDaemon  &gt;&gt;&gt; xcrash.sample &lt;&lt;&lt;<br><br>java stacktrace:<br>    at java.lang.Object.wait(Native Method)<br>    at java.lang.Object.wait(Object.java:442)<br>    at java.lang.Object.wait(Object.java:568)<br>    at java.lang.Daemons$ReferenceQueueDaemon.runInternal(Daemons.java:215)<br>    at java.lang.Daemons$Daemon.run(Daemons.java:137)<br>    at java.lang.Thread.run(Thread.java:919)<br><br>--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---<br>pid: 21356, tid: 4359, name: Profile Saver  &gt;&gt;&gt; xcrash.sample &lt;&lt;&lt;<br><br>java stacktrace:<br><br>--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---<br>pid: 21356, tid: 4371, name: GoogleApiHandler  &gt;&gt;&gt; xcrash.sample &lt;&lt;&lt;<br><br>java stacktrace:<br>    at android.os.MessageQueue.nativePollOnce(Native Method)<br>    at android.os.MessageQueue.next(MessageQueue.java:336)<br>    at android.os.Looper.loop(Looper.java:174)<br>    at android.os.HandlerThread.run(HandlerThread.java:67)<br><br>--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---<br>pid: 21356, tid: 4362, name: xcrash_trace_dp  &gt;&gt;&gt; xcrash.sample &lt;&lt;&lt;<br><br>java stacktrace:<br><br>--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---<br>pid: 21356, tid: 4361, name: xcrash_crash_cb  &gt;&gt;&gt; xcrash.sample &lt;&lt;&lt;<br><br>java stacktrace:<br><br>--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---<br>pid: 21356, tid: 4352, name: HeapTaskDaemon  &gt;&gt;&gt; xcrash.sample &lt;&lt;&lt;<br><br>java stacktrace:<br><br>--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---<br>pid: 21356, tid: 4354, name: FinalizerDaemon  &gt;&gt;&gt; xcrash.sample &lt;&lt;&lt;<br><br>java stacktrace:<br>    at java.lang.Object.wait(Native Method)<br>    at java.lang.Object.wait(Object.java:442)<br>    at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:190)<br>    at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:211)<br>    at java.lang.Daemons$FinalizerDaemon.runInternal(Daemons.java:271)<br>    at java.lang.Daemons$Daemon.run(Daemons.java:137)<br>    at java.lang.Thread.run(Thread.java:919)<br><br>--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---<br>pid: 21356, tid: 4372, name: Chrome_IOThread  &gt;&gt;&gt; xcrash.sample &lt;&lt;&lt;<br><br>java stacktrace:<br><br>--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---<br>pid: 21356, tid: 4370, name: CrAsyncTask #2  &gt;&gt;&gt; xcrash.sample &lt;&lt;&lt;<br><br>java stacktrace:<br>    at sun.misc.Unsafe.park(Native Method)<br>    at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:230)<br>    at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:2109)<br>    at java.util.concurrent.ArrayBlockingQueue.poll(ArrayBlockingQueue.java:402)<br>    at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1091)<br>    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1152)<br>    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:641)<br>    at Js.run(PG:2)<br>    at java.lang.Thread.run(Thread.java:919)<br><br>--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---<br>pid: 21356, tid: 4375, name: PlatformServiceBridgeHandlerThread  &gt;&gt;&gt; xcrash.sample &lt;&lt;&lt;<br><br>java stacktrace:<br>    at android.os.MessageQueue.nativePollOnce(Native Method)<br>    at android.os.MessageQueue.next(MessageQueue.java:336)<br>    at android.os.Looper.loop(Looper.java:174)<br>    at android.os.HandlerThread.run(HandlerThread.java:67)<br><br>--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---<br>pid: 21356, tid: 4355, name: FinalizerWatchdogDaemon  &gt;&gt;&gt; xcrash.sample &lt;&lt;&lt;<br><br>java stacktrace:<br>    at java.lang.Thread.sleep(Native Method)<br>    at java.lang.Thread.sleep(Thread.java:440)<br>    at java.lang.Thread.sleep(Thread.java:356)<br>    at java.lang.Daemons$FinalizerWatchdogDaemon.sleepForMillis(Daemons.java:383)<br>    at java.lang.Daemons$FinalizerWatchdogDaemon.waitForFinalization(Daemons.java:411)<br>    at java.lang.Daemons$FinalizerWatchdogDaemon.runInternal(Daemons.java:323)<br>    at java.lang.Daemons$Daemon.run(Daemons.java:137)<br>    at java.lang.Thread.run(Thread.java:919)<br><br>--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---<br>pid: 21356, tid: 4378, name: process reaper  &gt;&gt;&gt; xcrash.sample &lt;&lt;&lt;<br><br>java stacktrace:<br>    at sun.misc.Unsafe.park(Native Method)<br>    at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:230)<br>    at java.util.concurrent.SynchronousQueue$TransferStack.awaitFulfill(SynchronousQueue.java:461)<br>    at java.util.concurrent.SynchronousQueue$TransferStack.transfer(SynchronousQueue.java:362)<br>    at java.util.concurrent.SynchronousQueue.poll(SynchronousQueue.java:937)<br>    at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1091)<br>    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1152)<br>    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:641)<br>    at java.lang.Thread.run(Thread.java:919)<br><br>--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---<br>pid: 21356, tid: 4377, name: CleanupReference  &gt;&gt;&gt; xcrash.sample &lt;&lt;&lt;<br><br>java stacktrace:<br>    at java.lang.Object.wait(Native Method)<br>    at java.lang.Object.wait(Object.java:442)<br>    at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:190)<br>    at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:211)<br>    at Po.run(PG:2)<br><br>--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---<br>pid: 21356, tid: 4350, name: Signal Catcher  &gt;&gt;&gt; xcrash.sample &lt;&lt;&lt;<br><br>java stacktrace:<br><br>--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---<br>pid: 21356, tid: 4373, name: ThreadPoolForeg  &gt;&gt;&gt; xcrash.sample &lt;&lt;&lt;<br><br>java stacktrace:<br><br>--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---<br>pid: 21356, tid: 4369, name: Chrome_ProcessLauncherThread  &gt;&gt;&gt; xcrash.sample &lt;&lt;&lt;<br><br>java stacktrace:<br>    at android.os.MessageQueue.nativePollOnce(Native Method)<br>    at android.os.MessageQueue.next(MessageQueue.java:336)<br>    at android.os.Looper.loop(Looper.java:174)<br>    at android.os.HandlerThread.run(HandlerThread.java:67)<br><br>--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---<br>pid: 21356, tid: 4358, name: Binder:21356_3  &gt;&gt;&gt; xcrash.sample &lt;&lt;&lt;<br><br>java stacktrace:<br><br>--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---<br>pid: 21356, tid: 4366, name: CrAsyncTask #1  &gt;&gt;&gt; xcrash.sample &lt;&lt;&lt;<br><br>java stacktrace:<br>    at sun.misc.Unsafe.park(Native Method)<br>    at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:230)<br>    at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:2109)<br>    at java.util.concurrent.ArrayBlockingQueue.poll(ArrayBlockingQueue.java:402)<br>    at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1091)<br>    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1152)<br>    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:641)<br>    at Js.run(PG:2)<br>    at java.lang.Thread.run(Thread.java:919)<br><br>--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---<br>pid: 21356, tid: 4376, name: ThreadPoolForeg  &gt;&gt;&gt; xcrash.sample &lt;&lt;&lt;<br><br>java stacktrace:<br><br>--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---<br>pid: 21356, tid: 4356, name: Binder:21356_1  &gt;&gt;&gt; xcrash.sample &lt;&lt;&lt;<br><br>java stacktrace:<br><br>total JVM threads (exclude the crashed thread): 24<br>dumped JVM threads:24<br></code></pre></div></td></tr></table></figure>


<h2 id="Native-Crash"><a href="#Native-Crash" class="headerlink" title="Native Crash"></a>Native Crash</h2><p>捕获 Native Crash 靠的是信号处理器（<code>sigaction</code>），比如说访问非法地址时，APP 进程会收到 <code>SIGSEGV</code>，对应的信号处理器就可以在这个时间点收集堆栈信息</p>
<h3 id="sigaction"><a href="#sigaction" class="headerlink" title="sigaction"></a>sigaction</h3><p>signal 产生后会处于几种状态中：<br>    1. blocked，让内核先持有信号不要分发（deliver），在 unblocked 之前都不会被分发出去；被 blocked 的信号集合叫做 singal mask，每个线程都有自己的 signal mask<br>    2. pending，内核正在分发信号给指定的进程/线程（但还没分发出去）</p>
<p>signal 可以是进程范围的，比如内核产生的信号、kill 和 sigqueue；也可以是线程范围的，比如因执行机器指令而导致的硬件异常（SIGSEGV、SIGFPE）、通过 tgkill 或者 pthread_kill 指定目标线程</p>
<p>进程范围的信号会随机选择一个 signal unblocked 的线程来消费（deliver）</p>
<p><code>sigaction</code> 用来注册信号处理器，是升级版的 <code>signal</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-comment">// 如果 act != null，它被注册为新的信号处理器；如果 oldact != null，上一个信号处理器将被保存在此</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sigaction</span><span class="hljs-params">(<span class="hljs-keyword">int</span> signum, <span class="hljs-keyword">const</span> struct sigaction *act, struct sigaction *oldact)</span></span>;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sigaction</span> &#123;</span><br>    <span class="hljs-built_in"><span class="hljs-keyword">void</span></span>     (*sa_handler)(<span class="hljs-keyword">int</span>);                        <span class="hljs-comment">// 只收到 signal 作为参数的处理器</span><br>    <span class="hljs-built_in"><span class="hljs-keyword">void</span></span>     (*sa_sigaction)(<span class="hljs-keyword">int</span>, <span class="hljs-keyword">siginfo_t</span> *, <span class="hljs-keyword">void</span> *); <span class="hljs-comment">// 当指定 SA_SIGINFO 时，替代 sa_handler 作为处理器（能收到三个参数）</span><br>    <span class="hljs-keyword">sigset_t</span>   sa_mask;                                 <span class="hljs-comment">// 处理器运行时，暂时屏蔽指定信号（将它们加到线程的 signal mask）</span><br>    <span class="hljs-keyword">int</span>        sa_flags;<br>    <span class="hljs-built_in"><span class="hljs-keyword">void</span></span>     (*sa_restorer)(<span class="hljs-keyword">void</span>);                      <span class="hljs-comment">// not for app</span><br>&#125;;<br><br><span class="hljs-comment">// sa_flags:</span><br><span class="hljs-comment">//     SA_SIGINFO 使用 sa_sigaction 作为处理器</span><br><span class="hljs-comment">//     SA_RESTART 当线程阻塞在系统调用/库函数上，因为信号的到来转而进入信号处理器，退出信号处理器后如何恢复上一个系统调用/库函数；</span><br><span class="hljs-comment">//                默认是使其返回失败码，此 flag 指示重新执行系统调用/库函数</span><br><span class="hljs-comment">//     SA_ONSTACK 用另一个方法调用栈来执行处理器函数</span><br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sa_sigaction</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sig, <span class="hljs-keyword">siginfo_t</span> *info, <span class="hljs-keyword">void</span> *ucontext)</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-keyword">siginfo_t</span> </span>&#123;<br>    <span class="hljs-keyword">int</span>      si_signo;     <span class="hljs-comment">/* Signal number */</span><br>    <span class="hljs-keyword">int</span>      si_errno;     <span class="hljs-comment">/* An errno value */</span><br>    <span class="hljs-keyword">int</span>      si_code;      <span class="hljs-comment">/* Signal code */</span><br>    <span class="hljs-keyword">int</span>      si_trapno;    <span class="hljs-comment">/* Trap number that caused</span><br><span class="hljs-comment">                              hardware-generated signal</span><br><span class="hljs-comment">                              (unused on most architectures) */</span><br>    <span class="hljs-keyword">pid_t</span>    si_pid;       <span class="hljs-comment">/* Sending process ID */</span><br>    <span class="hljs-keyword">uid_t</span>    si_uid;       <span class="hljs-comment">/* Real user ID of sending process */</span><br>    <span class="hljs-keyword">int</span>      si_status;    <span class="hljs-comment">/* Exit value or signal */</span><br>    <span class="hljs-keyword">clock_t</span>  si_utime;     <span class="hljs-comment">/* User time consumed */</span><br>    <span class="hljs-keyword">clock_t</span>  si_stime;     <span class="hljs-comment">/* System time consumed */</span><br>    <span class="hljs-keyword">sigval_t</span> si_value;     <span class="hljs-comment">/* Signal value */</span><br>    <span class="hljs-keyword">int</span>      si_int;       <span class="hljs-comment">/* POSIX.1b signal */</span><br>    <span class="hljs-keyword">void</span>    *si_ptr;       <span class="hljs-comment">/* POSIX.1b signal */</span><br>    <span class="hljs-keyword">int</span>      si_overrun;   <span class="hljs-comment">/* Timer overrun count;</span><br><span class="hljs-comment">                              POSIX.1b timers */</span><br>    <span class="hljs-keyword">int</span>      si_timerid;   <span class="hljs-comment">/* Timer ID; POSIX.1b timers */</span><br>    <span class="hljs-keyword">void</span>    *si_addr;      <span class="hljs-comment">/* Memory location which caused fault */</span><br>    <span class="hljs-keyword">long</span>     si_band;      <span class="hljs-comment">/* Band event (was int in</span><br><span class="hljs-comment">                              glibc 2.3.2 and earlier) */</span><br>    <span class="hljs-keyword">int</span>      si_fd;        <span class="hljs-comment">/* File descriptor */</span><br>    <span class="hljs-keyword">short</span>    si_addr_lsb;  <span class="hljs-comment">/* Least significant bit of address</span><br><span class="hljs-comment">                              (since Linux 2.6.32) */</span><br>    <span class="hljs-keyword">void</span>    *si_lower;     <span class="hljs-comment">/* Lower bound when address violation</span><br><span class="hljs-comment">                              occurred (since Linux 3.19) */</span><br>    <span class="hljs-keyword">void</span>    *si_upper;     <span class="hljs-comment">/* Upper bound when address violation</span><br><span class="hljs-comment">                              occurred (since Linux 3.19) */</span><br>    <span class="hljs-keyword">int</span>      si_pkey;      <span class="hljs-comment">/* Protection key on PTE that caused</span><br><span class="hljs-comment">                              fault (since Linux 4.6) */</span><br>    <span class="hljs-keyword">void</span>    *si_call_addr; <span class="hljs-comment">/* Address of system call instruction</span><br><span class="hljs-comment">                              (since Linux 3.5) */</span><br>    <span class="hljs-keyword">int</span>      si_syscall;   <span class="hljs-comment">/* Number of attempted system call</span><br><span class="hljs-comment">                              (since Linux 3.5) */</span><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> si_arch;  <span class="hljs-comment">/* Architecture of attempted system call</span><br><span class="hljs-comment">                              (since Linux 3.5) */</span><br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="sigaltstack"><a href="#sigaltstack" class="headerlink" title="sigaltstack"></a>sigaltstack</h3><figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-comment">/** </span><br><span class="hljs-comment"> * 为当前进程设置一个新的（获取上一个）信号处理器调用栈，其实就是为信号处理器预先分配一块内存，作为其调用栈</span><br><span class="hljs-comment"> * The most common usage of an alternate signal stack is to handle the SIGSEGV signal </span><br><span class="hljs-comment"> * that is generated if the space available for the normal process stack is exhausted: </span><br><span class="hljs-comment"> * in this case, a signal handler for SIGSEGV cannot be invoked on the process stack; </span><br><span class="hljs-comment"> * if we wish to handle it, we must use an alternate signal stack</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sigaltstack</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">stack_t</span> *ss, <span class="hljs-keyword">stack_t</span> *old_ss)</span></span>;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-keyword">void</span>  *ss_sp;     <span class="hljs-comment">/* Base address of stack */</span><br>    <span class="hljs-keyword">int</span>    ss_flags;  <span class="hljs-comment">/* Flags */</span><br>    <span class="hljs-keyword">size_t</span> ss_size;   <span class="hljs-comment">/* Number of bytes in stack */</span><br>&#125; <span class="hljs-keyword">stack_t</span>;<br></code></pre></div></td></tr></table></figure>

<h3 id="xc-crash-signal-handler"><a href="#xc-crash-signal-handler" class="headerlink" title="xc_crash_signal_handler"></a>xc_crash_signal_handler</h3><figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-comment">// XCrash.init</span><br><span class="hljs-comment">// NativeHandler.initialize</span><br><span class="hljs-comment">// NativeHandler.nativeInit</span><br><span class="hljs-comment">// xc_jni_init</span><br><span class="hljs-comment">// xc_crash_init</span><br><br><span class="hljs-comment">// 需要捕获的信号</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">xcc_signal_crash_info_t</span> xcc_signal_crash_info[] =<br>&#123;<br>    &#123;.signum = SIGABRT&#125;,<br>    &#123;.signum = SIGBUS&#125;,<br>    &#123;.signum = SIGFPE&#125;,<br>    &#123;.signum = SIGILL&#125;,<br>    &#123;.signum = SIGSEGV&#125;,<br>    &#123;.signum = SIGTRAP&#125;,<br>    &#123;.signum = SIGSYS&#125;,<br>    &#123;.signum = SIGSTKFLT&#125;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">xcc_signal_crash_register</span><span class="hljs-params">(<span class="hljs-keyword">void</span> (*handler)(<span class="hljs-keyword">int</span>, <span class="hljs-keyword">siginfo_t</span> *, <span class="hljs-keyword">void</span> *))</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// 预先为处理器分配一块内存</span><br>    <span class="hljs-keyword">stack_t</span> ss;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-literal">NULL</span> == (ss.ss_sp = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, XCC_SIGNAL_CRASH_STACK_SIZE))) <span class="hljs-keyword">return</span> XCC_ERRNO_NOMEM;<br>    ss.ss_size  = XCC_SIGNAL_CRASH_STACK_SIZE;<br>    ss.ss_flags = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != <span class="hljs-built_in">sigaltstack</span>(&amp;ss, <span class="hljs-literal">NULL</span>)) <span class="hljs-keyword">return</span> XCC_ERRNO_SYS;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sigaction</span> <span class="hljs-title">act</span>;</span><br>    <span class="hljs-built_in">memset</span>(&amp;act, <span class="hljs-number">0</span>, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(act));<br>    <span class="hljs-built_in">sigfillset</span>(&amp;act.sa_mask);<br>    act.sa_sigaction = handler;<br>    act.sa_flags = SA_RESTART | SA_SIGINFO | SA_ONSTACK;<br>    <br>    <span class="hljs-comment">// 为上述信号注册处理器</span><br>    <span class="hljs-keyword">size_t</span> i;<br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(xcc_signal_crash_info) / <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(xcc_signal_crash_info[<span class="hljs-number">0</span>]); i++)<br>        <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != <span class="hljs-built_in">sigaction</span>(xcc_signal_crash_info[i].signum, &amp;act, &amp;(xcc_signal_crash_info[i].oldact)))<br>            <span class="hljs-keyword">return</span> XCC_ERRNO_SYS;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">// 信号处理器，跟上面的 JavaCrashHandler 一样，主要是收集各种信息，写入 tombstone 文件</span><br><span class="hljs-comment">// 比较复杂，下一章节进行分析</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">xc_crash_signal_handler</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sig, <span class="hljs-keyword">siginfo_t</span> *si, <span class="hljs-keyword">void</span> *uc)</span></span><br></code></pre></div></td></tr></table></figure>

<h3 id="核心步骤"><a href="#核心步骤" class="headerlink" title="核心步骤"></a>核心步骤</h3><ol>
<li>信号处理器（<code>xc_crash_signal_handler</code>，在 APP 进程）收集相关的信息到 <code>xc_crash_spot</code></li>
<li><code>fork</code> 出子进程 dumper，子进程继承了父进程的内存布局，也就捕获到了 APP 进程 crash 时刻的内存布局</li>
<li>dumper 进程的入口点是 <code>xc_crash_exec_dumper</code>，signal handler 线程通过 <code>waitpid</code> 阻塞直到 dumper 进程完成工作</li>
<li>dumper 将 signal 和调用堆栈等信息写入管道，然后加载程序 <code>libxcrash_dumper.so</code> 替换当前的内存空间（旧的内存空间的所有信息将被清空）</li>
<li><code>xcd_core.c</code> 里的 main 函数从管道里读取 <code>xc_crash_spot</code> 并写入 tombstone 日志文件，退出</li>
<li>signal handler 线程从阻塞中恢复，退出 APP 进程</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-comment">// APP 进程，signal hander 线程，dump 开始的地方</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">xc_crash_signal_handler</span><span class="hljs-params">(<span class="hljs-keyword">int</span> sig, <span class="hljs-keyword">siginfo_t</span> *si, <span class="hljs-keyword">void</span> *uc)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// set crash spot info</span><br>    xc_crash_spot.crash_time = xc_crash_time;<br>    xc_crash_spot.crash_tid = xc_crash_tid;<br>    <span class="hljs-built_in">memcpy</span>(&amp;(xc_crash_spot.siginfo), si, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword">siginfo_t</span>));<br>    <span class="hljs-built_in">memcpy</span>(&amp;(xc_crash_spot.ucontext), uc, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword">ucontext_t</span>));<br>    xc_crash_spot.log_pathname_len = <span class="hljs-built_in">strlen</span>(xc_crash_log_pathname);<br><br>    <span class="hljs-comment">// spawn crash dumper process</span><br>    <span class="hljs-keyword">pid_t</span> dumper_pid = <span class="hljs-built_in">xc_crash_fork</span>(xc_crash_exec_dumper);<br><br>    <span class="hljs-comment">// wait the crash dumper process terminated</span><br>    <span class="hljs-keyword">int</span> wait_r = <span class="hljs-built_in">XCC_UTIL_TEMP_FAILURE_RETRY</span>(<span class="hljs-built_in">waitpid</span>(dumper_pid, &amp;status, __WALL));<br><br>    <span class="hljs-comment">// exit</span><br>&#125;<br><br><span class="hljs-comment">// dumper 进程的入口</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">xc_crash_exec_dumper</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// 创建一个管道，第一个用来读，第二个用来写</span><br>    <span class="hljs-keyword">int</span> pipefd[<span class="hljs-number">2</span>];<br>    <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != <span class="hljs-built_in">pipe2</span>(pipefd, O_CLOEXEC))<br><br>    <span class="hljs-comment">// 将 xc_crash_spot 写入管道</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">iovs</span>[12] =</span> &#123;<br>        &#123;.iov_base = &amp;xc_crash_spot,                      .iov_len = <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword">xcc_spot_t</span>)&#125;,<br>        &#123;.iov_base = xc_crash_log_pathname,               .iov_len = xc_crash_spot.log_pathname_len&#125;,<br>        &#123;.iov_base = xc_common_os_version,                .iov_len = xc_crash_spot.os_version_len&#125;,<br>        &#123;.iov_base = xc_common_kernel_version,            .iov_len = xc_crash_spot.kernel_version_len&#125;,<br>        &#123;.iov_base = xc_common_abi_list,                  .iov_len = xc_crash_spot.abi_list_len&#125;,<br>        &#123;.iov_base = xc_common_manufacturer,              .iov_len = xc_crash_spot.manufacturer_len&#125;,<br>        &#123;.iov_base = xc_common_brand,                     .iov_len = xc_crash_spot.brand_len&#125;,<br>        &#123;.iov_base = xc_common_model,                     .iov_len = xc_crash_spot.model_len&#125;,<br>        &#123;.iov_base = xc_common_build_fingerprint,         .iov_len = xc_crash_spot.build_fingerprint_len&#125;,<br>        &#123;.iov_base = xc_common_app_id,                    .iov_len = xc_crash_spot.app_id_len&#125;,<br>        &#123;.iov_base = xc_common_app_version,               .iov_len = xc_crash_spot.app_version_len&#125;,<br>        &#123;.iov_base = xc_crash_dump_all_threads_whitelist, .iov_len = xc_crash_spot.dump_all_threads_whitelist_len&#125;<br>    &#125;;<br>    <span class="hljs-keyword">int</span> iovs_cnt = (<span class="hljs-number">0</span> == xc_crash_spot.dump_all_threads_whitelist_len ? <span class="hljs-number">11</span> : <span class="hljs-number">12</span>);<br>    <span class="hljs-keyword">ssize_t</span> ret = <span class="hljs-built_in">XCC_UTIL_TEMP_FAILURE_RETRY</span>(<span class="hljs-built_in">writev</span>(pipefd[<span class="hljs-number">1</span>], iovs, iovs_cnt));<br><br>    <span class="hljs-comment">// 将 stdin (fd 0) 指向管道的读端口</span><br>    <span class="hljs-built_in">XCC_UTIL_TEMP_FAILURE_RETRY</span>(<span class="hljs-built_in">dup2</span>(pipefd[<span class="hljs-number">0</span>], STDIN_FILENO));<br>    <br>    <span class="hljs-built_in">syscall</span>(SYS_close, pipefd[<span class="hljs-number">0</span>]);<br>    <span class="hljs-built_in">syscall</span>(SYS_close, pipefd[<span class="hljs-number">1</span>]);<br><br>    <span class="hljs-comment">// 加载程序 libxcrash_dumper.so 替换当前的内存空间</span><br>    <span class="hljs-built_in">execl</span>(xc_crash_dumper_pathname, XCC_UTIL_XCRASH_DUMPER_FILENAME, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">100</span> + errno;<br>&#125;<br><br><span class="hljs-comment">// libxcrash_dumper.so 的入口点，在 xcd_core.c</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span>** argv)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// 从 stdin 读取 xc_crash_spot</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != <span class="hljs-built_in">xcd_core_read_args</span>()) <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-comment">//open log file</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> &gt; (xcd_core_log_fd = <span class="hljs-built_in">XCC_UTIL_TEMP_FAILURE_RETRY</span>(<span class="hljs-built_in">open</span>(xcd_core_log_pathname, O_WRONLY | O_CLOEXEC)))) <span class="hljs-built_in">exit</span>(<span class="hljs-number">2</span>);<br><br>    <span class="hljs-comment">//create process object</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != <span class="hljs-built_in">xcd_process_create</span>(&amp;xcd_core_proc,<br>                               xcd_core_spot.crash_pid,<br>                               xcd_core_spot.crash_tid,<br>                               &amp;(xcd_core_spot.siginfo),<br>                               &amp;(xcd_core_spot.ucontext))) <span class="hljs-built_in">exit</span>(<span class="hljs-number">3</span>);<br><br>    <span class="hljs-comment">//suspend all threads in the process</span><br>    <span class="hljs-built_in">xcd_process_suspend_threads</span>(xcd_core_proc);<br><br>    <span class="hljs-comment">//load process info</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != <span class="hljs-built_in">xcd_process_load_info</span>(xcd_core_proc)) <span class="hljs-built_in">exit</span>(<span class="hljs-number">4</span>);<br><br>    <span class="hljs-comment">//record system info</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != <span class="hljs-built_in">xcd_sys_record</span>(xcd_core_log_fd,<br>                           xcd_core_spot.time_zone,<br>                           xcd_core_spot.start_time,<br>                           xcd_core_spot.crash_time,<br>                           xcd_core_app_id,<br>                           xcd_core_app_version,<br>                           xcd_core_spot.api_level,<br>                           xcd_core_os_version,<br>                           xcd_core_kernel_version,<br>                           xcd_core_abi_list,<br>                           xcd_core_manufacturer,<br>                           xcd_core_brand,<br>                           xcd_core_model,<br>                           xcd_core_build_fingerprint)) <span class="hljs-built_in">exit</span>(<span class="hljs-number">5</span>);<br><br>    <span class="hljs-comment">//record process info</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != <span class="hljs-built_in">xcd_process_record</span>(xcd_core_proc,<br>                               xcd_core_log_fd,<br>                               xcd_core_spot.logcat_system_lines,<br>                               xcd_core_spot.logcat_events_lines,<br>                               xcd_core_spot.logcat_main_lines,<br>                               xcd_core_spot.dump_elf_hash,<br>                               xcd_core_spot.dump_map,<br>                               xcd_core_spot.dump_fds,<br>                               xcd_core_spot.dump_network_info,<br>                               xcd_core_spot.dump_all_threads,<br>                               xcd_core_spot.dump_all_threads_count_max,<br>                               xcd_core_dump_all_threads_whitelist,<br>                               xcd_core_spot.api_level)) <span class="hljs-built_in">exit</span>(<span class="hljs-number">6</span>);<br><br>    <span class="hljs-comment">//resume all threads in the process</span><br>    <span class="hljs-built_in">xcd_process_resume_threads</span>(xcd_core_proc);<br><br>    <span class="hljs-comment">// exit</span><br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="Signal-Info"><a href="#Signal-Info" class="headerlink" title="Signal Info"></a>Signal Info</h3><p>打印导致 Native Crash 的 Signal 的基本信息，可以从 <code>sigaction</code> 的信号处理器（<code>xc_crash_signal_handler</code>）的参数列表里拿到（<code>siginfo_t</code>）</p>
<ul>
<li>信号码（<code>siginfo_t.si_signo</code>），比如：SIGKILL(9)、SIGSEGV(11)，更多参考 <code>man signal.7</code></li>
<li>信号错误码（<code>siginfo_t.si_code</code>），描述此信号的更详细的信息，比如对于 SIGSEGV 有以下错误码：<ul>
<li>SEGV_MAPERR Address not mapped to object.</li>
<li>SEGV_ACCERR Invalid permissions for mapped object.</li>
<li>SEGV_BNDERR (since Linux 3.19) Failed address bound checks.</li>
<li>SEGV_PKUERR (since Linux 4.6) Access was denied by memory protection keys.  See pkeys(7).  The protection key which applied to this access is available via si_pkey.</li>
</ul>
</li>
<li>SIGSEGV 会将错误地址写入 <code>siginfo_t.si_addr</code></li>
<li>有关 <code>siginfo_t</code> 的更详细信息请参考 <code>man sigaction.2</code></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">xcd_process_record_signal_info</span><span class="hljs-params">(<span class="hljs-keyword">xcd_process_t</span> *self, <span class="hljs-keyword">int</span> log_fd)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">//fault addr</span><br>    <span class="hljs-keyword">char</span> addr_desc[<span class="hljs-number">64</span>];<br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">xcc_util_signal_has_si_addr</span>(self-&gt;si))<br>    &#123;<br>        <span class="hljs-keyword">void</span> *addr = self-&gt;si-&gt;si_addr;<br>        <span class="hljs-keyword">if</span>(self-&gt;si-&gt;si_signo == SIGILL)<br>        &#123;<br>            <span class="hljs-keyword">uint32_t</span> instruction = <span class="hljs-number">0</span>;<br>            <span class="hljs-built_in">xcd_util_ptrace_read</span>(self-&gt;pid, (<span class="hljs-keyword">uintptr_t</span>)addr, &amp;instruction, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(instruction));<br>            <span class="hljs-built_in">snprintf</span>(addr_desc, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(addr_desc), <span class="hljs-string">&quot;%p (*pc=%#08x)&quot;</span>, addr, instruction);<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-built_in">snprintf</span>(addr_desc, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(addr_desc), <span class="hljs-string">&quot;%p&quot;</span>, addr);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-built_in">snprintf</span>(addr_desc, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(addr_desc), <span class="hljs-string">&quot;--------&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//from</span><br>    <span class="hljs-keyword">char</span> sender_desc[<span class="hljs-number">64</span>] = <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">xcc_util_signal_has_sender</span>(self-&gt;si, self-&gt;pid))<br>    &#123;<br>        <span class="hljs-built_in">snprintf</span>(sender_desc, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(sender_desc), <span class="hljs-string">&quot; from pid %d, uid %d&quot;</span>, self-&gt;si-&gt;si_pid, self-&gt;si-&gt;si_uid);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">xcc_util_write_format</span>(log_fd, <span class="hljs-string">&quot;signal %d (%s), code %d (%s%s), fault addr %s\n&quot;</span>,<br>                                 self-&gt;si-&gt;si_signo, <span class="hljs-built_in">xcc_util_get_signame</span>(self-&gt;si),<br>                                 self-&gt;si-&gt;si_code, <span class="hljs-built_in">xcc_util_get_sigcodename</span>(self-&gt;si),<br>                                 sender_desc, addr_desc);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0x0<br></code></pre></div></td></tr></table></figure>

<h3 id="Registers-Info"><a href="#Registers-Info" class="headerlink" title="Registers Info"></a>Registers Info</h3><p>打印寄存器（<code>Register</code>）的值，下面是 ARM64 的例子，它有 30 个通用寄存器</p>
<table>
<thead>
<tr>
<th>寄存器</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>x0</td>
<td>一般表示返回值</td>
</tr>
<tr>
<td>x1 ~ x7</td>
<td>般是函数的参数，大于 8 个的会通过堆传参</td>
</tr>
<tr>
<td>lr</td>
<td>链接寄存器，存放着函数的返回地址</td>
</tr>
<tr>
<td>sp</td>
<td>堆栈顶寄存器，用于指向每个函数调用栈的栈顶</td>
</tr>
<tr>
<td>pc</td>
<td>表示当前执行的指令的地址</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">x0  0000000000000003  x1  0000000000000000  x2  000000751128fd60  x3  0000007511290020<br>x4  000000751128fd60  x5  00000075a26c1708  x6  000000751128fd50  x7  00000075200a59dc<br>x8  0000000000000000  x9  79fc7e30c0ff4d9e  x10 00000000000003e8  x11 0000000000000000<br>x12 0000000000004100  x13 0000000000000001  x14 0000000000080100  x15 0000000000000000<br>x16 00000074b9be4d20  x17 00000074b9bcc86c  x18 00000075a57fa000  x19 00000075a4f52000<br>x20 0000000000000000  x21 00000075a4f52000  x22 0000007fe0ef23a0  x23 00000074bb1b62fe<br>x24 0000000000000004  x25 00000075a5107020  x26 00000075a4f520b0  x27 0000000000000001<br>x28 0000007fe0ef2130  x29 0000007fe0ef2090<br>sp  0000007fe0ef2070  lr  00000074b9bcc8cc  pc  00000074b9bcc884<br></code></pre></div></td></tr></table></figure>

<p>通过 <code>ptrace</code>，一个线程（<code>tracer</code>）可以观察并控制另一线程（<code>tracee</code>）的执行、读取/修改它的内存和寄存器，比如单步调试（debugger）；tracer 和 tracee 都是线程，而不是进程（虽然 ptrace 的参数里写的是 pid）；它的一般用法是这样的：</p>
<ul>
<li><code>PTRACE_ATTACH</code>：使当前线程成为 tracer，pid 指定的线程成为 tracee</li>
<li><code>waitpid</code>：PTRACE_ATTACH 发送 SIGSTOP 给 tracee 但它不一定立刻 stop，所以需要 tracer 等待 tracee</li>
<li><code>PTRACE_PEEKDATA</code>（读内存）、 <code>PTRACE_POKEDATA</code>（写内存）、<code>PTRACE_GETREGS</code>（读寄存器）、<code>PTRACE_SETREGS</code>（写寄存器）…</li>
<li><code>PTRACE_DETACH</code></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">long</span> <span class="hljs-title">ptrace</span><span class="hljs-params">(<span class="hljs-keyword">enum</span> __ptrace_request request, <span class="hljs-keyword">pid_t</span> pid, <span class="hljs-keyword">void</span> *addr, <span class="hljs-keyword">void</span> *data)</span></span>;<br><br><span class="hljs-comment">// 通过 ptrace 获取寄存器的值并保存到 xcd_thread_t.regs</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">xcd_thread_load_regs</span><span class="hljs-params">(<span class="hljs-keyword">xcd_thread_t</span> *self)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">uintptr_t</span> regs[<span class="hljs-number">64</span>]; <span class="hljs-comment">//big enough for all architectures</span><br>    <span class="hljs-keyword">size_t</span>    regs_len;<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != <span class="hljs-built_in">ptrace</span>(PTRACE_GETREGS, self-&gt;tid, <span class="hljs-literal">NULL</span>, &amp;regs))<br>    &#123;<br>        <span class="hljs-built_in">XCD_LOG_ERROR</span>(<span class="hljs-string">&quot;THREAD: ptrace GETREGS failed, errno=%d&quot;</span>, errno);<br>        self-&gt;status = XCD_THREAD_STATUS_REGS;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    regs_len = XCD_REGS_USER_NUM;<br>    <span class="hljs-built_in">xcd_regs_load_from_ptregs</span>(&amp;(self-&gt;regs), regs, regs_len);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">xcd_regs_load_from_ptregs</span><span class="hljs-params">(<span class="hljs-keyword">xcd_regs_t</span> *self, <span class="hljs-keyword">uintptr_t</span> *regs, <span class="hljs-keyword">size_t</span> regs_len)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span>(regs_len &gt; XCD_REGS_USER_NUM) regs_len = XCD_REGS_USER_NUM;<br>    <span class="hljs-built_in">memcpy</span>(&amp;(self-&gt;r), regs, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword">uintptr_t</span>) * regs_len);<br>&#125;<br><br><span class="hljs-comment">// 打印寄存器的值</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">xcd_regs_record</span><span class="hljs-params">(<span class="hljs-keyword">xcd_regs_t</span> *self, <span class="hljs-keyword">int</span> log_fd)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">xcc_util_write_format</span>(log_fd,<br>                                 <span class="hljs-string">&quot;    x0  %016lx  x1  %016lx  x2  %016lx  x3  %016lx\n&quot;</span><br>                                 <span class="hljs-string">&quot;    x4  %016lx  x5  %016lx  x6  %016lx  x7  %016lx\n&quot;</span><br>                                 <span class="hljs-string">&quot;    x8  %016lx  x9  %016lx  x10 %016lx  x11 %016lx\n&quot;</span><br>                                 <span class="hljs-string">&quot;    x12 %016lx  x13 %016lx  x14 %016lx  x15 %016lx\n&quot;</span><br>                                 <span class="hljs-string">&quot;    x16 %016lx  x17 %016lx  x18 %016lx  x19 %016lx\n&quot;</span><br>                                 <span class="hljs-string">&quot;    x20 %016lx  x21 %016lx  x22 %016lx  x23 %016lx\n&quot;</span><br>                                 <span class="hljs-string">&quot;    x24 %016lx  x25 %016lx  x26 %016lx  x27 %016lx\n&quot;</span><br>                                 <span class="hljs-string">&quot;    x28 %016lx  x29 %016lx\n&quot;</span><br>                                 <span class="hljs-string">&quot;    sp  %016lx  lr  %016lx  pc  %016lx\n\n&quot;</span>,<br>                                 self-&gt;r[XCD_REGS_X0],  self-&gt;r[XCD_REGS_X1],  self-&gt;r[XCD_REGS_X2],  self-&gt;r[XCD_REGS_X3],<br>                                 self-&gt;r[XCD_REGS_X4],  self-&gt;r[XCD_REGS_X5],  self-&gt;r[XCD_REGS_X6],  self-&gt;r[XCD_REGS_X7],<br>                                 self-&gt;r[XCD_REGS_X8],  self-&gt;r[XCD_REGS_X9],  self-&gt;r[XCD_REGS_X10], self-&gt;r[XCD_REGS_X11],<br>                                 self-&gt;r[XCD_REGS_X12], self-&gt;r[XCD_REGS_X13], self-&gt;r[XCD_REGS_X14], self-&gt;r[XCD_REGS_X15],<br>                                 self-&gt;r[XCD_REGS_X16], self-&gt;r[XCD_REGS_X17], self-&gt;r[XCD_REGS_X18], self-&gt;r[XCD_REGS_X19],<br>                                 self-&gt;r[XCD_REGS_X20], self-&gt;r[XCD_REGS_X21], self-&gt;r[XCD_REGS_X22], self-&gt;r[XCD_REGS_X23],<br>                                 self-&gt;r[XCD_REGS_X24], self-&gt;r[XCD_REGS_X25], self-&gt;r[XCD_REGS_X26], self-&gt;r[XCD_REGS_X27],<br>                                 self-&gt;r[XCD_REGS_X28], self-&gt;r[XCD_REGS_X29],<br>                                 self-&gt;r[XCD_REGS_SP],  self-&gt;r[XCD_REGS_LR],  self-&gt;r[XCD_REGS_PC]);<br>&#125;<br></code></pre></div></td></tr></table></figure>

<h3 id="Backtrace"><a href="#Backtrace" class="headerlink" title="Backtrace"></a>Backtrace</h3><h4 id="proc-pid-maps"><a href="#proc-pid-maps" class="headerlink" title="/proc/pid/maps"></a>/proc/pid/maps</h4><p><code>/proc/pid/maps</code> 包含了进程所有的内存映射（<code>mmap</code>）信息，后续的步骤需要用它来查找 <strong>函数名</strong> 及其所在的 <strong>文件路径</strong>，它的内容大概是这样的（参考 <code>man mmap.2</code> &amp; <code>man proc.5</code>）：</p>
<table>
<thead>
<tr>
<th>列</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>address</td>
<td>内存映射所在的进程的虚拟地址空间（开始地址 - 结束地址）</td>
</tr>
<tr>
<td>perms</td>
<td>这块内存的读写权限：r = read，w = write，x = execute，s = shared，p = private (copy on write)</td>
</tr>
<tr>
<td>offset</td>
<td>映射至内存的文件（或者其他东西）的起始偏移</td>
</tr>
<tr>
<td>dev</td>
<td>文件所在的设备（major:minor）</td>
</tr>
<tr>
<td>inode</td>
<td>文件的 inode</td>
</tr>
<tr>
<td>path</td>
<td>文件的路径</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">address                perms  offset    dev     inode     pathname<br>12c00000-32c00000      rw-p   00000000  00:00   0         [anon:dalvik-main space (region space)]<br>70fb9000-71248000      rw-p   00000000  00:00   0         [anon:dalvik-/apex/com.android.art/javalib/boot.art]<br>71248000-712a3000      rw-p   00000000  00:00   0         [anon:dalvik-/apex/com.android.art/javalib/boot-core-libart.art]<br>712a3000-7136f000      rw-p   00000000  00:00   0         [anon:dalvik-/apex/com.android.art/javalib/boot-core-icu4j.art]<br>7136f000-713a6000      rw-p   00000000  00:00   0         [anon:dalvik-/apex/com.android.art/javalib/boot-okhttp.art]<br>713a6000-713ea000      rw-p   00000000  00:00   0         [anon:dalvik-/apex/com.android.art/javalib/boot-bouncycastle.art]<br>713ea000-713f9000      rw-p   00000000  00:00   0         [anon:dalvik-/apex/com.android.art/javalib/boot-apache-xml.art]<br>713f9000-71479000      r--p   00000000  fc:00   150       /apex/com.android.art/javalib/arm64/boot.oat<br>...                                                       <br>7e1f72d000-7e1f778000  r--s   00000000  fc:00   2605      /system/fonts/Roboto-Medium.ttf<br>7e1f778000-7e1f779000  r--p   00000000  fc:00   6422      /system/system_ext/lib64/libqti-at.so<br>7e1f779000-7e1f77a000  r-xp   00001000  fc:00   6422      /system/system_ext/lib64/libqti-at.so<br>7e1f77a000-7e1f77b000  r--p   00002000  fc:00   6422      /system/system_ext/lib64/libqti-at.so<br>7e1f7a0000-7e1f7ab000  r--p   00000000  fc:00   6522      /system/system_ext/lib64/vendor.qti.hardware.perf@2.0.so<br>7e1f7ab000-7e1f7b5000  r-xp   0000b000  fc:00   6522      /system/system_ext/lib64/vendor.qti.hardware.perf@2.0.so<br>7e1f7b5000-7e1f7b7000  r--p   00015000  fc:00   6522      /system/system_ext/lib64/vendor.qti.hardware.perf@2.0.so<br>7e1f7b7000-7e1f7b8000  rw-p   00016000  fc:00   6522      /system/system_ext/lib64/vendor.qti.hardware.perf@2.0.so<br>7e1f86b000-7e1fb0e000  r--p   00000000  103:0f  5128711   /data/data/xcrash.sample/code_cache/.overlay/base.apk/classes.dex<br>7e1fb0e000-7e1fbd4000  r-xp   00000000  103:0f  5096166   /data/data/xcrash.sample/code_cache/startup_agents/e4ee8c59-agent.so<br>7e1fbd4000-7e1fbe3000  ---p   00000000  00:00   0         <br>7e1fbe3000-7e1fbec000  rw-p   000c5000  103:0f  5096166   /data/data/xcrash.sample/code_cache/startup_agents/e4ee8c59-agent.so<br>...                                                       <br>7e24946000-7e24987000  r--s   0001d000  103:0f  180482    /data/app/~~jln4G3nGOa7-pv4aJFN6jg==/xcrash.sample-icj_DCtDvU5ZX6MZSDcn4Q==/base.apk<br>...                                                        <br>7e347f9000-7e34800000  r--s   001be000  103:0f  180482    /data/app/~~jln4G3nGOa7-pv4aJFN6jg==/xcrash.sample-icj_DCtDvU5ZX6MZSDcn4Q==/base.apk<br>...                                                 <br></code></pre></div></td></tr></table></figure>

<h4 id="ELF"><a href="#ELF" class="headerlink" title="ELF"></a>ELF</h4><p><img src="../../../../image/2021-06-22-xcrash/elf.png" srcset="/image/loading.gif" lazyload alt="ELF Format"></p>
<p>Linux 下的可执行文件（<code>executable</code>）和共享库文件（<code>so - Shared Object</code>）都是 ELF 格式（<code>Executable and Linking Format</code>）</p>
<p><code>ELF Header</code> 里的 <code>e_type</code> 指明这是一个什么类型的文件：</p>
<table>
<thead>
<tr>
<th>e_type</th>
<th>desc</th>
</tr>
</thead>
<tbody><tr>
<td>ET_NONE</td>
<td>An unknown type</td>
</tr>
<tr>
<td>ET_REL</td>
<td>A relocatable file</td>
</tr>
<tr>
<td>ET_EXEC</td>
<td>An executable file</td>
</tr>
<tr>
<td>ET_DYN</td>
<td>A shared object</td>
</tr>
<tr>
<td>ET_CORE</td>
<td>A core file</td>
</tr>
</tbody></table>
<p>ELF 里有很多 <code>Section</code>，每个 Section 都是一段连续的地址保存了相同类型的数据，具体到哪个 Section 在哪里有多大定义在 <code>Section Header</code> 里，它的一些重要成员属性有：</p>
<table>
<thead>
<tr>
<th>Fields</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td>sh_name</td>
<td>name of the section. Its value is an index into the string section</td>
</tr>
<tr>
<td>sh_type</td>
<td>SHT_SYMTAB（符号表）、SHT_STRTAB（字符串表）等等</td>
</tr>
<tr>
<td>sh_offset</td>
<td>Section 在文件里的位置</td>
</tr>
<tr>
<td>sh_size</td>
<td>Section 的大小</td>
</tr>
</tbody></table>
<p>所有的 Section Header 组成一个数组 <code>Section Header Table</code>，它的位置和大小则是在 ELF Header 里定义的：</p>
<table>
<thead>
<tr>
<th>Fields</th>
<th>desc</th>
</tr>
</thead>
<tbody><tr>
<td>e_shoff</td>
<td>SHT 所在的位置</td>
</tr>
<tr>
<td>e_shsize</td>
<td>SHT 的大小</td>
</tr>
<tr>
<td>e_shentsize</td>
<td>每个 Section Header 的大小</td>
</tr>
<tr>
<td>e_shnum</td>
<td>Section Header 的数量</td>
</tr>
<tr>
<td>e_shstrndx</td>
<td>Name Section 在 SHT 的索引（所谓的 Name Section 其实就是专门保存字符串的 Section，类似于 dex 里的字符串池）</td>
</tr>
</tbody></table>
<p><code>Symbol Table</code> 是一个很重要的 Section，它的结构如下：</p>
<table>
<thead>
<tr>
<th>Fields</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td>st_name</td>
<td>symbol name (index of string section)</td>
</tr>
<tr>
<td>st_value</td>
<td>symbol value</td>
</tr>
<tr>
<td>st_size</td>
<td>This member holds zero if the symbol has no size or an unknown size</td>
</tr>
<tr>
<td>st_info</td>
<td>type and binding attributes <br> STT_FUNC (a function or other executable code) <br> STT_OBJECT (data object) <br> STB_LOCAL (Local symbols are not visible outside the object file) <br> STB_GLOBAL (Global symbols are visible to all object files being combined)…</td>
</tr>
<tr>
<td>st_other</td>
<td>symbol visibility <br> STV_DEFAULT (Global and weak symbols are available to other modules; references in the local module can be interposed by definitions in other modules) <br> STV_HIDDEN (Symbol is unavailable to other modules) <br> STV_PROTECTED (Symbol is available to other modules)</td>
</tr>
</tbody></table>
<p>可以用 <code>readelf</code> 命令查看 ELF 文件的结构，以 <code>/apex/com.android.art/lib64/libart.so</code> 为例，<code>readelf -S -W libart.so</code> 输出 Section Header Table</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">There are 28 section headers, starting at offset 0x7d8af8:<br><br>Section Headers:<br>  [Nr] Name              Type            Address          Off    Size   ES Flg Lk Inf Al<br>  [ 0]                   NULL            0000000000000000 000000 000000 00      0   0  0<br>  [ 1] .note.android.ident NOTE            0000000000000270 000270 000018 00   A  0   0  4<br>  [ 2] .note.gnu.build-id NOTE            0000000000000288 000288 000020 00   A  0   0  4<br>  [ 3] .dynsym           DYNSYM          00000000000002a8 0002a8 021d50 18   A  7   1  8<br>  [ 4] .gnu.version      VERSYM          0000000000021ff8 021ff8 002d1c 02   A  3   0  2<br>  [ 5] .gnu.version_r    VERNEED         0000000000024d14 024d14 000100 00   A  7   7  4<br>  [ 6] .gnu.hash         GNU_HASH        0000000000024e18 024e18 0085d4 00   A  3   0  8<br>  [ 7] .dynstr           STRTAB          000000000002d3ec 02d3ec 05c8eb 00   A  0   0  1<br>  [ 8] .rela.dyn         LOOS+0x2        0000000000089cd8 089cd8 0005f9 01   A  3   0  8<br>  [ 9] .relr.dyn         LOOS+0xfffff00  000000000008a2d8 08a2d8 000490 08   A  0   0  8<br>  [10] .rela.plt         RELA            000000000008a768 08a768 002fb8 18   A  3  21  8<br>  [11] .rodata           PROGBITS        000000000008d720 08d720 03cec6 00 AMS  0   0 16<br>  [12] .eh_frame_hdr     PROGBITS        00000000000ca5e8 0ca5e8 01083c 00   A  0   0  4<br>  [13] .eh_frame         PROGBITS        00000000000dae28 0dae28 04de74 00   A  0   0  8<br>  [14] .text             PROGBITS        0000000000129000 129000 51c160 00  AX  0   0 512<br>  [15] .plt              PROGBITS        0000000000645160 645160 001ff0 00  AX  0   0 16<br>  [16] .data.rel.ro      PROGBITS        0000000000648000 648000 00e808 00  WA  0   0  8<br>  [17] .fini_array       FINI_ARRAY      0000000000656808 656808 000010 00  WA  0   0  8<br>  [18] .init_array       INIT_ARRAY      0000000000656818 656818 000060 00  WA  0   0  8<br>  [19] .dynamic          DYNAMIC         0000000000656878 656878 0002b0 10  WA  7   0  8<br>  [20] .got              PROGBITS        0000000000656b28 656b28 000978 00  WA  0   0  8<br>  [21] .got.plt          PROGBITS        00000000006574a0 6574a0 001000 00  WA  0   0  8<br>  [22] .data             PROGBITS        00000000006594a0 6584a0 002879 00  WA  0   0  8<br>  [23] .bss              NOBITS          000000000065bd20 65ad19 002c90 00  WA  0   0  8<br>  [24] .comment          PROGBITS        0000000000000000 65ad19 00016b 01  MS  0   0  1<br>  [25] .symtab           SYMTAB          0000000000000000 65ae88 08d678 18     27 18360  8<br>  [26] .shstrtab         STRTAB          0000000000000000 6e8500 00010c 00      0   0  1<br>  [27] .strtab           STRTAB          0000000000000000 6e860c 0f04e7 00      0   0  1<br>Key to Flags:<br>  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),<br>  L (link order), O (extra OS processing required), G (group), T (TLS),<br>  C (compressed), x (unknown), o (OS specific), E (exclude),<br>  p (processor specific)<br></code></pre></div></td></tr></table></figure>

<p><code>readelf -p .dynstr libart.so</code> 输出字符串表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">String dump of section &#x27;.dynstr&#x27;:<br>  [     1]  __cxa_atexit<br>  [     e]  __cxa_finalize<br>  [    1d]  _ZN3art14AotClassLinkerC2EPNS_11InternTableE<br>  [    4a]  _ZN3art11ClassLinkerC2EPNS_11InternTableEb<br>  [    75]  _ZN3art14AotClassLinkerD2Ev<br>  [    91]  _ZN3art11ClassLinkerD2Ev<br>  [    aa]  _ZN3art14AotClassLinkerD0Ev<br>  [    c6]  _ZdlPv<br>  [    cd]  _ZN3art14AotClassLinker13CanAllocClassEv<br>  [    f6]  _ZNK3art7Runtime19IsActiveTransactionEv<br>  [   11e]  _ZN3art7Runtime34AbortTransactionAndThrowAbortErrorEPNS_6ThreadERKNSt3__112basic_stringIcNS3_11char_traitsIcEENS3_9allocatorIcEEEE<br>  [   1a1]  _ZN3art14AotClassLinker15InitializeClassEPNS_6ThreadENS_6HandleINS_6mirror5ClassEEEbb<br>  [   1f7]  _ZNK3art7Runtime29IsActiveStrictTransactionModeEv<br>  [   229]  _ZN3art11ClassLinker15InitializeClassEPNS_6ThreadENS_6HandleINS_6mirror5ClassEEEbb<br>  [   27c]  _ZNK3art2gc4Heap24ObjectIsInBootImageSpaceENS_6ObjPtrINS_6mirror6ObjectEEE<br>  [   2c7]  _ZN3art6mirror6Object12PrettyTypeOfEv<br>  [   2ed]  _ZN3art6mirror5Class16IsThrowableClassEv<br>  [   316]  _ZN7android4base10LogMessageC1EPKcjNS0_11LogSeverityES3_i<br></code></pre></div></td></tr></table></figure>

<p><code>readelf -s libart.so</code> 输出符号表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">Symbol table &#x27;.dynsym&#x27; contains 5774 entries:<br>   Num:    Value          Size Type    Bind   Vis      Ndx Name<br>     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND <br>     1: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND __cxa_atexit@LIBC (2)<br>     2: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND __cxa_finalize@LIBC (2)<br>     3: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND _ZdlPv<br>     4: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND _ZN7android4base10LogMess<br>   ...<br>   809: 0000000000132340   620 FUNC    LOCAL  HIDDEN    14 art_quick_invoke_stub<br>   810: 00000000001325b0   640 FUNC    LOCAL  HIDDEN    14 art_quick_invoke_static_s<br>   811: 000000000013ba10   292 FUNC    LOCAL  HIDDEN    14 art_quick_proxy_invoke_ha<br>   812: 000000000013c100   256 FUNC    LOCAL  HIDDEN    14 art_quick_instrumentation<br>   813: 000000000013be40   336 FUNC    LOCAL  HIDDEN    14 art_quick_generic_jni_tra<br>   814: 000000000013bfa0   248 FUNC    LOCAL  HIDDEN    14 art_quick_to_interpreter_<br>   815: 000000000013c210   480 FUNC    LOCAL  HIDDEN    14 art_quick_instrumentation<br>   816: 000000000013bd00   304 FUNC    LOCAL  HIDDEN    14 art_quick_resolution_tram<br>   817: 000000000013bb40   432 FUNC    LOCAL  HIDDEN    14 art_quick_imt_conflict_tr<br>   818: 000000000013c0a0    80 FUNC    LOCAL  HIDDEN    14 art_invoke_obsolete_metho<br>   819: 000000000013c400   164 FUNC    LOCAL  HIDDEN    14 art_quick_deoptimize<br>   ...<br></code></pre></div></td></tr></table></figure>

<h4 id="逻辑"><a href="#逻辑" class="headerlink" title="逻辑"></a>逻辑</h4><p>通过 <code>ptrace</code> 可以拿到 PC 寄存器的值，它指向正在执行的代码的地址；拿 pc 去 <code>/proc/pid/maps</code> 里找，看 pc 落在哪块 <code>mmap</code> 上，从而得知这段代码在哪个 so 文件里；so 文件是 ELF 结构，解析出它里面的符号表及其偏移，pc - mmap.start 就是这段代码在这块 mmap 上的偏移，再加上 mmap.offset 内存映射的偏移就是这段代码在 so 文件里的偏移，从而得知这段代码在哪个符号/函数里（函数名）</p>
<blockquote>
<p>但是怎么从 pc 回溯整个函数调用栈我还没有想明白</p>
</blockquote>
<h4 id="打印"><a href="#打印" class="headerlink" title="打印"></a>打印</h4><p>打印调用栈，别看代码这么长，其实关键就是这么几个：</p>
<table>
<thead>
<tr>
<th>Fields</th>
<th>Desc</th>
</tr>
</thead>
<tbody><tr>
<td>xcd_frame.rel_pc</td>
<td>函数在它所在的内存映射的偏移</td>
</tr>
<tr>
<td>xcd_frame.map.name</td>
<td>函数所在 so 文件路径</td>
</tr>
<tr>
<td>xcd_frame.func_name</td>
<td>函数名</td>
</tr>
<tr>
<td>xcd_frame.func_offset</td>
<td>函数与 pc 的偏移</td>
</tr>
</tbody></table>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">xcd_thread_record_backtrace</span><span class="hljs-params">(<span class="hljs-keyword">xcd_thread_t</span> *self, <span class="hljs-keyword">int</span> log_fd)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span>(XCD_THREAD_STATUS_OK != self-&gt;status) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">//ignore</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">xcd_frames_record_backtrace</span>(self-&gt;frames, log_fd);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">xcd_frames_record_backtrace</span><span class="hljs-params">(<span class="hljs-keyword">xcd_frames_t</span> *self, <span class="hljs-keyword">int</span> log_fd)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">xcd_frame_t</span> *frame;<br>    <span class="hljs-keyword">xcd_elf_t</span>   *elf;<br>    <span class="hljs-keyword">char</span>        *name;<br>    <span class="hljs-keyword">char</span>         name_buf[<span class="hljs-number">512</span>];<br>    <span class="hljs-keyword">char</span>        *name_embedded;<br>    <span class="hljs-keyword">char</span>        *offset;<br>    <span class="hljs-keyword">char</span>         offset_buf[<span class="hljs-number">64</span>];<br>    <span class="hljs-keyword">char</span>        *func;<br>    <span class="hljs-keyword">char</span>         func_buf[<span class="hljs-number">512</span>];<br>    <span class="hljs-keyword">int</span>          r;<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != (r = <span class="hljs-built_in">xcc_util_write_str</span>(log_fd, <span class="hljs-string">&quot;backtrace:\n&quot;</span>))) <span class="hljs-keyword">return</span> r;<br>    <br>    <span class="hljs-built_in">TAILQ_FOREACH</span>(frame, &amp;(self-&gt;frames), link)<br>    &#123;<br>        <span class="hljs-comment">//name</span><br>        name = <span class="hljs-literal">NULL</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-literal">NULL</span> == frame-&gt;map)<br>        &#123;<br>            name = <span class="hljs-string">&quot;&lt;unknown&gt;&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-literal">NULL</span> == frame-&gt;map-&gt;name || <span class="hljs-string">&#x27;\0&#x27;</span> == frame-&gt;map-&gt;name[<span class="hljs-number">0</span>])<br>        &#123;<br>            <span class="hljs-built_in">snprintf</span>(name_buf, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(name_buf), <span class="hljs-string">&quot;&lt;anonymous:%&quot;</span>XCC_UTIL_FMT_ADDR<span class="hljs-string">&quot;&gt;&quot;</span>, frame-&gt;map-&gt;start);<br>            name = name_buf;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != frame-&gt;map-&gt;elf_start_offset)<br>            &#123;<br>                elf = <span class="hljs-built_in">xcd_map_get_elf</span>(frame-&gt;map, self-&gt;pid, (<span class="hljs-keyword">void</span> *)self-&gt;maps);<br>                <span class="hljs-keyword">if</span>(<span class="hljs-literal">NULL</span> != elf)<br>                &#123;<br>                    name_embedded = <span class="hljs-built_in">xcd_elf_get_so_name</span>(elf);<br>                    <span class="hljs-keyword">if</span>(<span class="hljs-literal">NULL</span> != name_embedded &amp;&amp; <span class="hljs-built_in">strlen</span>(name_embedded) &gt; <span class="hljs-number">0</span>)<br>                    &#123;<br>                        <span class="hljs-built_in">snprintf</span>(name_buf, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(name_buf), <span class="hljs-string">&quot;%s!%s&quot;</span>, frame-&gt;map-&gt;name, name_embedded);<br>                        name = name_buf;<br>                    &#125;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-literal">NULL</span> == name) name = frame-&gt;map-&gt;name;<br>        &#125;<br><br>        <span class="hljs-comment">//offset</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-literal">NULL</span> != frame-&gt;map &amp;&amp; <span class="hljs-number">0</span> != frame-&gt;map-&gt;elf_start_offset)<br>        &#123;<br>            <span class="hljs-built_in">snprintf</span>(offset_buf, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(offset_buf), <span class="hljs-string">&quot; (offset 0x%&quot;</span>PRIxPTR<span class="hljs-string">&quot;)&quot;</span>, frame-&gt;map-&gt;elf_start_offset);<br>            offset = offset_buf;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            offset = <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-comment">//func</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-literal">NULL</span> != frame-&gt;func_name)<br>        &#123;<br>            <span class="hljs-keyword">if</span>(frame-&gt;func_offset &gt; <span class="hljs-number">0</span>)<br>                <span class="hljs-built_in">snprintf</span>(func_buf, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(func_buf), <span class="hljs-string">&quot; (%s+%zu)&quot;</span>, frame-&gt;func_name, frame-&gt;func_offset);<br>            <span class="hljs-keyword">else</span><br>                <span class="hljs-built_in">snprintf</span>(func_buf, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(func_buf), <span class="hljs-string">&quot; (%s)&quot;</span>, frame-&gt;func_name);<br>            func = func_buf;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            func = <span class="hljs-string">&quot;&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != (r = <span class="hljs-built_in">xcc_util_write_format</span>(log_fd, <span class="hljs-string">&quot;    #%02zu pc %0&quot;</span>XCC_UTIL_FMT_ADDR<span class="hljs-string">&quot;  %s%s%s\n&quot;</span>,<br>                                           frame-&gt;num, frame-&gt;rel_pc, name, offset, func))) <span class="hljs-keyword">return</span> r;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != (r = <span class="hljs-built_in">xcc_util_write_str</span>(log_fd, <span class="hljs-string">&quot;\n&quot;</span>))) <span class="hljs-keyword">return</span> r;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>

<p>输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">backtrace:<br>    #00 pc 000000000000b884  /data/app/xcrash.sample-WeCpVYjROKKgYtuzbHflHg==/lib/arm64/libxcrash.so (xc_test_call_4+24)<br>    #01 pc 000000000000b8c8  /data/app/xcrash.sample-WeCpVYjROKKgYtuzbHflHg==/lib/arm64/libxcrash.so (xc_test_call_3+24)<br>    #02 pc 000000000000b8f8  /data/app/xcrash.sample-WeCpVYjROKKgYtuzbHflHg==/lib/arm64/libxcrash.so (xc_test_call_2+24)<br>    #03 pc 000000000000b920  /data/app/xcrash.sample-WeCpVYjROKKgYtuzbHflHg==/lib/arm64/libxcrash.so (xc_test_call_1+16)<br>    #04 pc 000000000000b9b4  /data/app/xcrash.sample-WeCpVYjROKKgYtuzbHflHg==/lib/arm64/libxcrash.so (xc_test_crash+124)<br>    #05 pc 000000000013f350  /apex/com.android.runtime/lib64/libart.so (art_quick_generic_jni_trampoline+144)<br>    #06 pc 00000000001365b8  /apex/com.android.runtime/lib64/libart.so (art_quick_invoke_static_stub+568)<br>    #07 pc 0000000000145084  /apex/com.android.runtime/lib64/libart.so (_ZN3art9ArtMethod6InvokeEPNS_6ThreadEPjjPNS_6JValueEPKc+276)<br>    #08 pc 00000000002e3bc0  /apex/com.android.runtime/lib64/libart.so (_ZN3art11interpreter34ArtInterpreterToCompiledCodeBridgeEPNS_6ThreadEPNS_9ArtMethodEPNS_11ShadowFrameEtPNS_6JValueE+384)<br>    #09 pc 00000000002deab8  /apex/com.android.runtime/lib64/libart.so (_ZN3art11interpreter6DoCallILb0ELb0EEEbPNS_9ArtMethodEPNS_6ThreadERNS_11ShadowFrameEPKNS_11InstructionEtPNS_6JValueE+928)<br>    #10 pc 00000000005a4e3c  /apex/com.android.runtime/lib64/libart.so (MterpInvokeStatic+368)<br>    #11 pc 0000000000130994  /apex/com.android.runtime/lib64/libart.so (mterp_op_invoke_static+20)<br>    #12 pc 00000000005a2564  /apex/com.android.runtime/lib64/libart.so (MterpInvokeVirtual+1456)<br>    #13 pc 0000000000130814  /apex/com.android.runtime/lib64/libart.so (mterp_op_invoke_virtual+20)<br>    #14 pc 00000000005a5154  /apex/com.android.runtime/lib64/libart.so (MterpInvokeStatic+1160)<br>    #15 pc 0000000000130994  /apex/com.android.runtime/lib64/libart.so (mterp_op_invoke_static+20)<br>    ...<br></code></pre></div></td></tr></table></figure>

<h3 id="Stack-Per-Frame"><a href="#Stack-Per-Frame" class="headerlink" title="Stack (Per Frame)"></a>Stack (Per Frame)</h3><p>这里打印的是上个章节 <code>Backtrace</code> 描述的函数调用栈里，每一帧（<code>Frame</code>）对应的栈内存，sp 寄存器指向栈顶</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">stack:<br>         0000007fe0ef1ff0  0000000be0ef2260<br>         0000007fe0ef1ff8  00000075a5107020<br>         0000007fe0ef2000  0000007fe0ef2001  [stack]<br>         0000007fe0ef2008  0000007511197000<br>         0000007fe0ef2010  00000000000fd000<br>         0000007fe0ef2018  0000007511290018<br>         0000007fe0ef2020  0000007511197000<br>         0000007fe0ef2028  0000007511290018<br>         0000007fe0ef2030  0000007f00000000<br>         0000007fe0ef2038  0000007511197000<br>         0000007fe0ef2040  00000000000f8d50<br>         0000007fe0ef2048  0000000000001000<br>         0000007fe0ef2050  0000000000000000<br>         0000007fe0ef2058  0000000000000000<br>         0000007fe0ef2060  00000075a4ff8000  [anon:libc_malloc]<br>         0000007fe0ef2068  000000006f5df020  /system/framework/arm64/boot-framework.art<br>    #00  0000007fe0ef2070  0000000000000000<br>         0000007fe0ef2078  000000030000ddd5<br>    #01  0000007fe0ef2080  0000007fe0ef2130  [stack]<br>         0000007fe0ef2088  0000000200000001<br>         0000007fe0ef2090  0000007fe0ef20b0  [stack]<br>         0000007fe0ef2098  00000074b9bcc8fc  /data/app/xcrash.sample-WeCpVYjROKKgYtuzbHflHg==/lib/arm64/libxcrash.so (xc_test_call_2+28)<br>    #02  0000007fe0ef20a0  0000000000000004<br>         0000007fe0ef20a8  0000000100000000<br>         0000007fe0ef20b0  0000007fe0ef20d0  [stack]<br></code></pre></div></td></tr></table></figure>

<h3 id="Memory-Near-XX"><a href="#Memory-Near-XX" class="headerlink" title="Memory Near XX"></a>Memory Near XX</h3><p>打印所有寄存器地址附近的内存，寄存器的值可以通过 <code>ptrace</code> 拿到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">memory near x2:<br>    000000751128fd40 0000000000000000 0000000000000000  ................<br>    000000751128fd50 000000751138cd50 0000000000000000  P.8.u...........<br>    000000751128fd60 00005015000050c4 0000007f00000000  .P...P..........<br>    000000751128fd70 0000007511197000 00000000000f8d50  .p..u...P.......<br>    000000751128fd80 0000000000001000 0000000000000000  ................<br>    000000751128fd90 0000000000000000 00000075a4ff8000  ............u...<br>    000000751128fda0 0000000000000003 0000000000000000  ................<br>    000000751128fdb0 00000074b9bcc9dc 0000000000000000  ....t...........<br>    000000751128fdc0 0000000000000000 00000075a4e67000  .........p..u...<br>    000000751128fdd0 00000074c5b3b000 0000000000000001  ....t...........<br>    000000751128fde0 0000007511197000 00000000000fd000  .p..u...........<br>    000000751128fdf0 0000000000000000 0000000000000000  ................<br>    000000751128fe00 0000000000000000 0000000000000000  ................<br>    000000751128fe10 0000000000000000 0000000000000000  ................<br>    000000751128fe20 0000000000000000 0000000000000000  ................<br>    000000751128fe30 0000000000000000 0000000000000000  ................<br><br>memory near x3:<br>    0000007511290000 0000007511290060 0000000000000000  `.).u...........<br>    0000007511290010 0000000000000000 0000007511290060  ........`.).u...<br>    0000007511290020 00000075a2606c90 000000751128fd50  .l`.u...P.(.u...<br>    0000007511290030 0000000000000000 0000000000000000  ................<br>    0000007511290040 0000000000000000 79fc7e30c0ff4d9e  .........M..0~.y<br>    0000007511290050 0000000000000000 0000000000000000  ................<br>    0000007511290060 0000000000000000 0000000000000000  ................<br>    0000007511290070 0000000000000000 0000000000000000  ................<br>    0000007511290080 0000000000000000 0000000000000000  ................<br>    0000007511290090 0000000000000000 0000000000000000  ................<br>    00000075112900a0 0000000000000000 0000000000000000  ................<br>    00000075112900b0 0000000000000000 0000000000000000  ................<br>    00000075112900c0 0000000000000000 0000000000000000  ................<br>    00000075112900d0 0000000000000000 0000000000000000  ................<br>    00000075112900e0 0000000000000000 0000000000000000  ................<br>    00000075112900f0 0000000000000000 0000000000000000  ................<br></code></pre></div></td></tr></table></figure>

<h3 id="Memory-Map"><a href="#Memory-Map" class="headerlink" title="Memory Map"></a>Memory Map</h3><p>也就是 <code>/proc/pid/maps</code> 内存映射</p>
<figure class="highlight plaintext"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs text">memory map:<br>    0000000012c00000-00000000133c0000 rw-        0   7c0000 [anon:dalvik-main space (region space)]<br>    00000000133c0000-0000000013dc0000 ---        0   a00000 &gt;<br>    0000000013dc0000-0000000013f80000 ---        0   1c0000 &gt;<br>    0000000013f80000-0000000013fc0000 rw-        0    40000 &gt;<br>    0000000013fc0000-0000000014100000 ---        0   140000 &gt;<br>    0000000014100000-0000000014140000 rw-        0    40000 &gt;<br>    0000000014140000-0000000014200000 ---        0    c0000 &gt;<br>    0000000014200000-0000000014280000 ---        0    80000 &gt;<br>    0000000014280000-00000000163c0000 ---        0  2140000 &gt;<br>    00000000163c0000-0000000032c00000 rw-        0 1c840000 &gt;<br>    000000006f1a9000-000000006f430000 rw-        0   287000 /system/framework/arm64/boot.art<br>    000000006f430000-000000006f51f000 rw-        0    ef000 /system/framework/arm64/boot-core-libart.art<br>    000000006f51f000-000000006f555000 rw-        0    36000 /system/framework/arm64/boot-okhttp.art<br>    000000006f555000-000000006f596000 rw-        0    41000 /system/framework/arm64/boot-bouncycastle.art<br>    000000006f596000-000000006f5a6000 rw-        0    10000 /system/framework/arm64/boot-apache-xml.art<br>    000000006f5a6000-000000006fe62000 rw-        0   8bc000 /system/framework/arm64/boot-framework.art<br>    000000006fe62000-000000006fe95000 rw-        0    33000 /system/framework/arm64/boot-ext.art<br>    000000006fe95000-000000006ff8c000 rw-        0    f7000 /system/framework/arm64/boot-telephony-common.art<br>    000000006ff8c000-000000006ff9a000 rw-        0     e000 /system/framework/arm64/boot-voip-common.art<br>    000000006ff9a000-000000006ffaf000 rw-        0    15000 /system/framework/arm64/boot-ims-common.art<br>    000000006ffaf000-000000006ffb2000 rw-        0     3000 /system/framework/arm64/boot-android.test.base.art<br>    000000006ffb2000-000000007006b000 r--        0    b9000 /system/framework/arm64/boot.oat<br>    000000007006b000-0000000070300000 r-x    b9000   295000 &gt;<br>    0000000070300000-0000000070301000 rw-        0     1000 [anon:.bss]<br>    0000000070301000-0000000070303000 r--        0     2000 /system/framework/boot.vdex<br>    0000000070303000-0000000070304000 r--   34e000     1000 /system/framework/arm64/boot.oat<br>    0000000070304000-0000000070305000 rw-   34f000     1000 &gt;<br>    0000000070305000-000000007034e000 r--        0    49000 /system/framework/arm64/boot-core-libart.oat<br>    000000007034e000-0000000070453000 r-x    49000   105000 &gt;<br>    0000000070453000-0000000070454000 rw-        0     1000 [anon:.bss]<br>    0000000070454000-0000000070455000 r--        0     1000 /system/framework/boot-core-libart.vdex<br>    0000000070455000-0000000070456000 r--   14e000     1000 /system/framework/arm64/boot-core-libart.oat<br>    0000000070456000-0000000070457000 rw-   14f000     1000 &gt;<br>    0000000070457000-0000000070466000 r--        0     f000 /system/framework/arm64/boot-okhttp.oat<br></code></pre></div></td></tr></table></figure>


<h2 id="ANR-Trace"><a href="#ANR-Trace" class="headerlink" title="ANR Trace"></a>ANR Trace</h2><ol>
<li>给主线程注册 <code>SIGQUIT</code> 的信号处理器 <code>xc_trace_handler</code>，当主线程收到 SIGQUIT 信号时，恢复 <code>xc_trace_dumper</code>（dumper 线程），也就是说发生 ANR 时主线程是被 SIGQUIT 中断的而不是 SIGKILL (?)</li>
<li>启动 xc_trace_dumper（dumper 线程），挂起等待被主线程唤醒</li>
<li>在内存里找到生成 ANR 报告的函数符号：<code>_ZN3art7Runtime14DumpForSigQuitERNSt3__113basic_ostreamIcNS1_11char_traitsIcEEEE</code></li>
<li>将 <code>STDERR_FILENO</code> 指向日志文件，调用 ANR 报告函数（它会把 ANR 日志写入 <code>STDERR_FILENO</code>），这样就捕获了 ANR 日志</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs cpp"><span class="hljs-comment">// XCrash.init</span><br><span class="hljs-comment">// NativeHandler.initialize</span><br><span class="hljs-comment">// NativeHandler.nativeInit</span><br><span class="hljs-comment">// xc_jni_init</span><br><br><span class="hljs-comment">// 起 dumper 线程，注册 SIGQUIT 处理器</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">xc_trace_init</span><span class="hljs-params">(JNIEnv *env,</span></span><br><span class="hljs-params"><span class="hljs-function">                  <span class="hljs-keyword">int</span> rethrow,</span></span><br><span class="hljs-params"><span class="hljs-function">                  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> logcat_system_lines,</span></span><br><span class="hljs-params"><span class="hljs-function">                  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> logcat_events_lines,</span></span><br><span class="hljs-params"><span class="hljs-function">                  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> logcat_main_lines,</span></span><br><span class="hljs-params"><span class="hljs-function">                  <span class="hljs-keyword">int</span> dump_fds,</span></span><br><span class="hljs-params"><span class="hljs-function">                  <span class="hljs-keyword">int</span> dump_network_info)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> r;<br>    <span class="hljs-keyword">pthread_t</span> thd;<br><br>    <span class="hljs-comment">//capture SIGQUIT only for ART</span><br>    <span class="hljs-keyword">if</span>(xc_common_api_level &lt; <span class="hljs-number">21</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">//is Android Lollipop (5.x)?</span><br>    xc_trace_is_lollipop = ((<span class="hljs-number">21</span> == xc_common_api_level || <span class="hljs-number">22</span> == xc_common_api_level) ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>);<br><br>    xc_trace_dump_status = XC_TRACE_DUMP_NOT_START;<br>    xc_trace_rethrow = rethrow;<br>    xc_trace_logcat_system_lines = logcat_system_lines;<br>    xc_trace_logcat_events_lines = logcat_events_lines;<br>    xc_trace_logcat_main_lines = logcat_main_lines;<br>    xc_trace_dump_fds = dump_fds;<br>    xc_trace_dump_network_info = dump_network_info;<br><br>    <span class="hljs-comment">//init for JNI callback</span><br>    <span class="hljs-built_in">xc_trace_init_callback</span>(env);<br><br>    <span class="hljs-comment">//create event FD</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> &gt; (xc_trace_notifier = <span class="hljs-built_in">eventfd</span>(<span class="hljs-number">0</span>, EFD_CLOEXEC))) <span class="hljs-keyword">return</span> XCC_ERRNO_SYS;<br><br>    <span class="hljs-comment">//register signal handler</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != (r = <span class="hljs-built_in">xcc_signal_trace_register</span>(xc_trace_handler))) <span class="hljs-keyword">goto</span> err2;<br><br>    <span class="hljs-comment">//create thread for dump trace</span><br>    <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != (r = <span class="hljs-built_in">pthread_create</span>(&amp;thd, <span class="hljs-literal">NULL</span>, xc_trace_dumper, <span class="hljs-literal">NULL</span>))) <span class="hljs-keyword">goto</span> err1;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br> err1:<br>    <span class="hljs-built_in">xcc_signal_trace_unregister</span>();<br> err2:<br>    <span class="hljs-built_in">close</span>(xc_trace_notifier);<br>    xc_trace_notifier = <span class="hljs-number">-1</span>;<br>    <br>    <span class="hljs-keyword">return</span> r;<br>&#125;<br><br><span class="hljs-comment">// ANR 发生时，收到 SIGQUIT，此 dumper 线程唤醒，调用 ANR 报告函数</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> *<span class="hljs-title">xc_trace_dumper</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    JNIEnv         *env = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-keyword">uint64_t</span>        data;<br>    <span class="hljs-keyword">uint64_t</span>        trace_time;<br>    <span class="hljs-keyword">int</span>             fd;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timeval</span>  <span class="hljs-title">tv</span>;</span><br>    <span class="hljs-keyword">char</span>            pathname[<span class="hljs-number">1024</span>];<br>    jstring         j_pathname;<br>    <br>    (<span class="hljs-keyword">void</span>)arg;<br>    <br>    <span class="hljs-built_in">pthread_detach</span>(<span class="hljs-built_in">pthread_self</span>());<br><br>    JavaVMAttachArgs attach_args = &#123;<br>        .version = XC_JNI_VERSION,<br>        .name    = <span class="hljs-string">&quot;xcrash_trace_dp&quot;</span>,<br>        .group   = <span class="hljs-literal">NULL</span><br>    &#125;;<br>    <span class="hljs-keyword">if</span>(JNI_OK != (*xc_common_vm)-&gt;<span class="hljs-built_in">AttachCurrentThread</span>(xc_common_vm, &amp;env, &amp;attach_args)) <span class="hljs-keyword">goto</span> exit;<br><br>    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-comment">//block here, waiting for sigquit</span><br>        <span class="hljs-built_in">XCC_UTIL_TEMP_FAILURE_RETRY</span>(<span class="hljs-built_in">read</span>(xc_trace_notifier, &amp;data, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(data)));<br>        <br>        <span class="hljs-comment">//check if process already crashed</span><br>        <span class="hljs-keyword">if</span>(xc_common_native_crashed || xc_common_java_crashed) <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-comment">//trace time</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != <span class="hljs-built_in">gettimeofday</span>(&amp;tv, <span class="hljs-literal">NULL</span>)) <span class="hljs-keyword">break</span>;<br>        trace_time = (<span class="hljs-keyword">uint64_t</span>)(tv.tv_sec) * <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span> + (<span class="hljs-keyword">uint64_t</span>)tv.tv_usec;<br><br>        <span class="hljs-comment">//Keep only one current trace.</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != <span class="hljs-built_in">xc_trace_logs_clean</span>()) <span class="hljs-keyword">continue</span>;<br><br>        <span class="hljs-comment">//create and open log file</span><br>        <span class="hljs-keyword">if</span>((fd = <span class="hljs-built_in">xc_common_open_trace_log</span>(pathname, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(pathname), trace_time)) &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;<br><br>        <span class="hljs-comment">//write header info</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != <span class="hljs-built_in">xc_trace_write_header</span>(fd, trace_time)) <span class="hljs-keyword">goto</span> end;<br><br>        <span class="hljs-comment">//write trace info from ART runtime</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != <span class="hljs-built_in">xcc_util_write_format</span>(fd, XCC_UTIL_THREAD_SEP<span class="hljs-string">&quot;Cmd line: %s\n&quot;</span>, xc_common_process_name)) <span class="hljs-keyword">goto</span> end;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != <span class="hljs-built_in">xcc_util_write_str</span>(fd, <span class="hljs-string">&quot;Mode: ART DumpForSigQuit\n&quot;</span>)) <span class="hljs-keyword">goto</span> end;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != <span class="hljs-built_in">xc_trace_load_symbols</span>())<br>        &#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != <span class="hljs-built_in">xcc_util_write_str</span>(fd, <span class="hljs-string">&quot;Failed to load symbols.\n&quot;</span>)) <span class="hljs-keyword">goto</span> end;<br>            <span class="hljs-keyword">goto</span> skip;<br>        &#125;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != <span class="hljs-built_in">xc_trace_check_address_valid</span>())<br>        &#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != <span class="hljs-built_in">xcc_util_write_str</span>(fd, <span class="hljs-string">&quot;Failed to check runtime address.\n&quot;</span>)) <span class="hljs-keyword">goto</span> end;<br>            <span class="hljs-keyword">goto</span> skip;<br>        &#125;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">dup2</span>(fd, STDERR_FILENO) &lt; <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != <span class="hljs-built_in">xcc_util_write_str</span>(fd, <span class="hljs-string">&quot;Failed to duplicate FD.\n&quot;</span>)) <span class="hljs-keyword">goto</span> end;<br>            <span class="hljs-keyword">goto</span> skip;<br>        &#125;<br><br>        xc_trace_dump_status = XC_TRACE_DUMP_ON_GOING;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">sigsetjmp</span>(jmpenv, <span class="hljs-number">1</span>) == <span class="hljs-number">0</span>) <br>        &#123;<br>            <span class="hljs-keyword">if</span>(xc_trace_is_lollipop)<br>                <span class="hljs-built_in">xc_trace_libart_dbg_suspend</span>();<br>            <span class="hljs-built_in">xc_trace_libart_runtime_dump</span>(*xc_trace_libart_runtime_instance, xc_trace_libcpp_cerr);<br>            <span class="hljs-keyword">if</span>(xc_trace_is_lollipop)<br>                <span class="hljs-built_in">xc_trace_libart_dbg_resume</span>();<br>        &#125; <br>        <span class="hljs-keyword">else</span> <br>        &#123;<br>            <span class="hljs-built_in">fflush</span>(<span class="hljs-literal">NULL</span>);<br>            <span class="hljs-built_in">XCD_LOG_WARN</span>(<span class="hljs-string">&quot;longjmp to skip dumping trace\n&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-built_in">dup2</span>(xc_common_fd_null, STDERR_FILENO);<br>                            <br>    skip:<br>        <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != <span class="hljs-built_in">xcc_util_write_str</span>(fd, <span class="hljs-string">&quot;\n&quot;</span>XCC_UTIL_THREAD_END<span class="hljs-string">&quot;\n&quot;</span>)) <span class="hljs-keyword">goto</span> end;<br><br>        <span class="hljs-comment">//write other info</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != <span class="hljs-built_in">xcc_util_record_logcat</span>(fd, xc_common_process_id, xc_common_api_level, xc_trace_logcat_system_lines, xc_trace_logcat_events_lines, xc_trace_logcat_main_lines)) <span class="hljs-keyword">goto</span> end;<br>        <span class="hljs-keyword">if</span>(xc_trace_dump_fds)<br>            <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != <span class="hljs-built_in">xcc_util_record_fds</span>(fd, xc_common_process_id)) <span class="hljs-keyword">goto</span> end;<br>        <span class="hljs-keyword">if</span>(xc_trace_dump_network_info)<br>            <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != <span class="hljs-built_in">xcc_util_record_network_info</span>(fd, xc_common_process_id, xc_common_api_level)) <span class="hljs-keyword">goto</span> end;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-number">0</span> != <span class="hljs-built_in">xcc_meminfo_record</span>(fd, xc_common_process_id)) <span class="hljs-keyword">goto</span> end;<br><br>    end:<br>        <span class="hljs-comment">//close log file</span><br>        <span class="hljs-built_in">xc_common_close_trace_log</span>(fd);<br><br>        <span class="hljs-comment">//rethrow SIGQUIT to ART Signal Catcher</span><br>        <span class="hljs-keyword">if</span>(xc_trace_rethrow &amp;&amp; (XC_TRACE_DUMP_ART_CRASH != xc_trace_dump_status)) <span class="hljs-built_in">xc_trace_send_sigquit</span>();<br>        xc_trace_dump_status = XC_TRACE_DUMP_END;<br><br>        <span class="hljs-comment">//JNI callback</span><br>        <span class="hljs-comment">//Do we need to implement an emergency buffer for disk exhausted?</span><br>        <span class="hljs-keyword">if</span>(<span class="hljs-literal">NULL</span> == xc_trace_cb_method) <span class="hljs-keyword">continue</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-literal">NULL</span> == (j_pathname = (*env)-&gt;<span class="hljs-built_in">NewStringUTF</span>(env, pathname))) <span class="hljs-keyword">continue</span>;<br>        (*env)-&gt;<span class="hljs-built_in">CallStaticVoidMethod</span>(env, xc_common_cb_class, xc_trace_cb_method, j_pathname, <span class="hljs-literal">NULL</span>);<br>        <span class="hljs-built_in">XC_JNI_IGNORE_PENDING_EXCEPTION</span>();<br>        (*env)-&gt;<span class="hljs-built_in">DeleteLocalRef</span>(env, j_pathname);<br>    &#125;<br>    <br>    (*xc_common_vm)-&gt;<span class="hljs-built_in">DetachCurrentThread</span>(xc_common_vm);<br><br> exit:<br>    xc_trace_notifier = <span class="hljs-number">-1</span>;<br>    <span class="hljs-built_in">close</span>(xc_trace_notifier);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br></code></pre></div></td></tr></table></figure>
            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Library/">Library</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/uncaught-exception/">uncaught exception</a>
                    
                      <a class="hover-with-bg" href="/tags/exception/">exception</a>
                    
                      <a class="hover-with-bg" href="/tags/%E5%B4%A9%E6%BA%83/">崩溃</a>
                    
                      <a class="hover-with-bg" href="/tags/%E5%B4%A9%E6%BA%83%E6%97%A5%E5%BF%97/">崩溃日志</a>
                    
                      <a class="hover-with-bg" href="/tags/crash/">crash</a>
                    
                      <a class="hover-with-bg" href="/tags/xcrash/">xcrash</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/06/28/deep-drive-into-anr/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">深入 ANR：产生的根源、处理流程和日志文件</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/06/20/kill-exit/">
                        <span class="hidden-mobile">killProcess 和 exit 的区别</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>



  <script  src="/js/local-search.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>












  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?7d0c9146781b5fb9ae68cfc826d0be54";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
