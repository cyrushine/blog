

<!DOCTYPE html>
<html lang="zh-CN" >



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/image/favicon.png">
  <link rel="icon" href="/image/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#141414">
  <meta name="author" content="Cyrus">
  <meta name="keywords" content="">
  
    <meta name="description" content="堆内存分配失败导致的 OOM度量采用下述 API 来度量 APP 或系统的内存使用情况    类别 API 说明    APP Runtime.maxMemory() JVM 可以从系统那申请到的内存的最大值，ActivityManager.getMemoryClass() 和 ActivityManager.getLargeMemoryClass() 其中之一，超过此阈值会发生 OOM    R">
<meta property="og:type" content="article">
<meta property="og:title" content="深入 OOM">
<meta property="og:url" content="https://www.dalvik.work/2021/04/16/looking-into-oom/index.html">
<meta property="og:site_name" content="Cyrus Blog">
<meta property="og:description" content="堆内存分配失败导致的 OOM度量采用下述 API 来度量 APP 或系统的内存使用情况    类别 API 说明    APP Runtime.maxMemory() JVM 可以从系统那申请到的内存的最大值，ActivityManager.getMemoryClass() 和 ActivityManager.getLargeMemoryClass() 其中之一，超过此阈值会发生 OOM    R">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.dalvik.work/image/2021-04-16-looking-into-oom/oom_memory_log.png">
<meta property="og:image" content="https://www.dalvik.work/image/2021-04-16-looking-into-oom/oom_memory.png">
<meta property="article:published_time" content="2021-04-16T04:00:00.000Z">
<meta property="article:modified_time" content="2022-06-24T02:46:46.801Z">
<meta property="article:author" content="Cyrus">
<meta property="article:tag" content="OOM">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://www.dalvik.work/image/2021-04-16-looking-into-oom/oom_memory_log.png">
  
  
  
  <title>深入 OOM - Cyrus Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  



  
<link rel="stylesheet" href="/css/custom.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"www.dalvik.work","root":"/","version":"1.9.2","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#91cb3e","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":99},"lazyload":{"enable":true,"loading_img":"/image/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":"7d0c9146781b5fb9ae68cfc826d0be54","google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 30vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Cyrus Land</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/image/sunset_sea.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">深入 OOM</span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2021-04-16 04:00" pubdate>
          2021年4月16日
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          17k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          140 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">深入 OOM</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="堆内存分配失败导致的-OOM"><a href="#堆内存分配失败导致的-OOM" class="headerlink" title="堆内存分配失败导致的 OOM"></a>堆内存分配失败导致的 OOM</h2><h3 id="度量"><a href="#度量" class="headerlink" title="度量"></a>度量</h3><p>采用下述 API 来度量 APP 或系统的内存使用情况</p>
<table>
<thead>
<tr>
<th>类别</th>
<th>API</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>APP</td>
<td>Runtime.maxMemory()</td>
<td>JVM 可以从系统那申请到的内存的最大值，<code>ActivityManager.getMemoryClass()</code> 和 <code>ActivityManager.getLargeMemoryClass()</code> 其中之一，超过此阈值会发生 OOM</td>
</tr>
<tr>
<td></td>
<td>Runtime.totalMemory()</td>
<td>JVM 已申请到的内存大小，小于等于 <code>Runtime.maxMemory()</code> 且大于 <code>Runtime.freeMemory()</code>；当需要的内存（比如创建 1M 的字节数组）超过 <code>Runtime.freeMemory()</code> 时 JVM 会向系统申请内存，此时 <code>Runtime.totalMemory()</code> 会逐渐增大；直到等于 <code>Runtime.maxMemory()</code> 时，如果需要的内存超过 <code>Runtime.freeMemory()</code> 则抛出 OOM</td>
</tr>
<tr>
<td></td>
<td>Runtime.freeMemory()</td>
<td>JVM 已申请到但仍未使用的内存，当需要的内存超过此值时，JVM 会向系统申请内存</td>
</tr>
<tr>
<td></td>
<td>ActivityManager.getMemoryClass()</td>
<td>APP 可申请的内存上限</td>
</tr>
<tr>
<td></td>
<td>ActivityManager.getLargeMemoryClass()</td>
<td>设置 <code>android:largeHeap=&quot;true&quot;</code> 后 APP 可申请的内存上限，一般是 <code>ActivityManager.getLargeMemoryClass()</code> 的两倍</td>
</tr>
<tr>
<td>system</td>
<td>ActivityManager.MemoryInfo.availMem</td>
<td>当前系统可用内存大小，即设置里可用运存的值</td>
</tr>
<tr>
<td></td>
<td>ActivityManager.MemoryInfo.totalMem</td>
<td>系统总内存大小，即设置里运存总空间的值</td>
</tr>
<tr>
<td></td>
<td>ActivityManager.MemoryInfo.lowMemory</td>
<td>标识系统是否处于低内存状态</td>
</tr>
<tr>
<td></td>
<td>ActivityManager.MemoryInfo.threshold</td>
<td>当系统可用内存小于此阈值时，系统处于低内存状态</td>
</tr>
<tr>
<td>虚拟机配置项</td>
<td>dalvik.vm.heapgrowthlimit</td>
<td>默认情况下 App 可使用的 Heap 的最大值，比如 256m, 超过这个值就会产生 OOM</td>
</tr>
<tr>
<td></td>
<td>dalvik.vm.heapsize</td>
<td>如果配置了 largeHeap 则 App 可使用的 Heap 的最大值为此项设定值，比如 512m</td>
</tr>
<tr>
<td></td>
<td>dalvik.vm.heapstartsize</td>
<td>App 启动后系统分配给它的 Heap 初始大小，随着App使用可增加</td>
</tr>
<tr>
<td></td>
<td></td>
<td>以上配置项可以通过 <code>cat /system/build.prop</code> 或者 <code>adb shell getprop dalvik.vm.heapsize</code> 获取</td>
</tr>
</tbody></table>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>使用下面的测试代码在我的测试机（iQOO 3）上，循环申请 30M/5M/500K 的内存，每次间隔 1s 并打印内存统计情况</p>
<p>可以看到 JVM 使用内存上限 <code>max</code> 是 256M（刚好是 <code>memoryClass</code>，如果配置了 <code>largeHeap=&quot;true&quot;</code> 则是 <code>largeMemoryClass</code>），已申请内存 <code>total</code> 逐步上升直到 256M，<code>total</code> - <code>free</code> 等于申请内存的累计量；运行内存为 11.36GB，可用运存徘徊在 5GB 左右，当运存掉到 216M 时进入低内存状态，所以目前并不是低内存；APP 可申请内存上限为 256MB，设置 <code>largeHeap=&quot;true&quot;</code> 后翻倍到 512MB</p>
<p>抛出 OOM 时的信息为：<code>Failed to allocate a 512016 byte allocation with 22760 free bytes and 22KB until OOM, target footprint 268435456, growth limit 268435456</code></p>
<p>参考日志的最后一行，当时正在申请 500KB 的内存（<code>Failed to allocate a 512016 byte allocation</code>），还剩 14.95KB（<code>with 22760 free bytes and 22KB until OOM</code>），上限是 256MB（<code>target footprint 268435456, growth limit 268435456</code>）</p>
<div class="code-wrapper"><pre><code class="hljs kotlin"><span class="hljs-comment">// 循环申请内存直到 OOM</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">mallocJVM</span><span class="hljs-params">()</span></span> &#123;
    <span class="hljs-keyword">val</span> steps = arrayOf(<span class="hljs-number">1024L</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">30</span>, <span class="hljs-number">1024L</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">5</span>, <span class="hljs-number">1024L</span> * <span class="hljs-number">500</span>)
    <span class="hljs-keyword">val</span> pool = mutableListOf&lt;ByteArray&gt;()
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;
        <span class="hljs-keyword">val</span> runtime = Runtime.getRuntime()
        <span class="hljs-keyword">val</span> free = runtime.maxMemory() - runtime.totalMemory() + runtime.freeMemory()
        <span class="hljs-keyword">val</span> size = <span class="hljs-keyword">if</span> (free &gt;= steps[<span class="hljs-number">0</span>]) steps[<span class="hljs-number">0</span>] <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (free &gt;= steps[<span class="hljs-number">1</span>]) steps[<span class="hljs-number">1</span>] <span class="hljs-keyword">else</span> steps[<span class="hljs-number">2</span>]
        pool += ByteArray(size = size.toInt())
        await()
        printMemoryUsages()
    &#125;
&#125;

<span class="hljs-comment">// 间隔 1s</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">await</span><span class="hljs-params">(time: <span class="hljs-type">Long</span> = <span class="hljs-number">1000</span>)</span></span> &#123;
    lock.lock()
    <span class="hljs-keyword">try</span> &#123;
        cond.await(time, TimeUnit.MILLISECONDS)
    &#125; <span class="hljs-keyword">finally</span> &#123;
        lock.unlock()
    &#125;
&#125;

<span class="hljs-comment">// 打印内存统计情况</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">printMemoryUsages</span><span class="hljs-params">()</span></span> &#123;
    <span class="hljs-keyword">val</span> runtime = Runtime.getRuntime()
    am.getMemoryInfo(memInfo)
    d(<span class="hljs-string">&quot;max:<span class="hljs-subst">$&#123;runtime.maxMemory&#125;</span> total:<span class="hljs-subst">$&#123;runtime.totalMemory&#125;</span> free:<span class="hljs-subst">$&#123;runtime.freeMemory&#125;</span> &quot;</span> +
            <span class="hljs-string">&quot;availMem:<span class="hljs-subst">$&#123;memInfo.availMemReadable&#125;</span> totalMem:<span class="hljs-subst">$&#123;memInfo.totalMemReadable&#125;</span> &quot;</span> +
            <span class="hljs-string">&quot;threshold:<span class="hljs-subst">$&#123;memInfo.thresholdReadable&#125;</span> lowMemory:<span class="hljs-subst">$&#123;memInfo.lowMemory&#125;</span> &quot;</span> +
            <span class="hljs-string">&quot;memoryClass:<span class="hljs-subst">$&#123;am.memoryClassReadable&#125;</span> largeMemoryClass:<span class="hljs-subst">$&#123;am.largeMemoryClassReadable&#125;</span>&quot;</span>)
&#125;</code></pre></div>

<p><img src="../../../../image/2021-04-16-looking-into-oom/oom_memory_log.png" srcset="/image/loading.gif" lazyload alt="oom_memory_log.png"></p>
<p><img src="../../../../image/2021-04-16-looking-into-oom/oom_memory.png" srcset="/image/loading.gif" lazyload alt="oom_memory.png"></p>
<h3 id="定位抛出-OOM-的位置"><a href="#定位抛出-OOM-的位置" class="headerlink" title="定位抛出 OOM 的位置"></a>定位抛出 OOM 的位置</h3><p>最终抛出 <code>OutOfMemoryError</code> 的代码 是 <code>Thread::ThrowOutOfMemoryError</code></p>
<div class="code-wrapper"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Thread::ThrowOutOfMemoryError</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* msg)</span> </span>&#123;
  <span class="hljs-built_in">LOG</span>(WARNING) &lt;&lt; <span class="hljs-string">&quot;Throwing OutOfMemoryError &quot;</span>
               &lt;&lt; <span class="hljs-string">&#x27;&quot;&#x27;</span> &lt;&lt; msg &lt;&lt; <span class="hljs-string">&#x27;&quot;&#x27;</span>
               &lt;&lt; <span class="hljs-string">&quot; (VmSize &quot;</span> &lt;&lt; <span class="hljs-built_in">GetProcessStatus</span>(<span class="hljs-string">&quot;VmSize&quot;</span>)
               &lt;&lt; (tls32_.throwing_OutOfMemoryError ? <span class="hljs-string">&quot;, recursive case)&quot;</span> : <span class="hljs-string">&quot;)&quot;</span>);
  <span class="hljs-keyword">if</span> (!tls32_.throwing_OutOfMemoryError) &#123;
    tls32_.throwing_OutOfMemoryError = <span class="hljs-literal">true</span>;
    <span class="hljs-built_in">ThrowNewException</span>(<span class="hljs-string">&quot;Ljava/lang/OutOfMemoryError;&quot;</span>, msg);
    tls32_.throwing_OutOfMemoryError = <span class="hljs-literal">false</span>;
  &#125; <span class="hljs-keyword">else</span> &#123;
    <span class="hljs-built_in">Dump</span>(<span class="hljs-built_in">LOG_STREAM</span>(WARNING));  <span class="hljs-comment">// The pre-allocated OOME has no stack, so help out and log one.</span>
    <span class="hljs-built_in">SetException</span>(Runtime::<span class="hljs-built_in">Current</span>()-&gt;<span class="hljs-built_in">GetPreAllocatedOutOfMemoryErrorWhenThrowingOOME</span>());
  &#125;
&#125;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Thread::ThrowNewException</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* exception_class_descriptor,</span></span>
<span class="hljs-params"><span class="hljs-function">                               <span class="hljs-type">const</span> <span class="hljs-type">char</span>* msg)</span> </span>&#123;
  <span class="hljs-comment">// Callers should either clear or call ThrowNewWrappedException.</span>
  <span class="hljs-built_in">AssertNoPendingExceptionForNewException</span>(msg);
  <span class="hljs-built_in">ThrowNewWrappedException</span>(exception_class_descriptor, msg);
&#125;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Thread::ThrowNewWrappedException</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* exception_class_descriptor,</span></span>
<span class="hljs-params"><span class="hljs-function">                                      <span class="hljs-type">const</span> <span class="hljs-type">char</span>* msg)</span> </span>&#123;
  <span class="hljs-comment">// ... 构造 Ljava/lang/OutOfMemoryError;</span>
&#125;</code></pre></div>

<p>而因为堆内存分配失败抛出 OOM 的代码在 <code>Heap::ThrowOutOfMemoryError</code>，其中异常信息为：</p>
<p><code>&quot;Failed to allocate a (x) byte allocation with (x) free bytes and (x) until OOM, target footprint (x), growth limit (x)&quot;</code></p>
<div class="code-wrapper"><pre><code class="hljs C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Heap::ThrowOutOfMemoryError</span><span class="hljs-params">(Thread* self, <span class="hljs-type">size_t</span> byte_count, AllocatorType allocator_type)</span> </span>&#123;
  <span class="hljs-comment">// If we&#x27;re in a stack overflow, do not create a new exception. It would require running the</span>
  <span class="hljs-comment">// constructor, which will of course still be in a stack overflow.</span>
  <span class="hljs-keyword">if</span> (self-&gt;<span class="hljs-built_in">IsHandlingStackOverflow</span>()) &#123;
    self-&gt;<span class="hljs-built_in">SetException</span>(
        Runtime::<span class="hljs-built_in">Current</span>()-&gt;<span class="hljs-built_in">GetPreAllocatedOutOfMemoryErrorWhenHandlingStackOverflow</span>());
    <span class="hljs-keyword">return</span>;
  &#125;

  std::ostringstream oss;
  <span class="hljs-type">size_t</span> total_bytes_free = <span class="hljs-built_in">GetFreeMemory</span>();
  oss &lt;&lt; <span class="hljs-string">&quot;Failed to allocate a &quot;</span> &lt;&lt; byte_count &lt;&lt; <span class="hljs-string">&quot; byte allocation with &quot;</span> &lt;&lt; total_bytes_free
      &lt;&lt; <span class="hljs-string">&quot; free bytes and &quot;</span> &lt;&lt; <span class="hljs-built_in">PrettySize</span>(<span class="hljs-built_in">GetFreeMemoryUntilOOME</span>()) &lt;&lt; <span class="hljs-string">&quot; until OOM,&quot;</span>
      &lt;&lt; <span class="hljs-string">&quot; target footprint &quot;</span> &lt;&lt; target_footprint_.<span class="hljs-built_in">load</span>(std::memory_order_relaxed)
      &lt;&lt; <span class="hljs-string">&quot;, growth limit &quot;</span>
      &lt;&lt; growth_limit_;
  <span class="hljs-comment">// If the allocation failed due to fragmentation, print out the largest continuous allocation.</span>
  <span class="hljs-keyword">if</span> (total_bytes_free &gt;= byte_count) &#123;
    space::AllocSpace* space = <span class="hljs-literal">nullptr</span>;
    <span class="hljs-keyword">if</span> (allocator_type == kAllocatorTypeNonMoving) &#123;
      space = non_moving_space_;
    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (allocator_type == kAllocatorTypeRosAlloc ||
               allocator_type == kAllocatorTypeDlMalloc) &#123;
      space = main_space_;
    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (allocator_type == kAllocatorTypeBumpPointer ||
               allocator_type == kAllocatorTypeTLAB) &#123;
      space = bump_pointer_space_;
    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (allocator_type == kAllocatorTypeRegion ||
               allocator_type == kAllocatorTypeRegionTLAB) &#123;
      space = region_space_;
    &#125;

    <span class="hljs-comment">// There is no fragmentation info to log for large-object space.</span>
    <span class="hljs-keyword">if</span> (allocator_type != kAllocatorTypeLOS) &#123;
      <span class="hljs-built_in">CHECK</span>(space != <span class="hljs-literal">nullptr</span>) &lt;&lt; <span class="hljs-string">&quot;allocator_type:&quot;</span> &lt;&lt; allocator_type
                              &lt;&lt; <span class="hljs-string">&quot; byte_count:&quot;</span> &lt;&lt; byte_count
                              &lt;&lt; <span class="hljs-string">&quot; total_bytes_free:&quot;</span> &lt;&lt; total_bytes_free;
      space-&gt;<span class="hljs-built_in">LogFragmentationAllocFailure</span>(oss, byte_count);
    &#125;
  &#125;
  self-&gt;<span class="hljs-built_in">ThrowOutOfMemoryError</span>(oss.<span class="hljs-built_in">str</span>().<span class="hljs-built_in">c_str</span>());
&#125;</code></pre></div>

<h2 id="创建线程时-Could-not-allocate-JNI-Env-导致的-OOM"><a href="#创建线程时-Could-not-allocate-JNI-Env-导致的-OOM" class="headerlink" title="创建线程时 Could not allocate JNI Env 导致的 OOM"></a>创建线程时 <code>Could not allocate JNI Env</code> 导致的 OOM</h2><h3 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h3><p>线程数量可以通过 <code>/proc/&#123;pid&#125;/status</code> 里 <code>Threads</code> 那行拿到</p>
<div class="code-wrapper"><pre><code class="hljs javascript"><span class="hljs-title class_">Name</span>:	m.<span class="hljs-property">myapplication</span>
<span class="hljs-title class_">State</span>:	R (running)
<span class="hljs-title class_">Tgid</span>:	<span class="hljs-number">26939</span>
<span class="hljs-title class_">Ngid</span>:	<span class="hljs-number">0</span>
<span class="hljs-title class_">Pid</span>:	<span class="hljs-number">26939</span>
<span class="hljs-title class_">PPid</span>:	<span class="hljs-number">1846</span>
<span class="hljs-title class_">TracerPid</span>:	<span class="hljs-number">0</span>
<span class="hljs-title class_">Uid</span>:	<span class="hljs-number">10100</span>	<span class="hljs-number">10100</span>	<span class="hljs-number">10100</span>	<span class="hljs-number">10100</span>
<span class="hljs-title class_">Gid</span>:	<span class="hljs-number">10100</span>	<span class="hljs-number">10100</span>	<span class="hljs-number">10100</span>	<span class="hljs-number">10100</span>
<span class="hljs-title class_">FDSize</span>:	<span class="hljs-number">64</span>
<span class="hljs-title class_">Groups</span>:	<span class="hljs-number">3003</span> <span class="hljs-number">9997</span> <span class="hljs-number">20100</span> <span class="hljs-number">50100</span> 
...
<span class="hljs-title class_">Threads</span>:	<span class="hljs-number">17</span>                  <span class="hljs-comment">// 线程数量</span>
...</code></pre></div>

<p>不断地创建新线程，新线程啥也不干就阻塞住，从而使 APP 进程的线程数量持续上涨，模拟 APP 随意创建线程/线程池而没有做统一的管理，导致创建大量线程的情况，最后抛出 <code>Could not allocate JNI Env: Failed anonymous mmap(0x0, 8192, 0x3, 0x2, 53, 0): Permission denied. See process maps in the log.</code></p>
<div class="code-wrapper"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MemoryKillerService</span> : <span class="hljs-type">IntentService</span></span>(<span class="hljs-string">&quot;MemoryKillerService&quot;</span>) &#123;
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onHandleIntent</span><span class="hljs-params">(intent: <span class="hljs-type">Intent</span>?)</span></span> &#123;
        <span class="hljs-comment">// 一个线程不断地创建测试线程（间隔 1ms）</span>
        thread &#123;
            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;
                <span class="hljs-keyword">val</span> thread = BlockingThread()
                thread.start()
                await(time = <span class="hljs-number">1</span>)
            &#125;
        &#125;

        <span class="hljs-comment">// 一个线程不断地打印线程数</span>
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;
            d(<span class="hljs-string">&quot;threadCount: <span class="hljs-subst">$&#123;getThreadCount()&#125;</span>&quot;</span>)
            await(time = <span class="hljs-number">100</span>)
        &#125;
    &#125;
&#125;

<span class="hljs-comment">// 测试线程啥也不干，就阻塞住</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BlockingThread</span>: <span class="hljs-type">Thread</span></span>() &#123;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> lock = ReentrantLock()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> cond = lock.newCondition()
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span> &#123;
        lock.lock()
        <span class="hljs-keyword">try</span> &#123;
            cond.await()
        &#125; <span class="hljs-keyword">finally</span> &#123;
            lock.unlock()
        &#125;
    &#125;
&#125;

<span class="hljs-comment">// 查询进程的线程数量</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getThreadCount</span><span class="hljs-params">()</span></span> = runCatching &#123;
    regexGroupInFile(pattern = <span class="hljs-string">&quot;.*Threads:\\s+(\\d+).*&quot;</span>, path = <span class="hljs-string">&quot;/proc/<span class="hljs-subst">$&#123;myPid()&#125;</span>/status&quot;</span>)?.toInt()
&#125;.getOrDefault(<span class="hljs-number">0</span>)</code></pre></div>

<div class="code-wrapper"><pre><code class="hljs javascript"><span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">58</span>:<span class="hljs-number">10.067</span> <span class="hljs-number">29743</span>-<span class="hljs-number">29769</span>/com.<span class="hljs-property">myapplication</span> D/<span class="hljs-attr">memkiller</span>: <span class="hljs-attr">threadCount</span>: <span class="hljs-number">1633</span>
<span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">58</span>:<span class="hljs-number">10.170</span> <span class="hljs-number">29743</span>-<span class="hljs-number">29769</span>/com.<span class="hljs-property">myapplication</span> D/<span class="hljs-attr">memkiller</span>: <span class="hljs-attr">threadCount</span>: <span class="hljs-number">1680</span>
<span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">58</span>:<span class="hljs-number">10.272</span> <span class="hljs-number">29743</span>-<span class="hljs-number">29769</span>/com.<span class="hljs-property">myapplication</span> D/<span class="hljs-attr">memkiller</span>: <span class="hljs-attr">threadCount</span>: <span class="hljs-number">1731</span>
<span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">58</span>:<span class="hljs-number">10.374</span> <span class="hljs-number">29743</span>-<span class="hljs-number">29769</span>/com.<span class="hljs-property">myapplication</span> D/<span class="hljs-attr">memkiller</span>: <span class="hljs-attr">threadCount</span>: <span class="hljs-number">1784</span>
<span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">58</span>:<span class="hljs-number">10.475</span> <span class="hljs-number">29743</span>-<span class="hljs-number">29769</span>/com.<span class="hljs-property">myapplication</span> D/<span class="hljs-attr">memkiller</span>: <span class="hljs-attr">threadCount</span>: <span class="hljs-number">1829</span>
<span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">58</span>:<span class="hljs-number">10.578</span> <span class="hljs-number">29743</span>-<span class="hljs-number">29769</span>/com.<span class="hljs-property">myapplication</span> D/<span class="hljs-attr">memkiller</span>: <span class="hljs-attr">threadCount</span>: <span class="hljs-number">1880</span>
<span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">58</span>:<span class="hljs-number">10.680</span> <span class="hljs-number">29743</span>-<span class="hljs-number">29769</span>/com.<span class="hljs-property">myapplication</span> D/<span class="hljs-attr">memkiller</span>: <span class="hljs-attr">threadCount</span>: <span class="hljs-number">1929</span>
<span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">58</span>:<span class="hljs-number">10.783</span> <span class="hljs-number">29743</span>-<span class="hljs-number">29769</span>/com.<span class="hljs-property">myapplication</span> D/<span class="hljs-attr">memkiller</span>: <span class="hljs-attr">threadCount</span>: <span class="hljs-number">1972</span>
<span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">58</span>:<span class="hljs-number">10.886</span> <span class="hljs-number">29743</span>-<span class="hljs-number">29769</span>/com.<span class="hljs-property">myapplication</span> D/<span class="hljs-attr">memkiller</span>: <span class="hljs-attr">threadCount</span>: <span class="hljs-number">2017</span>
<span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">58</span>:<span class="hljs-number">10.988</span> <span class="hljs-number">29743</span>-<span class="hljs-number">29769</span>/com.<span class="hljs-property">myapplication</span> D/<span class="hljs-attr">memkiller</span>: <span class="hljs-attr">threadCount</span>: <span class="hljs-number">2067</span>
<span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">58</span>:<span class="hljs-number">11.090</span> <span class="hljs-number">29743</span>-<span class="hljs-number">29769</span>/com.<span class="hljs-property">myapplication</span> D/<span class="hljs-attr">memkiller</span>: <span class="hljs-attr">threadCount</span>: <span class="hljs-number">2113</span>
<span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">58</span>:<span class="hljs-number">11.193</span> <span class="hljs-number">29743</span>-<span class="hljs-number">29769</span>/com.<span class="hljs-property">myapplication</span> D/<span class="hljs-attr">memkiller</span>: <span class="hljs-attr">threadCount</span>: <span class="hljs-number">2164</span>
<span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">58</span>:<span class="hljs-number">11.294</span> <span class="hljs-number">29743</span>-<span class="hljs-number">29769</span>/com.<span class="hljs-property">myapplication</span> D/<span class="hljs-attr">memkiller</span>: <span class="hljs-attr">threadCount</span>: <span class="hljs-number">2208</span>
<span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">58</span>:<span class="hljs-number">11.368</span> <span class="hljs-number">29743</span>-<span class="hljs-number">29771</span>/com.<span class="hljs-property">myapplication</span> W/m.<span class="hljs-property">myapplicatio</span>: <span class="hljs-title class_">Throwing</span> <span class="hljs-title class_">OutOfMemoryError</span> <span class="hljs-string">&quot;Could not allocate JNI Env: Failed anonymous mmap(0x0, 8192, 0x3, 0x2, 53, 0): Permission denied. See process maps in the log.&quot;</span>
    
    --------- beginning <span class="hljs-keyword">of</span> crash
<span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">58</span>:<span class="hljs-number">11.368</span> <span class="hljs-number">29743</span>-<span class="hljs-number">29771</span>/com.<span class="hljs-property">myapplication</span> E/<span class="hljs-title class_">AndroidRuntime</span>: <span class="hljs-variable constant_">FATAL</span> <span class="hljs-attr">EXCEPTION</span>: <span class="hljs-title class_">Thread</span>-<span class="hljs-number">2</span>
    <span class="hljs-title class_">Process</span>: com.<span class="hljs-property">myapplication</span>, <span class="hljs-attr">PID</span>: <span class="hljs-number">29743</span>
    java.<span class="hljs-property">lang</span>.<span class="hljs-property">OutOfMemoryError</span>: <span class="hljs-title class_">Could</span> not allocate <span class="hljs-variable constant_">JNI</span> <span class="hljs-title class_">Env</span>: <span class="hljs-title class_">Failed</span> anonymous <span class="hljs-title function_">mmap</span>(<span class="hljs-number">0x0</span>, <span class="hljs-number">8192</span>, <span class="hljs-number">0x3</span>, <span class="hljs-number">0x2</span>, <span class="hljs-number">53</span>, <span class="hljs-number">0</span>): <span class="hljs-title class_">Permission</span> denied. <span class="hljs-title class_">See</span> process maps <span class="hljs-keyword">in</span> the log.
        at java.<span class="hljs-property">lang</span>.<span class="hljs-property">Thread</span>.<span class="hljs-title function_">nativeCreate</span>(<span class="hljs-title class_">Native</span> <span class="hljs-title class_">Method</span>)
        at java.<span class="hljs-property">lang</span>.<span class="hljs-property">Thread</span>.<span class="hljs-title function_">start</span>(<span class="hljs-title class_">Thread</span>.<span class="hljs-property">java</span>:<span class="hljs-number">733</span>)
        at com.<span class="hljs-property">myapplication</span>.<span class="hljs-property">MemoryKillerService$onHandleIntent$1</span>.<span class="hljs-title function_">invoke</span>(<span class="hljs-title class_">MemoryKillerService</span>.<span class="hljs-property">kt</span>:<span class="hljs-number">35</span>)
        at com.<span class="hljs-property">myapplication</span>.<span class="hljs-property">MemoryKillerService$onHandleIntent$1</span>.<span class="hljs-title function_">invoke</span>(<span class="hljs-title class_">MemoryKillerService</span>.<span class="hljs-property">kt</span>:<span class="hljs-number">22</span>)
        at kotlin.<span class="hljs-property">concurrent</span>.<span class="hljs-property">ThreadsKt$thread$thread$1</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">Thread</span>.<span class="hljs-property">kt</span>:<span class="hljs-number">30</span>)</code></pre></div>

<h3 id="代码追踪"><a href="#代码追踪" class="headerlink" title="代码追踪"></a>代码追踪</h3><div class="code-wrapper"><pre><code class="hljs cpp">Thread.<span class="hljs-built_in">start</span>()
Thread.<span class="hljs-function">nativeCreate</span>
<span class="hljs-function">Thread_nativeCreate</span>
<span class="hljs-function"></span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Thread::CreateNativeThread</span><span class="hljs-params">(JNIEnv* env, jobject java_peer, <span class="hljs-type">size_t</span> stack_size, <span class="hljs-type">bool</span> is_daemon)</span> </span>&#123;
  <span class="hljs-comment">// ...</span>
  <span class="hljs-comment">// Try to allocate a JNIEnvExt for the thread. We do this here as we might be out of memory and</span>
  <span class="hljs-comment">// do not have a good way to report this on the child&#x27;s side.</span>
  std::string error_msg;
  <span class="hljs-function">std::unique_ptr&lt;JNIEnvExt&gt; <span class="hljs-title">child_jni_env_ext</span><span class="hljs-params">(</span></span>
<span class="hljs-params"><span class="hljs-function">      JNIEnvExt::Create(child_thread, Runtime::Current()-&gt;GetJavaVM(), &amp;error_msg))</span></span>;

  <span class="hljs-comment">// 成功创建 JNIEnvExt 后才会真正创建线程 pthread_create ...</span>

  <span class="hljs-comment">// 找到了错误信息 Could not allocate JNI Env，它是由 child_jni_env_ext.get() == nullptr 触发的</span>
  <span class="hljs-comment">// 也就是 JNIEnvExt::Create 返回 nullptr，JNIEnvExt 创建失败</span>
  &#123;
    <span class="hljs-function">std::string <span class="hljs-title">msg</span><span class="hljs-params">(child_jni_env_ext.get() == <span class="hljs-literal">nullptr</span> ?</span></span>
<span class="hljs-params"><span class="hljs-function">        StringPrintf(<span class="hljs-string">&quot;Could not allocate JNI Env: %s&quot;</span>, error_msg.c_str()) :</span></span>
<span class="hljs-params"><span class="hljs-function">        StringPrintf(<span class="hljs-string">&quot;pthread_create (%s stack) failed: %s&quot;</span>,</span></span>
<span class="hljs-params"><span class="hljs-function">                                 PrettySize(stack_size).c_str(), strerror(pthread_create_result)))</span></span>;
    <span class="hljs-function">ScopedObjectAccess <span class="hljs-title">soa</span><span class="hljs-params">(env)</span></span>;
    soa.<span class="hljs-built_in">Self</span>()-&gt;<span class="hljs-built_in">ThrowOutOfMemoryError</span>(msg.<span class="hljs-built_in">c_str</span>());
  &#125;
&#125;

<span class="hljs-comment">// 发现 JNIEnvExt.locals_.table_mem_map_.IsValid 返回 false 导致 JNIEnvExt 创建失败</span>
JNIEnvExt::Create
JNIEnvExt::CheckLocalsValid
IndirectReferenceTable::IsValid
MemMap.IsValid

<span class="hljs-comment">// locals_ 是在 JNIEnvExt 的构造函数里初始化的</span>
JNIEnvExt::<span class="hljs-built_in">JNIEnvExt</span>(Thread* self_in, JavaVMExt* vm_in, std::string* error_msg)
    : <span class="hljs-built_in">self_</span>(self_in),
      <span class="hljs-built_in">vm_</span>(vm_in),
      <span class="hljs-built_in">local_ref_cookie_</span>(kIRTFirstSegment),
      <span class="hljs-built_in">locals_</span>(kLocalsInitial, kLocal, IndirectReferenceTable::ResizableCapacity::kYes, error_msg),
      <span class="hljs-built_in">monitors_</span>(<span class="hljs-string">&quot;monitors&quot;</span>, kMonitorsInitial, kMonitorsMax),
      <span class="hljs-built_in">critical_</span>(<span class="hljs-number">0</span>),
      <span class="hljs-built_in">check_jni_</span>(<span class="hljs-literal">false</span>),
      <span class="hljs-built_in">runtime_deleted_</span>(<span class="hljs-literal">false</span>) &#123;
  <span class="hljs-function">MutexLock <span class="hljs-title">mu</span><span class="hljs-params">(Thread::Current(), *Locks::jni_function_table_lock_)</span></span>;
  check_jni_ = vm_in-&gt;<span class="hljs-built_in">IsCheckJniEnabled</span>();
  functions = <span class="hljs-built_in">GetFunctionTable</span>(check_jni_);
  unchecked_functions_ = <span class="hljs-built_in">GetJniNativeInterface</span>();
&#125;

<span class="hljs-comment">// table_mem_map_ 是由 MemMap::MapAnonymous 创建的</span>
IndirectReferenceTable::<span class="hljs-built_in">IndirectReferenceTable</span>(<span class="hljs-type">size_t</span> max_count,
                                               IndirectRefKind desired_kind,
                                               ResizableCapacity resizable,
                                               std::string* error_msg)
    : <span class="hljs-built_in">segment_state_</span>(kIRTFirstSegment),
      <span class="hljs-built_in">kind_</span>(desired_kind),
      <span class="hljs-built_in">max_entries_</span>(max_count),
      <span class="hljs-built_in">current_num_holes_</span>(<span class="hljs-number">0</span>),
      <span class="hljs-built_in">resizable_</span>(resizable) &#123;
  <span class="hljs-built_in">CHECK</span>(error_msg != <span class="hljs-literal">nullptr</span>);
  <span class="hljs-built_in">CHECK_NE</span>(desired_kind, kJniTransitionOrInvalid);

  <span class="hljs-comment">// Overflow and maximum check.</span>
  <span class="hljs-built_in">CHECK_LE</span>(max_count, kMaxTableSizeInBytes / <span class="hljs-built_in">sizeof</span>(IrtEntry));

  <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> table_bytes = <span class="hljs-built_in">RoundUp</span>(max_count * <span class="hljs-built_in">sizeof</span>(IrtEntry), kPageSize);
  table_mem_map_ = MemMap::<span class="hljs-built_in">MapAnonymous</span>(<span class="hljs-string">&quot;indirect ref table&quot;</span>,
                                        table_bytes,
                                        PROT_READ | PROT_WRITE,
                                        <span class="hljs-comment">/*low_4gb=*/</span> <span class="hljs-literal">false</span>,
                                        error_msg);
  <span class="hljs-keyword">if</span> (!table_mem_map_.<span class="hljs-built_in">IsValid</span>() &amp;&amp; error_msg-&gt;<span class="hljs-built_in">empty</span>()) &#123;
    *error_msg = <span class="hljs-string">&quot;Unable to map memory for indirect ref table&quot;</span>;
  &#125;

  <span class="hljs-keyword">if</span> (table_mem_map_.<span class="hljs-built_in">IsValid</span>()) &#123;
    table_ = <span class="hljs-built_in">reinterpret_cast</span>&lt;IrtEntry*&gt;(table_mem_map_.<span class="hljs-built_in">Begin</span>());
  &#125; <span class="hljs-keyword">else</span> &#123;
    table_ = <span class="hljs-literal">nullptr</span>;
  &#125;
  segment_state_ = kIRTFirstSegment;
  last_known_previous_state_ = kIRTFirstSegment;
  <span class="hljs-comment">// Take into account the actual length.</span>
  max_entries_ = table_bytes / <span class="hljs-built_in">sizeof</span>(IrtEntry);
&#125;

<span class="hljs-comment">// 找到错误信息 Failed anonymous mmap 的出处了</span>
<span class="hljs-function">MemMap <span class="hljs-title">MemMap::MapAnonymous</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* name,</span></span>
<span class="hljs-params"><span class="hljs-function">                            <span class="hljs-type">uint8_t</span>* addr,</span></span>
<span class="hljs-params"><span class="hljs-function">                            <span class="hljs-type">size_t</span> byte_count,</span></span>
<span class="hljs-params"><span class="hljs-function">                            <span class="hljs-type">int</span> prot,</span></span>
<span class="hljs-params"><span class="hljs-function">                            <span class="hljs-type">bool</span> low_4gb,</span></span>
<span class="hljs-params"><span class="hljs-function">                            <span class="hljs-type">bool</span> reuse,</span></span>
<span class="hljs-params"><span class="hljs-function">                            <span class="hljs-comment">/*inout*/</span>MemMap* reservation,</span></span>
<span class="hljs-params"><span class="hljs-function">                            <span class="hljs-comment">/*out*/</span>std::string* error_msg,</span></span>
<span class="hljs-params"><span class="hljs-function">                            <span class="hljs-type">bool</span> use_debug_name)</span> </span>&#123;
  <span class="hljs-comment">// ...</span>
  <span class="hljs-comment">// fd 没有指向任何有效文件，addr 也是 nullptr</span>
  <span class="hljs-comment">// 也就是说这里只是开辟了容量是 byte_count 的一段内存空间</span>
  <span class="hljs-type">void</span>* actual = <span class="hljs-built_in">MapInternal</span>(addr,
                             page_aligned_byte_count,
                             prot,
                             flags,
                             fd.<span class="hljs-built_in">get</span>(),
                             <span class="hljs-number">0</span>,
                             low_4gb);
  saved_errno = errno;

  <span class="hljs-keyword">if</span> (actual == MAP_FAILED) &#123;
    <span class="hljs-keyword">if</span> (error_msg != <span class="hljs-literal">nullptr</span>) &#123;
      <span class="hljs-keyword">if</span> (kIsDebugBuild || <span class="hljs-built_in">VLOG_IS_ON</span>(oat)) &#123;
        <span class="hljs-built_in">PrintFileToLog</span>(<span class="hljs-string">&quot;/proc/self/maps&quot;</span>, LogSeverity::WARNING);
      &#125;

      *error_msg = <span class="hljs-built_in">StringPrintf</span>(<span class="hljs-string">&quot;Failed anonymous mmap(%p, %zd, 0x%x, 0x%x, %d, 0): %s. &quot;</span>
                                    <span class="hljs-string">&quot;See process maps in the log.&quot;</span>,
                                addr,
                                page_aligned_byte_count,
                                prot,
                                flags,
                                fd.<span class="hljs-built_in">get</span>(),
                                <span class="hljs-built_in">strerror</span>(saved_errno));
    &#125;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Invalid</span>();
  &#125;
  <span class="hljs-comment">// ...</span>
&#125;

<span class="hljs-comment">// 看来是将 fd 映射进内存地址时失败了</span>
MemMap::MapInternal
MemMap::TargetMMap
mmap</code></pre></div>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>创建线程时，需要构造 <code>JNIEnvExt</code> 这么一个对象，而 <code>JNIEnvExt</code> 需要 <code>mmap</code> 一块大小为 <code>RoundUp(max_count * sizeof(IrtEntry), kPageSize)</code> 的内存地址（内存页面大小的整数倍，比如上面 logcat 里，8192 = 4096 * 2），当虚拟内存地址空间耗尽时抛出 OOM</p>
<ol>
<li><code>Could not allocate JNI Env</code> 不能为 <code>JNIEnvExt</code> 分配内存</li>
<li><code>Failed anonymous mmap(0x0, 8192, 0x3, 0x2, 53, 0)</code> 不能分配 8192 大小的内存地址</li>
<li><code>Permission denied. See process maps in the log.</code> 我用的模拟器，可能是说超出内存限制后不能用其他方式获得内存？</li>
</ol>
<h2 id="创建线程时-pthread-create-failed-导致的-OOM"><a href="#创建线程时-pthread-create-failed-导致的-OOM" class="headerlink" title="创建线程时 pthread_create failed 导致的 OOM"></a>创建线程时 <code>pthread_create failed</code> 导致的 OOM</h2><p>用上面的测试代码还会出现另外一种 OOM 如下</p>
<div class="code-wrapper"><pre><code class="hljs kotlin"><span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">37.488</span> <span class="hljs-number">27404</span>-<span class="hljs-number">27431</span>/com.myapplication D/memkiller: threadCount: <span class="hljs-number">1702</span>
<span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">37.590</span> <span class="hljs-number">27404</span>-<span class="hljs-number">27431</span>/com.myapplication D/memkiller: threadCount: <span class="hljs-number">1747</span>
<span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">37.692</span> <span class="hljs-number">27404</span>-<span class="hljs-number">27431</span>/com.myapplication D/memkiller: threadCount: <span class="hljs-number">1796</span>
<span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">37.794</span> <span class="hljs-number">27404</span>-<span class="hljs-number">27431</span>/com.myapplication D/memkiller: threadCount: <span class="hljs-number">1848</span>
<span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">37.898</span> <span class="hljs-number">27404</span>-<span class="hljs-number">27431</span>/com.myapplication D/memkiller: threadCount: <span class="hljs-number">1895</span>
<span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">38.000</span> <span class="hljs-number">27404</span>-<span class="hljs-number">27431</span>/com.myapplication D/memkiller: threadCount: <span class="hljs-number">1946</span>
<span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">38.103</span> <span class="hljs-number">27404</span>-<span class="hljs-number">27431</span>/com.myapplication D/memkiller: threadCount: <span class="hljs-number">1997</span>
<span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">38.205</span> <span class="hljs-number">27404</span>-<span class="hljs-number">27431</span>/com.myapplication D/memkiller: threadCount: <span class="hljs-number">2045</span>
<span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">38.307</span> <span class="hljs-number">27404</span>-<span class="hljs-number">27431</span>/com.myapplication D/memkiller: threadCount: <span class="hljs-number">2096</span>
<span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">38.410</span> <span class="hljs-number">27404</span>-<span class="hljs-number">27431</span>/com.myapplication D/memkiller: threadCount: <span class="hljs-number">2139</span>
<span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">38.513</span> <span class="hljs-number">27404</span>-<span class="hljs-number">27431</span>/com.myapplication D/memkiller: threadCount: <span class="hljs-number">2175</span>
<span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">38.615</span> <span class="hljs-number">27404</span>-<span class="hljs-number">27431</span>/com.myapplication D/memkiller: threadCount: <span class="hljs-number">2220</span>
<span class="hljs-number">2021</span>-<span class="hljs-number">04</span>-<span class="hljs-number">20</span> <span class="hljs-number">13</span>:<span class="hljs-number">55</span>:<span class="hljs-number">38.663</span> <span class="hljs-number">27404</span>-<span class="hljs-number">27433</span>/com.myapplication W/libc: pthread_create failed: couldn<span class="hljs-string">&#x27;t allocate TLS: Permission denied</span>
<span class="hljs-string">2021-04-20 13:55:38.663 27404-27433/com.myapplication W/m.myapplicatio: Throwing OutOfMemoryError &quot;pthread_create (1040KB stack) failed: Try again&quot;</span>
<span class="hljs-string">    </span>
<span class="hljs-string">    --------- beginning of crash</span>
<span class="hljs-string">2021-04-20 13:55:38.664 27404-27433/com.myapplication E/AndroidRuntime: FATAL EXCEPTION: Thread-2</span>
<span class="hljs-string">    Process: com.myapplication, PID: 27404</span>
<span class="hljs-string">    java.lang.OutOfMemoryError: pthread_create (1040KB stack) failed: Try again</span>
<span class="hljs-string">        at java.lang.Thread.nativeCreate(Native Method)</span>
<span class="hljs-string">        at java.lang.Thread.start(Thread.java:733)</span>
<span class="hljs-string">        at com.myapplication.MemoryKillerService$onHandleIntent$1.invoke(MemoryKillerService.kt:35)</span>
<span class="hljs-string">        at com.myapplication.MemoryKillerService$onHandleIntent$1.invoke(MemoryKillerService.kt:22)</span>
<span class="hljs-string">        at kotlin.concurrent.ThreadsKt$thread$thread$1.run(Thread.kt:30)</span></code></pre></div>

<p>创建线程最终会执行系统调用 <code>pthread_create</code>，如果失败会抛出 <code>pthread_create (1040KB stack) failed</code>，1040KB 是线程的栈大小</p>
<p>上面 <code>pthread_create failed: couldn&#39;t allocate TLS: Permission denied</code> 表示为线程分配 Thread Local（TLS，THREAD LOCAL STORAGE）相关的内存时因为内存不足失败了</p>
<div class="code-wrapper"><pre><code class="hljs cpp">Thread.<span class="hljs-built_in">start</span>()
Thread.<span class="hljs-function">nativeCreate</span>
<span class="hljs-function">Thread_nativeCreate</span>
<span class="hljs-function"></span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Thread::CreateNativeThread</span><span class="hljs-params">(JNIEnv* env, jobject java_peer, <span class="hljs-type">size_t</span> stack_size, <span class="hljs-type">bool</span> is_daemon)</span> </span>&#123;
  <span class="hljs-comment">// ...</span>
  <span class="hljs-comment">// 不同于上面的情况，此时已为 JNIEnvExt 分配内存，但在执行 pthread_create 时出错了</span>
  <span class="hljs-type">int</span> pthread_create_result = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">if</span> (child_jni_env_ext.<span class="hljs-built_in">get</span>() != <span class="hljs-literal">nullptr</span>) &#123;
    <span class="hljs-type">pthread_t</span> new_pthread;
    <span class="hljs-type">pthread_attr_t</span> attr;
    child_thread-&gt;tlsPtr_.tmp_jni_env = child_jni_env_ext.<span class="hljs-built_in">get</span>();
    <span class="hljs-built_in">CHECK_PTHREAD_CALL</span>(pthread_attr_init, (&amp;attr), <span class="hljs-string">&quot;new thread&quot;</span>);
    <span class="hljs-built_in">CHECK_PTHREAD_CALL</span>(pthread_attr_setdetachstate, (&amp;attr, PTHREAD_CREATE_DETACHED),
                       <span class="hljs-string">&quot;PTHREAD_CREATE_DETACHED&quot;</span>);
    <span class="hljs-built_in">CHECK_PTHREAD_CALL</span>(pthread_attr_setstacksize, (&amp;attr, stack_size), stack_size);
    pthread_create_result = <span class="hljs-built_in">pthread_create</span>(&amp;new_pthread,
                                           &amp;attr,
                                           Thread::CreateCallback,
                                           child_thread);
    <span class="hljs-built_in">CHECK_PTHREAD_CALL</span>(pthread_attr_destroy, (&amp;attr), <span class="hljs-string">&quot;new thread&quot;</span>);

    <span class="hljs-keyword">if</span> (pthread_create_result == <span class="hljs-number">0</span>) &#123;
      <span class="hljs-comment">// pthread_create started the new thread. The child is now responsible for managing the</span>
      <span class="hljs-comment">// JNIEnvExt we created.</span>
      <span class="hljs-comment">// Note: we can&#x27;t check for tmp_jni_env == nullptr, as that would require synchronization</span>
      <span class="hljs-comment">//       between the threads.</span>
      child_jni_env_ext.<span class="hljs-built_in">release</span>();  <span class="hljs-comment">// NOLINT pthreads API.</span>
      <span class="hljs-keyword">return</span>;
    &#125;
  &#125;

  <span class="hljs-comment">// pthread_create 成功会在上面返回，跑到这里是因为其执行失败了</span>
  &#123;
    <span class="hljs-function">std::string <span class="hljs-title">msg</span><span class="hljs-params">(child_jni_env_ext.get() == <span class="hljs-literal">nullptr</span> ?</span></span>
<span class="hljs-params"><span class="hljs-function">        StringPrintf(<span class="hljs-string">&quot;Could not allocate JNI Env: %s&quot;</span>, error_msg.c_str()) :</span></span>
<span class="hljs-params"><span class="hljs-function">        StringPrintf(<span class="hljs-string">&quot;pthread_create (%s stack) failed: %s&quot;</span>,</span></span>
<span class="hljs-params"><span class="hljs-function">                                 PrettySize(stack_size).c_str(), strerror(pthread_create_result)))</span></span>;
    <span class="hljs-function">ScopedObjectAccess <span class="hljs-title">soa</span><span class="hljs-params">(env)</span></span>;
    soa.<span class="hljs-built_in">Self</span>()-&gt;<span class="hljs-built_in">ThrowOutOfMemoryError</span>(msg.<span class="hljs-built_in">c_str</span>());
  &#125;
&#125;</code></pre></div>

<h3 id="更多的例子"><a href="#更多的例子" class="headerlink" title="更多的例子"></a>更多的例子</h3><p>线程数超出了限制</p>
<div class="code-wrapper"><pre><code class="hljs kotlin">W/libc: pthread_create failed: clone failed: Out of memory
W/art: Throwing OutOfMemoryError <span class="hljs-string">&quot;pthread_create (1040KB stack) failed: Out of memory&quot;</span></code></pre></div>

<p>内存不足</p>
<div class="code-wrapper"><pre><code class="hljs kotlin">W/libc: pthread_create failed: couldn<span class="hljs-string">&#x27;t allocate 1073152-bytes mapped space: Out of memory</span>
<span class="hljs-string">W/art: Throwing OutOfMemoryError with VmSize  4191668 kB &quot;pthread_create (1040KB stack) failed: Try again&quot;</span></code></pre></div>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a target="_blank" rel="noopener" href="https://tech.meituan.com/2019/11/14/crash-oom-probe-practice.html">Probe：Android线上OOM问题定位组件</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/e574f0ffdb42">不可思议的OOM</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/CharonChui/AndroidNote/blob/master/AdavancedPart/OOM%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90.md">OOM问题分析</a></li>
</ol>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/OOM/">#OOM</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/04/23/matrix-resourcescanary/" title="Matrix - ResourcesCanary 浅析">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Matrix - ResourcesCanary 浅析</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/04/15/tailrec/" title="尾递归及尾递归优化">
                        <span class="hidden-mobile">尾递归及尾递归优化</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
